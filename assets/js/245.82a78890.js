(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{2224:function(s,n,a){"use strict";a.r(n);var t=a(9),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"一-database-sql包结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-database-sql包结构"}},[s._v("#")]),s._v(" 一：database/sql包结构")]),s._v(" "),t("h3",{attrs:{id:"一-概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-概念"}},[s._v("#")]),s._v(" (一)：概念")]),s._v(" "),t("ul",[t("li",[t("p",[t("strong",[s._v("database/sql包的设计，很好的体现了在Golang中，各功能都是面向接口设计和开发的")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("database/sql包下的代码")]),s._v("提供了用户操作数据库的通用方法(CRUD操作)")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("database/sql/driver包下")]),s._v("，定义了驱动数据库连接的所有接口，因此还需要导入一个第三方的数据库驱动，这个驱动实现了database/sql/driver包下接口的所有方法")])])]),s._v(" "),t("h3",{attrs:{id:"二-连接数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-连接数据库"}},[s._v("#")]),s._v(" (二)：连接数据库")]),s._v(" "),t("ul",[t("li",[s._v("这里使用"),t("code",[s._v("database/sql")]),s._v("包和"),t("code",[s._v("github.com/go-sql-driver/mysql")]),s._v("第三方驱动实现对数据库进行连接")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import (\n\t"database/sql"\n\n\t_ "github.com/go-sql-driver/mysql"\n)\n\nfunc main() {\n\t// DSN:Data Source Name\n\tdsn := "user:password@tcp(127.0.0.1:3306)/dbname"\n\tdb, err := sql.Open("mysql", dsn)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tdefer db.Close() // 注意这行代码要写在上面err判断的下面，因为如果sql.Open抛出异常，那么db就是nil，nil调用Close()方法就会出现空指针异常\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("ul",[t("li",[s._v("sql.DB是连接数据库的连接对象，一般使用一个全局变量保存；sql.DB保存了连接数据库相关的所有信息；"),t("code",[s._v("它内部维护着一个具有零到多个底层连接的连接池，可以安全地被多个goroutine同时使用")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import (\n\t"database/sql"\n\t"fmt"\n\n\t_ "github.com/go-sql-driver/mysql"\n)\n\n// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "user:password@tcp(127.0.0.1:3306)/db1?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\t// defer db.Close() 这里不能关闭数据库了\n\n\tdb.SetMaxOpenConns(1000) // 设置最大连接数\n\tdb.SetMaxIdleConns(100)  // 设置最小空闲数\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\treturn nil\n\t\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br")])]),t("h2",{attrs:{id:"二-crud操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-crud操作"}},[s._v("#")]),s._v(" 二：CRUD操作")]),s._v(" "),t("h3",{attrs:{id:"一-建库建表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-建库建表"}},[s._v("#")]),s._v(" (一)：建库建表")]),s._v(" "),t("ul",[t("li",[s._v("在Golang中，一般数据库和数据表是先在MySQL数据库中，使用命令行创建好的")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("CREATE TABLE `user` (\n    `id` BIGINT(20) NOT NULL AUTO_INCREMENT,\n    `name` VARCHAR(20) DEFAULT '',\n    `age` INT(11) DEFAULT '0',\n    PRIMARY KEY(`id`)\n)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"二-查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-查询"}},[s._v("#")]),s._v(" (二)：查询")]),s._v(" "),t("ul",[t("li",[s._v("先定义一个结构体，将查询的数据需要映射到结构体中")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("type user struct {\n\tid   int\n\tage  int\n\tname string\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("查询一行数据")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\nfunc queryRowDemo() {\n\tsqlStr := "select id, name, age from user where id=?"\n\n\tvar u user\n\n\t// 非常重要：确保QueryRow之后调用Scan方法，否则持有的数据库链接不会被释放\n\terr := db.QueryRow(sqlStr, 1).Scan(&u.id, &u.name, &u.age)\n\tif err != nil {\n\t\tfmt.Printf("scan failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tfmt.Printf("id:%d name:%s age:%d\\n", u.id, u.name, u.age)\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 单条数据查询\n\tqueryRowDemo()\n\n}\n\n\n// 输出结果\nid:1 name:robby age:30\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("查询多行数据")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\nfunc queryMultiRowDemo() {\n\n\tsqlStr := "select id, name, age from user where id > ?"\n\trows, err := db.Query(sqlStr, 0)\n\tif err != nil {\n\t\tfmt.Printf("query failed, err:%v\\n", err)\n\t\treturn\n\t}\n\t// 非常重要：关闭rows释放持有的数据库链接\n\tdefer rows.Close()\n\n\t// 循环读取结果集中的数据\n\tfor rows.Next() {\n\t\tvar u user\n\t\terr := rows.Scan(&u.id, &u.name, &u.age)\n\t\tif err != nil {\n\t\t\tfmt.Printf("scan failed, err:%v\\n", err)\n\t\t\treturn\n\t\t}\n\t\tfmt.Printf("id:%d name:%s age:%d\\n", u.id, u.name, u.age)\n\t}\n\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 查询多条数据示例\n\tqueryMultiRowDemo()\n\n}\n\n// 输出结果\nid:1 name:robby age:30\nid:2 name:petter age:31\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br")])]),t("h3",{attrs:{id:"三-插入数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-插入数据"}},[s._v("#")]),s._v(" (三)：插入数据")]),s._v(" "),t("ul",[t("li",[s._v("插入数据")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\n// 插入数据\nfunc insertRowDemo() {\n\tsqlStr := "insert into user(name, age) values (?,?)"\n\tret, err := db.Exec(sqlStr, "Marry", 30)\n\n\tif err != nil {\n\t\tfmt.Printf("insert failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n\ttheID, err := ret.LastInsertId() // 新插入数据的id\n\tif err != nil {\n\t\tfmt.Printf("get lastinsert ID failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n\tfmt.Printf("insert success, the id is %d.\\n", theID)\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 插入数据\n\tinsertRowDemo()\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br")])]),t("h3",{attrs:{id:"四-更新数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-更新数据"}},[s._v("#")]),s._v(" (四)：更新数据")]),s._v(" "),t("ul",[t("li",[s._v("更新数据")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\n// 更新数据\nfunc updateRowDemo() {\n\tsqlStr := "update user set age=? where id = ?"\n\tret, err := db.Exec(sqlStr, 31, 3)\n\tif err != nil {\n\t\tfmt.Printf("update failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tn, err := ret.RowsAffected() // 操作影响的行数\n\tif err != nil {\n\t\tfmt.Printf("get RowsAffected failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tfmt.Printf("update success, affected rows:%d\\n", n)\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 插入数据\n\tupdateRowDemo()\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br")])]),t("h3",{attrs:{id:"五-删除数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五-删除数据"}},[s._v("#")]),s._v(" (五)：删除数据")]),s._v(" "),t("ul",[t("li",[s._v("删除数据")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('var db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\n// 删除数据\nfunc deleteRowDemo() {\n\tsqlStr := "delete from user where id = ?"\n\tret, err := db.Exec(sqlStr, 3)\n\tif err != nil {\n\t\tfmt.Printf("delete failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tn, err := ret.RowsAffected() // 操作影响的行数\n\tif err != nil {\n\t\tfmt.Printf("get RowsAffected failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tfmt.Printf("delete success, affected rows:%d\\n", n)\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 删除数据\n\tdeleteRowDemo()\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br")])]),t("h2",{attrs:{id:"三-sql预处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-sql预处理"}},[s._v("#")]),s._v(" 三：SQL预处理")]),s._v(" "),t("h3",{attrs:{id:"一-什么是预处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-什么是预处理"}},[s._v("#")]),s._v(" (一)：什么是预处理")]),s._v(" "),t("ul",[t("li",[s._v("普通SQL语句执行过程")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：客户端对SQL语句进行占位符替换得到完整的SQL语句\n\n2：客户端发送完整SQL语句到MySQL服务端\n\n3：MySQL服务端执行完整的SQL语句并将结果返回给客户端\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("ul",[t("li",[s._v("预处理执行过程")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：把SQL语句分成两部分，命令部分与数据部分\n\n2：先把命令部分发送给MySQL服务端，MySQL服务端进行SQL预处理\n\n3：然后把数据部分发送给MySQL服务端，MySQL服务端对SQL语句进行占位符替换\n\n4：MySQL服务端执行完整的SQL语句并将结果返回给客户端\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ul",[t("li",[s._v("为什么要预处理")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：优化MySQL服务器重复执行SQL的方法，可以提升服务器性能，提前让服务器编译，一次编译多次执行，节省后续编译的成本\n\n2：避免SQL注入问题\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"二-go实现mysql预处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-go实现mysql预处理"}},[s._v("#")]),s._v(" (二)：Go实现MySQL预处理")]),s._v(" "),t("ul",[t("li",[s._v("database/sql中使用下面的Prepare方法来实现预处理操作")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("func (db *DB) Prepare(query string) (*Stmt, error)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("Prepare方法会先将sql语句发送给MySQL服务端，返回一个准备好的状态用于之后的查询和命令，返回值可以同时执行多个查询和命令")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 定义一个全局对象db\nvar db *sql.DB\n\n// 定义一个初始化数据库的函数\nfunc initDB() (err error) {\n\n\tdsn := "root:yhy3426356@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&parseTime=True"\n\n\tdb, err = sql.Open("mysql", dsn)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\tdb.SetMaxOpenConns(1000)\n\tdb.SetMaxIdleConns(100)\n\n\t// 尝试与数据库建立连接（校验dsn是否正确）\n\terr = db.Ping()\n\tif err != nil {\n\t\treturn err\n\t}\n\n\treturn nil\n}\n\ntype user struct {\n\tid   int\n\tage  int\n\tname string\n}\n\n// 预处理查询示例\nfunc prepareQueryDemo() {\n\tsqlStr := "select id, name, age from user where id > ?"\n\n\t// 先执行sql预处理\n\tstmt, err := db.Prepare(sqlStr)\n\tif err != nil {\n\t\tfmt.Printf("prepare failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tdefer stmt.Close()\n\n\t// 预处理完毕后，在执行查询操作\n\trows, err := stmt.Query(0)\n\tif err != nil {\n\t\tfmt.Printf("query failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tdefer rows.Close()\n\t// 循环读取结果集中的数据\n\tfor rows.Next() {\n\t\tvar u user\n\t\terr := rows.Scan(&u.id, &u.name, &u.age)\n\t\tif err != nil {\n\t\t\tfmt.Printf("scan failed, err:%v\\n", err)\n\t\t\treturn\n\t\t}\n\t\tfmt.Printf("id:%d name:%s age:%d\\n", u.id, u.name, u.age)\n\t}\n}\n\nfunc main() {\n\terr := initDB() // 调用输出化数据库的函数\n\tif err != nil {\n\t\tfmt.Printf("init db failed,err:%v\\n", err)\n\t\treturn\n\t}\n\n\t// 预处理查询示例\n\tprepareQueryDemo()\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br")])]),t("ul",[t("li",[s._v("插入、更新和删除操作的预处理十分类似，这里以"),t("code",[s._v("插入操作的预处理为例")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('func prepareInsertDemo() {\n\tsqlStr := "insert into user(name, age) values (?,?)"\n\tstmt, err := db.Prepare(sqlStr)\n\tif err != nil {\n\t\tfmt.Printf("prepare failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tdefer stmt.Close()\n\t// 注意，这里stmt调用的是Exec方法\n\t_, err = stmt.Exec("小王子", 18)\n\tif err != nil {\n\t\tfmt.Printf("insert failed, err:%v\\n", err)\n\t\treturn\n\t}\n\t_, err = stmt.Exec("沙河娜扎", 18)\n\tif err != nil {\n\t\tfmt.Printf("insert failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tfmt.Println("insert success.")\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("h3",{attrs:{id:"三-sql注入问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-sql注入问题"}},[s._v("#")]),s._v(" (三)：SQL注入问题")]),s._v(" "),t("ul",[t("li",[s._v("我们任何时候都不应该自己拼接SQL语句字符串，必须使用参数传递数据。下面这种拼接SQL语句的做法容易造成SQL注入")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('func sqlInjectDemo(name string) {\n\t// 不能这样拼接SQL，必须使用参数传递\n\tsqlStr := fmt.Sprintf("select id, name, age from user where name=\'%s\'", name)\n\tfmt.Printf("SQL:%s\\n", sqlStr)\n\tvar u user\n\terr := db.QueryRow(sqlStr).Scan(&u.id, &u.name, &u.age)\n\tif err != nil {\n\t\tfmt.Printf("exec failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tfmt.Printf("user:%#v\\n", u)\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h2",{attrs:{id:"四-golang实现mysql事务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-golang实现mysql事务"}},[s._v("#")]),s._v(" 四：Golang实现MySQL事务")]),s._v(" "),t("h3",{attrs:{id:"一-什么是事务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-什么是事务"}},[s._v("#")]),s._v(" (一)：什么是事务？")]),s._v(" "),t("ul",[t("li",[s._v("事务：一个最小的不可再分的工作单元；通常一个事务对应一个完整的业务(例如银行账户转账业务，该业务就是一个最小的工作单元)，同时这个完整的业务需要执行多次的DML(insert、update、delete)语句共同联合完成。A转账给B，这里面就需要执行两次update操作。在MySQL中只有使用了Innodb数据库引擎的数据库或表才支持事务。事务处理可以用来维护数据库的完整性，保证成批的SQL语句要么全部执行，要么全部不执行。")])]),s._v(" "),t("h3",{attrs:{id:"二-事务的acid"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-事务的acid"}},[s._v("#")]),s._v(" (二)：事务的ACID")]),s._v(" "),t("ul",[t("li",[s._v("通常事务必须满足4个条件（ACID）：原子性（Atomicity，或称不可分割性）、一致性（Consistency）、隔离性（Isolation，又称独立性）、持久性（Durability）")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：原子性：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样\n\n2：一致性：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作\n\n3：隔离性：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read，这是MySQL的默认级别）和串行化（Serializable）\n\n4：持久性：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("ul",[t("li",[s._v("在开发过程中，我们是不需要去关心高并发下对数据库上锁的，例如读锁和写锁，INNODB默认支持表的行级锁，只要按照业务需求，设置好了数据库的隔离级别，数据库会根据SQL语，自动选择合适的锁实现对应的隔离级别。下面是MySQL数据库的隔离级别从低到高对数据的影响")])]),s._v(" "),t("p",[t("img",{attrs:{src:a(749),alt:"Alt text"}})]),s._v(" "),t("ul",[t("li",[s._v("因此得到的结论是："),t("code",[s._v("数据库事务的隔离级别和数据库并发性是成反比的，隔离级别越高，并发性越低")])])]),s._v(" "),t("h3",{attrs:{id:"三-事务的相关方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-事务的相关方法"}},[s._v("#")]),s._v(" (三)：事务的相关方法")]),s._v(" "),t("ul",[t("li",[s._v("Go语言中使用"),t("code",[s._v("以下三个方法实现MySQL中的事务操作")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：开始事务：\nfunc (db *DB) Begin() (*Tx, error)\n\n2：提交事务\nfunc (tx *Tx) Commit() error\n\n3：回滚事务\nfunc (tx *Tx) Rollback() error\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[s._v("下面代码中演示了一个简单的事务操作，在事务操作"),t("code",[s._v("能够确保两次更新操作要么同时成功要么同时失败，不会存在中间状态")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('// 事务操作示例\nfunc transactionDemo() {\n\ttx, err := db.Begin() // 开启事务\n\tif err != nil {\n\t\tif tx != nil {\n\t\t\ttx.Rollback() // 回滚\n\t\t}\n\t\tfmt.Printf("begin trans failed, err:%v\\n", err)\n\t\treturn\n\t}\n\tsqlStr1 := "Update user set age=30 where id=?"\n\tret1, err := tx.Exec(sqlStr1, 2)\n\tif err != nil {\n\t\ttx.Rollback() // 回滚\n\t\tfmt.Printf("exec sql1 failed, err:%v\\n", err)\n\t\treturn\n\t}\n\taffRow1, err := ret1.RowsAffected()\n\tif err != nil {\n\t\ttx.Rollback() // 回滚\n\t\tfmt.Printf("exec ret1.RowsAffected() failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n\tsqlStr2 := "Update user set age=40 where id=?"\n\tret2, err := tx.Exec(sqlStr2, 3)\n\tif err != nil {\n\t\ttx.Rollback() // 回滚\n\t\tfmt.Printf("exec sql2 failed, err:%v\\n", err)\n\t\treturn\n\t}\n\taffRow2, err := ret2.RowsAffected()\n\tif err != nil {\n\t\ttx.Rollback() // 回滚\n\t\tfmt.Printf("exec ret1.RowsAffected() failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n\tfmt.Println(affRow1, affRow2)\n\tif affRow1 == 1 && affRow2 == 1 {\n\t\tfmt.Println("事务提交啦...")\n\t\ttx.Commit()   // 提交事务\n\t} else {\n\t\ttx.Rollback() // 回滚\n\t\tfmt.Println("事务回滚啦...")\n\t}\n\n\tfmt.Println("exec trans success!")\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br")])]),t("ul",[t("li",[s._v("小结")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t其实单机版本的MySQL事务是很好解决的，比较难解决的是分布式事务，例如多个数据库中，完成事务就比较复杂，可能需要用到消息中间件来完成\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);n.default=e.exports},749:function(s,n,a){s.exports=a.p+"assets/img/go-sql.8cfba461.png"}}]);