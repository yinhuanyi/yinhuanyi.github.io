(window.webpackJsonp=window.webpackJsonp||[]).push([[180],{2238:function(n,s,t){"use strict";t.r(s);var a=t(9),e=Object(a.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h2",{attrs:{id:"一-goland项目新建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-goland项目新建"}},[n._v("#")]),n._v(" 一：Goland项目新建")]),n._v(" "),a("h3",{attrs:{id:"一-在goland-ide中使用go-module新建项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-在goland-ide中使用go-module新建项目"}},[n._v("#")]),n._v(" (一) 在Goland IDE中使用go module新建项目")]),n._v(" "),a("ul",[a("li",[n._v("下载goimports")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("go get golang.org/x/tools/cmd/goimports\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("在IDE中选择go fmt和goimports，当粘贴携带第三方包的代码，可以导入对应的库")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(760),alt:"Alt text"}})]),n._v(" "),a("h3",{attrs:{id:"二-最终代码结构如下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-最终代码结构如下"}},[n._v("#")]),n._v(" (二) 最终代码结构如下")]),n._v(" "),a("ul",[a("li",[n._v("结构")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(761),alt:"Alt text"}})]),n._v(" "),a("ul",[a("li",[n._v("项目文件结构")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v(".\n├── config.yaml\n├── controllers\n├── dao\n│   ├── mysql\n│   │   └── mysql.go // 主要是对MySQL连接进行配置\n│   └── redis\n│       └── redis.go // 主要是对redis连接进行配置\n├── go.mod\n├── go.sum\n├── logger\n│   └── logger.go   // 主要是对日志进行配置\n├── logic\n├── main.go\n├── models\n├── pkg\n├── routes\n│   └── routes.go    // 主要负责对请求路由进行配置\n├── settings\n│   └── settings.go  // 主要负责加载配置文件\n└── web-app.log\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br")])]),a("h2",{attrs:{id:"二-对于main-go文件的基本规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-对于main-go文件的基本规划"}},[n._v("#")]),n._v(" 二：对于main.go文件的基本规划")]),n._v(" "),a("h3",{attrs:{id:"一-获取命令行参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-获取命令行参数"}},[n._v("#")]),n._v(" (一) 获取命令行参数")]),n._v(" "),a("ul",[a("li",[n._v("可以选择使用os.Args获取命令的参数，也可以使用flag包获取命令行参数，"),a("code",[n._v("参数传递的是配置文件的路径，一般是在项目下的config.yaml")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('if len(os.Args) < 2 {\n    fmt.Printf("运行一下 ./jiaoshoujia config.yaml")\n    return\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("h3",{attrs:{id:"二-加载配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-加载配置"}},[n._v("#")]),n._v(" (二) 加载配置")]),n._v(" "),a("ul",[a("li",[n._v("配置文件的加载使用"),a("code",[n._v("viper库")]),n._v("，先解析配置文件的地址，然后将配置信息映射到结构体，使用viper.Unmarshal(Conf)映射viper的配置到Conf结构体中")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 1：加载配置, 这里的os.Args[1] 就是传递的配置文件路径\nif err := settings.Init(os.Args[1]); err != nil {\n    fmt.Printf("配置文件读取失败：%v", err)\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("ul",[a("li",[n._v("在settings.go中，加载配置文件的内容，将配置文件内容反序列化到Conf变量指向的AppConfig结构体中")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 这里是用来保存所有程序的配置信息, 这里使用new函数，相当于 var Conf &AppConfig\nvar Conf = new(AppConfig)\n\n// 由于viper使用的是mapstructure来解析配置文件，因此，这里的结构体tag使用mapstructure\ntype LogConfig struct {\n    Level      string `mapstructure:"level"`\n    Filename   string `mapstructure:"filename"`\n    MaxSize    int    `mapstructure:"max_size"`\n    MaxAge     int    `mapstructure:"max_age"`\n    MaxBackups int    `mapstructure:"max_backups"`\n}\n\ntype MysqlConfig struct {\n    Host         string `mapstructure:"host"`\n    User         string `mapstructure:"user"`\n    Password     string `mapstructure:"password"`\n    DbName       string `mapstructure:"dbname"`\n    Port         int    `mapstructure:"port"`\n    MaxOpenConns int    `mapstructure:"max_open_connection"`\n    MaxIdleConns int    `mapstructure:"max_idle_connection"`\n}\n\ntype RedisConfig struct {\n    Host     string `mapstructure:"host"`\n    Password string `mapstructure:"password"`\n    Port     int    `mapstructure:"port"`\n    Db       int    `mapstructure:"dbname"`\n    PoolSize int    `mapstructure:"port"`\n}\n\n// 第一层结构体\ntype AppConfig struct {\n    Name    string `mapstructure:"name"`\n    Mode    string `mapstructure:"mode"`\n    Version string `mapstructure:"version"`\n    Port    string `mapstructure:"port"`\n\n    // 这里是三个匿名字段，访问这个字段就是类型的名字\n    *LogConfig   `mapstructure:"log"`\n    *MysqlConfig `mapstructure:"mysql"`\n    *RedisConfig `mapstructure:"redis"`\n}\n\nfunc Init(filePath string) (err error) {\n    // 这个filename从命令行传递进来\n    viper.SetConfigFile(filePath) // 这里就是直接指定了文件，所有用它比较靠谱\n    //viper.SetConfigName("config")\n    //viper.SetConfigType("yaml") // 这个只是在远程获取配置文件有用，其他情况下没有用, 如果本地有config.json和config.yaml，那么就会报错\n    //viper.AddConfigPath(".")\n    if err = viper.ReadInConfig(); err != nil {\n        fmt.Printf("配置文件读取失败: %v\\n", err)\n        return\n    }\n    // 将viper的配置信息，映射到Conf这个结构体中, 这是一个反序列化的过程\n    if err := viper.Unmarshal(Conf); err != nil {\n        fmt.Printf("配置文件映射到结构体失败")\n    }\n\n    viper.WatchConfig()\n    viper.OnConfigChange(func(in fsnotify.Event) {\n        fmt.Printf("配置文件修改了")\n        // 这里是重新将配置文件映射到结构体\n        if err := viper.Unmarshal(Conf); err != nil {\n            fmt.Printf("配置文件映射到结构体失败")\n        }\n    })\n    return\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br")])]),a("ul",[a("li",[n._v("那么以后要获取配置文件中的配置信息，可以这样获取了，从结构体中获取")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("settings.Conf.Level\nsettings.Conf.MysqlConfig\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("h3",{attrs:{id:"三-初始化日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-初始化日志"}},[n._v("#")]),n._v(" (三) 初始化日志")]),n._v(" "),a("ul",[a("li",[n._v("日志使用"),a("code",[n._v("zap库")]),n._v("，日志初始化")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 2：初始化日志\nif err := logger.Init(settings.Conf.LogConfig); err != nil {\n    fmt.Printf("日志配置失败：%v", err)\n}\n// 将缓冲区的日志写入日志文件\ndefer zap.L().Sync()\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br")])]),a("ul",[a("li",[n._v("这里将zap日志的getEncoder/getLogWriter进行了配置，并且初始化了gin框架路由中默认的日志，panic日志， logger.go代码如下")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('var lg *zap.Logger\n\nfunc Init(cfg *settings.LogConfig, mode string) (err error) {\n\n\t//writeSyncer := getLogWriter(viper.GetString("log.filename"), viper.GetInt("log.file_size"), viper.GetInt("log.max_backups"), viper.GetInt("max_size"))\n\twriteSyncer := getLogWriter(cfg.Filename, cfg.MaxSize, cfg.MaxBackups, cfg.MaxAge)\n\tencoder := getEncoder()\n\tvar l = new(zapcore.Level)\n\terr = l.UnmarshalText([]byte(cfg.Level))\n\tif err != nil {\n\t\treturn\n\t}\n\n\tvar core zapcore.Core\n\t// 如果项目在开发模式下, 让日志既可写入到文件，也可以输出到终端\n\tif mode == "dev" {\n\t\t// 日志输出到终端\n\t\tconsoleEncoder := zapcore.NewConsoleEncoder(zap.NewDevelopmentEncoderConfig())\n\t\tcore = zapcore.NewTee(\n\t\t\tzapcore.NewCore(encoder, writeSyncer, l),\n\t\t\tzapcore.NewCore(consoleEncoder, zapcore.Lock(os.Stdout), zapcore.DebugLevel),\n\t\t)\n\t} else {\n\t\tcore = zapcore.NewCore(encoder, writeSyncer, l)\n\t}\n\n\tlg = zap.New(core, zap.AddCaller())\n\t// 替换zap包中全局的logger实例，后续在其他包中只需使用zap.L().debug()调用即可\n\tzap.ReplaceGlobals(lg)\n\treturn\n\n}\n\nfunc getEncoder() zapcore.Encoder {\n\tencoderConfig := zap.NewProductionEncoderConfig()\n\tencoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder\n\tencoderConfig.TimeKey = "time"\n\tencoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder\n\tencoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder\n\tencoderConfig.EncodeCaller = zapcore.ShortCallerEncoder\n\treturn zapcore.NewConsoleEncoder(encoderConfig)\n}\n\nfunc getLogWriter(filename string, maxSize, maxBackup, maxAge int) zapcore.WriteSyncer {\n\tlumberJackLogger := &lumberjack.Logger{\n\t\tFilename:   filename,\n\t\tMaxSize:    maxSize,\n\t\tMaxBackups: maxBackup,\n\t\tMaxAge:     maxAge,\n\t}\n\treturn zapcore.AddSync(lumberJackLogger)\n}\n\n// 下面两个日志配置，会在路由中间件中被用到\n\n// GinLogger 接收gin框架默认的日志, 这个也是中间件\nfunc GinLogger() gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\tstart := time.Now()\n\t\tpath := c.Request.URL.Path\n\t\tquery := c.Request.URL.RawQuery\n\t\t// 直接调用第二个中间件\n\t\tc.Next()\n\n\t\t// 当请求处理完毕后，再执行下面的语句，因此这里可以计算出请求消耗的时间\n\t\tcost := time.Since(start)\n\t\tzap.L().Info(path,\n\t\t\tzap.Int("status", c.Writer.Status()),\n\t\t\tzap.String("method", c.Request.Method),\n\t\t\tzap.String("path", path),\n\t\t\tzap.String("query", query),\n\t\t\tzap.String("ip", c.ClientIP()),\n\t\t\tzap.String("user-agent", c.Request.UserAgent()),\n\t\t\tzap.String("errors", c.Errors.ByType(gin.ErrorTypePrivate).String()),\n\t\t\tzap.Duration("cost", cost),\n\t\t)\n\t}\n}\n\n// GinRecovery recover项目可能出现的panic，并使用zap记录相关日志, 这个GinRecovery函数是一个中间件\nfunc GinRecovery(stack bool) gin.HandlerFunc {\n\treturn func(c *gin.Context) {\n\t\t// 使用recover的时候，defer的函数是自执行函数，这里是所有请求最后执行这个defer后的函数的，保证可以捕获到panic异常\n\t\tdefer func() {\n\t\t\tif err := recover(); err != nil {\n\t\t\t\t// 这里是检查是不是brokenpipe的错误\n\t\t\t\tvar brokenPipe bool\n\t\t\t\tif ne, ok := err.(*net.OpError); ok {\n\t\t\t\t\tif se, ok := ne.Err.(*os.SyscallError); ok {\n\t\t\t\t\t\tif strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") {\n\t\t\t\t\t\t\tbrokenPipe = true\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// 获取客户端的请求路径\n\t\t\t\thttpRequest, _ := httputil.DumpRequest(c.Request, false)\n\t\t\t\t// 如果是brokenpipe问题\n\t\t\t\tif brokenPipe {\n\t\t\t\t\tzap.L().Error(c.Request.URL.Path,\n\t\t\t\t\t\tzap.Any("error", err),\n\t\t\t\t\t\tzap.String("request", string(httpRequest)),\n\t\t\t\t\t)\n\t\t\t\t\t// If the connection is dead, we can\'t write a status to it.\n\t\t\t\t\tc.Error(err.(error))\n\t\t\t\t\t// 不再进入下一个中间件，当前中间件运行完毕即可\n\t\t\t\t\tc.Abort()\n\t\t\t\t\t// return 下面的语句也不会执行了\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\t// 记录堆栈信息\n\t\t\t\tif stack {\n\t\t\t\t\tzap.L().Error("[Recovery from panic]",\n\t\t\t\t\t\tzap.Any("error", err),\n\t\t\t\t\t\tzap.String("request", string(httpRequest)),\n\t\t\t\t\t\tzap.String("stack", string(debug.Stack())),\n\t\t\t\t\t)\n\t\t\t\t} else {\n\t\t\t\t\tzap.L().Error("[Recovery from panic]",\n\t\t\t\t\t\tzap.Any("error", err),\n\t\t\t\t\t\tzap.String("request", string(httpRequest)),\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t\t// 返回500响应报文\n\t\t\t\tc.AbortWithStatus(http.StatusInternalServerError)\n\t\t\t}\n\t\t}()\n\n\t\tc.Next()\n\t}\n}\n\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br")])]),a("h3",{attrs:{id:"四-初始化mysql数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-初始化mysql数据库"}},[n._v("#")]),n._v(" (四) 初始化MySQL数据库")]),n._v(" "),a("ul",[a("li",[n._v("MySQL数据库的连接驱动使用"),a("code",[n._v("sqlx库")]),n._v("，初始化数据库连接")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 3：初始化MySQL数据库\nif err := mysqlconnect.Init(settings.Conf.MysqlConfig); err != nil {\n    fmt.Printf("MySQL连接失败：%v", err)\n}\ndefer mysqlconnect.Close() // 程序停止后，关闭连接\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br")])]),a("ul",[a("li",[n._v("对MySQL进行了初始化，然后将db作为全局变量")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('var db *sqlx.DB\n\nfunc Init(cfg *settings.MysqlConfig) (err error) {\n\n\tdsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/%s?charset=utf8mb4&parseTime=True",\n\t\tcfg.User,\n\t\tcfg.Password,\n\t\tcfg.Host,\n\t\tcfg.Port,\n\t\tcfg.DbName,\n\t)\n\t//db, err = sqlx.Connect("mysql", dsn)\n\tdefer func() {\n\t\tr := recover()\n\t\tif r != nil {\n\t\t\tfmt.Println("连接数据库失败: %v", r)\n\t\t\tpanic(r)\n\t\t}\n\t}()\n\t// 如果连接不上，这里会panic\n\tdb = sqlx.MustConnect("mysql", dsn)\n\n\t//if err != nil {\n\t//\tfmt.Printf("connect DB failed, err:%v\\n", err)\n\t//\tzap.L().Error("connect DB failed", zap.Error(err))\n\t//\treturn\n\t//}\n\t// SetMaxIdleConns 设置空闲的最大连接数连接池。\n\t//\n\t// 如果 MaxOpenConns 大于 0 但小于新的 MaxIdleConns，\n\t// 然后将减少新的 MaxIdleConns 以匹配 MaxOpenConns 限制。\n\t//\n\t// 如果 n <= 0，则不保留空闲连接。\n\t//\n\t// 默认的最大空闲连接数当前为 2。这可能会改变\n\t// 未来版本。\n\tdb.SetMaxOpenConns(cfg.MaxOpenConns)\n\tdb.SetMaxIdleConns(cfg.MaxIdleConns)\n\treturn\n\n}\n\nfunc Close() {\n\t_ = db.Close()\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br")])]),a("h3",{attrs:{id:"五-初始化redis数据库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五-初始化redis数据库"}},[n._v("#")]),n._v(" (五) 初始化Redis数据库")]),n._v(" "),a("ul",[a("li",[n._v("Redis数据库的连接驱动使用"),a("code",[n._v("go-redis/redis库")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('if err := redisconnect.Init(settings.Conf.RedisConfig); err != nil {\n\tfmt.Printf("Redis连接失败：%v", err)\n}\ndefer redisconnect.Close() // 程序停止后，关闭连接\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("ul",[a("li",[n._v("将client作为连接Redis的全局变量")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import (\n    "fmt"\n    "jiaoshoujia/settings"\n\n    "github.com/go-redis/redis"\n)\n\n// 声明一个全局的rdb变量\nvar client *redis.Client\n\n// 初始化连接\nfunc Init(cfg *settings.RedisConfig) (err error) {\n    client = redis.NewClient(&redis.Options{\n        Addr:     fmt.Sprintf("%s:%d", cfg.Host, cfg.Port),\n        Password: cfg.Password,\n        DB:       cfg.Db,\n        PoolSize: cfg.PoolSize,\n    })\n\n    _, err = client.Ping().Result()\n    if err != nil {\n        fmt.Printf("Redis连接失败: %v\\n", err)\n        panic(err)\n    }\n    return nil\n}\n\nfunc Close() {\n    _ = client.Close()\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br")])]),a("h3",{attrs:{id:"六-初始化雪花算法生成器-生成用户id字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六-初始化雪花算法生成器-生成用户id字段"}},[n._v("#")]),n._v(" (六) 初始化雪花算法生成器：生成用户ID字段")]),n._v(" "),a("ul",[a("li",[n._v("雪花算法初始化")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('if err := snowflake.Init(settings.Conf.StartTime, settings.Conf.MachineId); err != nil {\n\t\tfmt.Printf("初始化雪花算法失败：%v", err)\n\t}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br")])]),a("ul",[a("li",[n._v("获取用户ID的hash字符串")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import (\n    "time"\n\n    sf "github.com/bwmarrin/snowflake"\n)\n\nvar node *sf.Node\n\n// 算法参数初始化\nfunc Init(startTime string, machineID int64) (err error) {\n    var st time.Time\n    st, err = time.Parse("2006-01-02", startTime)\n    if err != nil {\n        return\n    }\n    sf.Epoch = st.UnixNano() / 1000000\n    node, err = sf.NewNode(machineID)\n    return\n}\n\n// 生成ID\nfunc GenID() int64 {\n    return node.Generate().Int64()\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br")])]),a("h3",{attrs:{id:"七-注册路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七-注册路由"}},[n._v("#")]),n._v(" (七) 注册路由")]),n._v(" "),a("ul",[a("li",[n._v("在路由注册中，加入日志中间件。然后将路由分组，在gin中，路由的配置是从上向下解析的，因此在配置JWT中间件和限流中间件的时候，需要JWT认证或限流的接口应该写在中间件的下面")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("// 5：注册路由\nr := routes.Init(settings.Conf.Mode)\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("ul",[a("li",[n._v("routes.go代码如下")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func Init(mode string) *gin.Engine {\n\t// 如果配置文件中，设置为release模式，那么gin就是release\n\tif mode == gin.ReleaseMode {\n\t\tgin.SetMode(gin.ReleaseMode)\n\t}\n\t/*\n\t\t这个默认会加入Logger(), Recovery()两个中间件\n\t\tLogger() 中间件会请求的时候，将日志显示到终端\n\t\tRecovery() 中间件，当系统崩溃，会显示500的状态码\n\t*/\n\t//r := gin.Default()\n\tr := gin.New()\n\n\t// 在路由层将日志中间件加入\n\tr.Use(logger.GinLogger(), logger.GinRecovery(true))\n\t// 路由分组\n\tv1 := r.Group("/api/v1")\n\t// 注册\n\tv1.POST("/signup", controllers.SignUpHandler)\n\t// 在用户登录的时候返回jwt token\n\tv1.POST("/login", controllers.LoginHandler)\n\t// 应用jwt中间件, 限流中间件\n\tv1.Use(middlewares.JWTAuthMiddleware(), middlewares.RateLimitMiddleware(2*time.Second, 1))\n\n\t{\n\t\t// 获取列表\n\t\tv1.GET("/community", controllers.CommunityHandler)\n\t\t// 获取详情\n\t\tv1.GET("/community/:id", controllers.CommunityDetailHandler)\n\t\t// 创建一个帖子\n\t\tv1.POST("/post", controllers.CreatePostHandler)\n\t\t// 获取帖子详情\n\t\tv1.GET("/post/:id", controllers.GetPostDetailHandler)\n\t\t// 帖子的列表(默认使用MySQL中帖子创建时间排序)\n\t\tv1.GET("/posts", controllers.GetPostListHandler)\n\t\t// 帖子的列表(使用Redis中帖子创建时间或帖子分数排序)\n\t\tv1.GET("/posts2", controllers.GetPostListHandler2)\n\t\t// 投票\n\t\tv1.POST("/vote", controllers.PostVoteController)\n\t}\n\n\t// JWTAuthMiddleware函数，对jwt进行校验(anthorization头部进行验证)\n\t// 用户请求头携带标准的Bearer Auth访问/ping接口\n\tr.GET("/ping", func(context *gin.Context) {\n\t\tisLogin := true\n\t\tif isLogin {\n\t\t\tcontext.String(http.StatusOK, "pong")\n\t\t} else {\n\t\t\tcontext.String(http.StatusOK, "请登录")\n\t\t}\n\t})\n\n\treturn r\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br")])]),a("h3",{attrs:{id:"八-初始化gin框架使用的翻译器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八-初始化gin框架使用的翻译器"}},[n._v("#")]),n._v(" (八) 初始化gin框架使用的翻译器")]),n._v(" "),a("ul",[a("li",[n._v("初始化翻译器的目的是：在用户传递的字段非法的时候，进行中文错误提示")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('if err := controllers.InitTrans("zh"); err != nil {\n\t\tfmt.Printf("翻译器获取失败：%v", err)\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br")])]),a("ul",[a("li",[n._v("validator.go代码如下")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 定义一个全局翻译器T\nvar trans ut.Translator\n\n// InitTrans 初始化翻译器\nfunc InitTrans(locale string) (err error) {\n\t// 修改gin框架中的Validator引擎属性，实现自定制\n\tif v, ok := binding.Validator.Engine().(*validator.Validate); ok {\n\n\t\t// 让validator的错误返回，使用结构体的json tag字段\n\t\tv.RegisterTagNameFunc(func(fld reflect.StructField) string {\n\t\t\tname := strings.SplitN(fld.Tag.Get("json"), ",", 2)[0]\n\t\t\tif name == "-" {\n\t\t\t\treturn ""\n\t\t\t}\n\t\t\treturn name\n\t\t})\n\n\t\tzhT := zh.New() // 中文翻译器\n\t\tenT := en.New() // 英文翻译器\n\n\t\t// 第一个参数是备用（fallback）的语言环境\n\t\t// 后面的参数是应该支持的语言环境（支持多个）\n\t\t// uni := ut.New(zhT, zhT) 也是可以的\n\t\tuni := ut.New(enT, zhT, enT)\n\n\t\t// locale 通常取决于 http 请求头的 \'Accept-Language\'\n\t\tvar ok bool\n\t\t// 也可以使用 uni.FindTranslator(...) 传入多个locale进行查找\n\t\ttrans, ok = uni.GetTranslator(locale)\n\t\tif !ok {\n\t\t\treturn fmt.Errorf("uni.GetTranslator(%s) failed", locale)\n\t\t}\n\n\t\t// 注册翻译器\n\t\tswitch locale {\n\t\tcase "en":\n\t\t\terr = enTranslations.RegisterDefaultTranslations(v, trans)\n\t\tcase "zh":\n\t\t\terr = zhTranslations.RegisterDefaultTranslations(v, trans)\n\t\tdefault:\n\t\t\terr = enTranslations.RegisterDefaultTranslations(v, trans)\n\t\t}\n\t\treturn\n\t}\n\treturn\n}\n\n// 去除validator返回错误时候的结构体名称\nfunc removeTopStruct(fields map[string]string) map[string]string {\n\tres := map[string]string{}\n\tfor field, err := range fields {\n\t\tres[field[strings.Index(field, ".")+1:]] = err\n\t}\n\treturn res\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br")])]),a("h3",{attrs:{id:"九-启动服务和优雅关机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#九-启动服务和优雅关机"}},[n._v("#")]),n._v(" (九) 启动服务和优雅关机")]),n._v(" "),a("ul",[a("li",[n._v("启动服务的时候，使用net/http库，目的是包装gin的Engine，使用gin的路由处理机制，将其封装到http server中。并且监控的信号量，如果收到kill信号，那么调用http server的shutdown方法，停止进程，代码中的r就是gin框架的Engine，gin框架底层的http通信实现使用的是net/http库")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// 7：启动服务 (下面是优雅关机)\nsrv := &http.Server{\n\tAddr:    fmt.Sprintf(":%d", settings.Conf.Port),\n\tHandler: r,\n}\n\ngo func() {\n\tif err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {\n\t\tzap.L().Fatal("listen: %s\\n", zap.Error(err))\n\t}\n}()\n\nquit := make(chan os.Signal, 1)\nsignal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)\n<-quit\nzap.L().Info("Shutdown Server ...")\nctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\n// 虽然这里设置了5秒超时，但是手动调用，\ndefer cancel()\n// srv.Shutdown(ctx)中ctx.Done()是阻塞的\nif err := srv.Shutdown(ctx); err != nil {\n\tzap.L().Fatal("Server Shutdown: ", zap.Error(err))\n}\nzap.L().Info("Server exiting")\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br")])])])}),[],!1,null,null,null);s.default=e.exports},760:function(n,s,t){n.exports=t.p+"assets/img/2021-10-133.26.05.a791db80.png"},761:function(n,s,t){n.exports=t.p+"assets/img/2021-10-133.27.15.61b3ca97.png"}}]);