(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{1685:function(s,t,a){s.exports=a.p+"assets/img/2021-10-193.59.03.8d103564.png"},1686:function(s,t,a){s.exports=a.p+"assets/img/lct.d8aa6572.png"},1687:function(s,t,a){s.exports=a.p+"assets/img/gz.04c0fe61.png"},1688:function(s,t,a){s.exports=a.p+"assets/img/2021-10-224.24.51.093c7b26.png"},1689:function(s,t,a){s.exports=a.p+"assets/img/2021-10-224.51.26.c005bcdd.png"},1690:function(s,t,a){s.exports=a.p+"assets/img/2021-10-224.59.05.e8de7943.png"},1691:function(s,t,a){s.exports=a.p+"assets/img/2021-10-225.29.08.9117dc3c.png"},2644:function(s,t,a){"use strict";a.r(t);var n=a(9),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"一-用户认证需求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-用户认证需求"}},[s._v("#")]),s._v(" 一：用户认证需求")]),s._v(" "),n("h3",{attrs:{id:"一-用户注册"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-用户注册"}},[s._v("#")]),s._v(" (一)：用户注册")]),s._v(" "),n("ul",[n("li",[s._v("注册业务模型")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1685),alt:"Alt text"}})]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：用户填写手机号，点击发送验证码\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("：用户输入账号、密码、验证码")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("有过期时间限制"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("提交注册\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("img",{attrs:{src:a(1686),alt:"Alt text"}})]),s._v(" "),n("ul",[n("li",[s._v("这里的验证码是存储在Redis中的，并且使用了过期机制，60秒过期自动删除")])]),s._v(" "),n("h3",{attrs:{id:"二-用户认证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-用户认证"}},[s._v("#")]),s._v(" (二)：用户认证")]),s._v(" "),n("ul",[n("li",[s._v("认证一般使用jwt认证方式，一次密码认证就后，就使用jwt认证了")])]),s._v(" "),n("h3",{attrs:{id:"三-还有一种oanth2-0认证的方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-还有一种oanth2-0认证的方法"}},[s._v("#")]),s._v(" (三)：还有一种Oanth2.0认证的方法")]),s._v(" "),n("ul",[n("li",[s._v("这种方法是给第三方应用授权，获取后台的数据")])]),s._v(" "),n("h3",{attrs:{id:"二-redis抢购代金券"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-redis抢购代金券"}},[s._v("#")]),s._v(" 二：Redis抢购代金券")]),s._v(" "),n("h3",{attrs:{id:"一-开发抢购代金券需要使用哪些表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-开发抢购代金券需要使用哪些表"}},[s._v("#")]),s._v(" (一)：开发抢购代金券需要使用哪些表")]),s._v(" "),n("ul",[n("li",[s._v("代金券表，字段如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：id：代金券的"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：title：代金券的标题\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：thumbnail：代金券的缩略图\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：amount：抵扣金额\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：price：代金券售价\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("：status：代金券状态\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("：start_use_time：代金券开始使用时间\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("：expire_time：代金券过期时间\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("：redeem_restaurant_id：代金券验证餐厅\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("：stock：代金券库存\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("：stock_left：代金券库存剩余\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("：description：描述信息\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("：clause：使用条款\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("：create_time：创建日期\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("：update_time：更新日志\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("ul",[n("li",[s._v("抢购活动表，字段如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：id：活动表"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：fk_voucher_id：代金券"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：amount：代金券数量\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：start_time：开始时间\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：end_time：结束时间\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("：is_valid：是否有效\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("：create_time：创建日期\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("：update_time：更新日志\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("订单表，字段如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：id：订单的"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：order_no：订单序列号\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：fk_voucher_id：代金券"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：fk_activity_id：活动"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：qrcode：图片地址\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("：payment：微信、支付宝\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("：status：订单状态\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("：create_time：创建日期\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("：update_time：更新日志\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"二-秒杀场景的主要特点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-秒杀场景的主要特点"}},[s._v("#")]),s._v(" (二)：秒杀场景的主要特点")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("1：请求数量大")])]),s._v(" "),n("li",[n("p",[s._v("2：请求量远远大于库存量")])])]),s._v(" "),n("h3",{attrs:{id:"三-解决秒杀场景的主要问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-解决秒杀场景的主要问题"}},[s._v("#")]),s._v(" (三)：解决秒杀场景的主要问题")]),s._v(" "),n("ul",[n("li",[s._v("主要问题")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：限制单个用户的抢购频率，漏斗算法和令牌桶算法实现应用级别的限流\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：缓存，将库存数据存储在Redis中，减少MySQL的压力\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：异步下单，将下单任务放在rabbitmq来做\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：分流\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"四-库存超卖问题的解决方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-库存超卖问题的解决方案"}},[s._v("#")]),s._v(" (四)：库存超卖问题的解决方案")]),s._v(" "),n("ul",[n("li",[s._v("扣减库存的操作，在高并发下请求过多，那么会导致超卖的情况出现。解决的方法是将扣减库存的逻辑放在Redis中来实现")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：声明一个Redis的key，这个key可以是前缀"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("活动Id\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：基于抢购活动的字段数据，构建一个map，写入到Redis中\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：在Redis中，将map的amount字段进行自减，那么这里就是将原本在MySQL记录中做的扣减库存操作，改为在Redis中来做\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：那在Redis中扣除库存的时候，必须保证amount不能变的情况下，才能进行amount"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("操作，因此在Golang中需要使用watch"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("txPipeline的事务方式来做，保证amount的查看和修改必须在一个线程中完成，且是原子性操作。当然，也可以在Golang中调用Redis的lua脚本，将这个操作封装在lua脚本中完成\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：那么MySQL中的的活动表就转移到了Redis中了，MySQL的活动表就不用了\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"五-分布式锁-多进程锁-解决方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五-分布式锁-多进程锁-解决方案"}},[s._v("#")]),s._v(" (五)：分布式锁(多进程锁)解决方案")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Golang自带的sync.Mutex互斥锁只能解决单一进程中不同的goroutine之间的共享")]),s._v("。"),n("code",[s._v("但是在生产业务中，一般都是分布式的多进程业务场景")]),s._v("，在这种情况下，要保证多个进程都共享锁，那么就需要使用"),n("code",[s._v("分布式锁")]),s._v("，分布式锁满足下面三个条件")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：多进程可见\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：互斥\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：可重入：同一线程或进程可以在同一时刻对临界资源重复加锁\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[s._v("在Redis中，有一个"),n("code",[s._v("setnx指令")]),s._v("，只有当key不存在的时候，才能插入成功，否则插入失败。那么"),n("code",[s._v("setnx指令")]),s._v("基本用法如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当Redis中没有这个account的时候，可以插入成功，返回1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setnx account "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当Redis中有这个account的时候，可以插入失败，返回0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setnx account "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 只有在删除这个account的时候，下次再插入才能成功")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" del "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("account")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setnx account "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[s._v("那么可以使用Redis的"),n("code",[s._v("setnx指令")]),s._v("作为分布式锁，但是这里有个问题，如果在Golang的某个goroutine中，代码异常退出了，那么锁就无法被释放了，这种情况下可以使用Redis的另外一个指令"),n("code",[s._v("expire指令")]),s._v("，可以给某个key设置过期时间，那么就不怕锁无法被释放了，其实这两个是可以合并在一起写的，写法如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 加锁的同时设置过期时间")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" account "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" ex "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" nx \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("但是这里还有一个问题，例如有三个进程A,B,C。A进程使用"),n("code",[s._v("setnx指令")]),s._v("设置了一把锁，但是由于运行时间过长，出现timeout了，那么锁自动被删除了，但是此时A进程还没有执行"),n("code",[s._v("del指令")]),s._v("去释放锁。此时B进程就可以访问临界资源了(因为没有锁)，B进程使用"),n("code",[s._v("setnx指令")]),s._v("设置了一把锁，"),n("code",[s._v("然后A进程运行到释放锁的指令，将B进程的锁删除了")]),s._v("。此时C进程就可以访问临界资源了(因为B进程的锁被删除了)，那么此时C再加上一把锁，对临界资源进行访问。在这个过程中，B、C进程之间无法保证同一时刻只能有一个进程访问临界资源，因此临界资源的操作又会有问题。解决问题的方法也很简单，"),n("code",[s._v("让不同进程只能释放自己加的锁")])])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("那么在加锁的时候，也就是执行setnx指令的时候，key对应的值可以是requestId、cookieId、goroutineid等有唯一标识的值，那么在执行del指令的时候，先判断，是否是自己设置的值，如果是就删除，如果说明是别人设置的，就不删除\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"六-可重入锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六-可重入锁"}},[s._v("#")]),s._v(" (六)：可重入锁")]),s._v(" "),n("ul",[n("li",[s._v("在goroutine在并发访问的时候，可能会出现死锁的情况。同一个goroutine两次申请锁，就会出现阻塞panic，因为Mutex是不可重入锁，"),n("code",[s._v("因为第一次申请的锁还没有释放，第二次申请锁的前提提交是第一次申请的锁被释放了，第一次申请的锁被释放的前提条件是第二次申请锁再释放锁")]),s._v("，例如下面的代码")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" x int64\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" wg sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" lock sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Mutex\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdefer wg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 第一次申请锁")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("incr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 第一次释放锁，必须等incr()函数执行完毕，但是incr()函数里面需要申请锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("incr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 第二次申请锁，必须要第一次申请的锁是否掉")]),s._v("\n\t\tx"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tgo "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goroutine1启动"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tgo "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goroutine2启动"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("ul",[n("li",[s._v("解决这个"),n("code",[s._v("不可重入锁")]),s._v("问题也很简单，就是"),n("code",[s._v("设计可重入锁")]),s._v("，在Golang中标准库中并没有可重入锁，因为Golang认为，如果你需要可重入锁，说明你的代码有问题了。"),n("code",[s._v("下面是Golang中可重入锁的设计思想")]),s._v("，下面的代码中，GoroutineId通过"),n("code",[s._v("github.com/cch123/goroutineid第三方库")]),s._v("获取")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("type ReentrantLock struct "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tlock      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Mutex\n\tcond      "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Cond\n\trecursion int32 "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 计数器")]),s._v("\n\thost      int64\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewReentrantLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Locker "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tres "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlock"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Mutex"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\trecursion"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\thost"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tres"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cond "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewCond")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" res\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Lock 可重入锁加锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" goroutineid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetGoID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tdefer rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果当前goroutine拿到这把锁，那么直接recursion+1就好")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" id "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果是其他的goroutine拿到这把锁，那么需要阻塞等待")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"阻塞等待"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cond"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 让可重入锁设置为其他的goroutine的id")]),s._v("\n\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" id\n\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Unlock 可重入锁解锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rt "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tdefer rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine解锁的时候，如果发现recursion为0，或者不是自己的锁，直接return，什么都不做，或者panic也可以")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" goroutineid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetGoID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Sprintf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"the wrong call host: (%d); current_id: %d; recursion: %d"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetGoID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('//fmt.Printf("the wrong call host: (%d); current_id: %d; recursion: %d\\n", rt.host, goroutineid.GetGoID(), rt.recursion)')]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//return")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 如果发现recursion为0了，说明锁已经可以被释放了")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" rt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("recursion "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\trt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cond"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Signal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 通知")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tlock "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewReentrantLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tgo "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br")])]),n("h3",{attrs:{id:"七-redis中的可重入锁的解决方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#七-redis中的可重入锁的解决方案"}},[s._v("#")]),s._v(" (七)：Redis中的可重入锁的解决方案")]),s._v(" "),n("ul",[n("li",[s._v("设计思路如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：假设锁的key为lock，hashKey是当前goroutineId，锁超时自动释放的时间为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("s\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：获取锁的步骤：\n\t①：判断lock这个key是否存在：【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("EXISTS")]),s._v(" lock】\n\t②：lock不存在，获取锁，记录重入次数，第一次为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：【 Hset lock goroutineId "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("】，且设置超时时间\n\t③：lock存在，说明有人已经获取锁了，判断一下是不是自己的锁，通过判断lock中，是否存在goroutineId这个hashKey：【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HEXISTS")]),s._v(" lock goroutineId】\n\t\ti：如果goroutineId这个hashKey不存在，那么说明不是自己的锁，那么此时不会再次创建hashKey了必须等别人的hashKey删除掉才行，因此获取锁失败\n\t\tii：如果goroutineId这个hashKey存在，说明是自己的锁，让重入次数"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("，且更新hashKey过期时间：【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HINCRBY")]),s._v(" lock goroutineId "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("】【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("EXPIRE")]),s._v(" lock "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("】\n\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：释放锁的步骤：\n\t①：先判断goroutineId这个hashKey是否存在：【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HEXISTS")]),s._v(" lock goroutineId】\n\t\ti：如果存在，说明自己的锁还在，让重入次数"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：【"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("HINCRBY")]),s._v(" lock goroutineId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("】，再判断重入次数是否为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("，如果为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("，说明锁全部释放，需要删除锁：【del lock】\n\t\tii：如果不存在，说明锁已经超时自动被释放了，不需要任何操作\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[s._v("使用lua脚本操作Redis(原子操作)，"),n("code",[s._v("获取锁")]),s._v("代码如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" key：lock\nlocal key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("KEYS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlocal goroutineId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ARGV")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" timeout"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("秒\nlocal timeout "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ARGV")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 判断lock这个key不存在\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exists'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" then\n\t"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 获取锁，记录重入次数，第一次为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hset'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 设置超时时间\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'expire'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nend\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 判断是不是自己的锁，如果是自己的锁\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hexists'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" then\n\t"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 直接加"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hincrby'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 设置超时时间\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'expire'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" timeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nend\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 如果是别人的锁，说明获取锁失败，返回"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("ul",[n("li",[s._v("使用lua脚本操作Redis(原子操作)，"),n("code",[s._v("释放锁")]),s._v("代码如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" key：lock\nlocal key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("KEYS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlocal goroutineId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ARGV")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 是自己创建的锁，让重入次数"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HEXISTS'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" then\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" nil\nend\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" 判断重入次数是否为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("，如果为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("，说明锁全部释放，需要删除锁\nlocal count "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HINCRBY'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("count "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" then\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("redis")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DEL'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" key"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" nil\nend\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("ul",[n("li",[s._v("在Golang代码中使用可重入锁")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" wg sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" client "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Client\n\ntype ReentrantLock struct"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewReentrantLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Locker "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lockScript 获取锁脚本")]),s._v("\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lockScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Script "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tscript "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\n\t\t-- key：lock\n\t\tlocal key = KEYS[1]\n\t\tlocal goroutineId = ARGV[1]\n\t\t-- timeout: 20秒\n\t\tlocal timeout = ARGV[2]\n\t\t\n\t\t-- 判断lock这个key不存在\n\t\tif (redis.call('exists', key) == 0) then\n\t\t\t-- 获取锁，记录重入次数，第一次为1\n\t\t\tredis.call('hset', key, goroutineId, '1')\n\t\t\t-- 设置超时时间\n\t\t\tredis.call('expire', key, timeout)\n\t\t\treturn 1\n\t\tend\n\t\t\n\t\t-- 判断是不是自己的锁，如果是自己的锁\n\t\tif (redis.call('hexists', key, goroutineId) == 1) then\n\t\t\t-- 直接加1\n\t\t\tredis.call('hincrby', key, goroutineId, '1')\n\t\t\t-- 设置超时时间\n\t\t\tredis.call('expire', key, timeout)\n\t\t\treturn 1\n\t\tend\n\t\t\n\t\t-- 如果是别人的锁，说明获取锁失败，返回0\n\t\treturn 0\n\n\t")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" script\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// unlockScript 释放锁脚本")]),s._v("\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlockScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Script "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tscript "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\n\t\t-- key：lock\n\t\tlocal key = KEYS[1]\n\t\tlocal goroutineId = ARGV[1]\n\t\t\n\t\t-- 如果不存在，直接返回0\n\t\tif (redis.call('HEXISTS', key, goroutineId) == 0) then\n\t\t\treturn 1\n\t\tend\n\t\t\n\t\t-- 判断重入次数是否为0，如果为0，说明锁全部释放，需要删除锁\n\t\tlocal count = redis.call('HINCRBY', key, goroutineId, -1)\n\t\t\n\t\tif (count == 0) then\n\t\t\tredis.call('DEL', key)\n\t\t\treturn 1\n\t\tend\n\n\t\treturn 1\n\n\t")]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" script\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Lock 加锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("r "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\tlock "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("lockScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tsha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Load")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行脚本")]),s._v("\n\tgoroutineId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" goroutineid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetGoID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tret "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("EvalSha")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Panicf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"获取锁Execute lua fail: %v\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("int64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goroutineId：%d，获取锁成功\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goroutineId：%d，获取锁失败\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Unlock 解锁")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("r "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("ReentrantLock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\tunlock "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlockScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tsha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" unlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Load")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行脚本")]),s._v("\n\tgoroutineId "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" goroutineid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetGoID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tret "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("EvalSha")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lock"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" _"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Panicf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"释放锁Execute lua fail: %v\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goroutineId：%d，释放锁成功\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" goroutineId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\tclient "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewClient")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tAddr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:6379"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tPassword"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DB")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tlock "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewReentrantLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tgo "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tdefer wg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tlock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"执行完毕"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 输出结果：")]),s._v("\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("，获取锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("，获取锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("，获取锁失败\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("，释放锁成功\ngoroutineId："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("，释放锁成功\n执行完毕\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br"),n("span",{staticClass:"line-number"},[s._v("141")]),n("br"),n("span",{staticClass:"line-number"},[s._v("142")]),n("br"),n("span",{staticClass:"line-number"},[s._v("143")]),n("br"),n("span",{staticClass:"line-number"},[s._v("144")]),n("br"),n("span",{staticClass:"line-number"},[s._v("145")]),n("br"),n("span",{staticClass:"line-number"},[s._v("146")]),n("br"),n("span",{staticClass:"line-number"},[s._v("147")]),n("br"),n("span",{staticClass:"line-number"},[s._v("148")]),n("br"),n("span",{staticClass:"line-number"},[s._v("149")]),n("br"),n("span",{staticClass:"line-number"},[s._v("150")]),n("br"),n("span",{staticClass:"line-number"},[s._v("151")]),n("br"),n("span",{staticClass:"line-number"},[s._v("152")]),n("br"),n("span",{staticClass:"line-number"},[s._v("153")]),n("br"),n("span",{staticClass:"line-number"},[s._v("154")]),n("br"),n("span",{staticClass:"line-number"},[s._v("155")]),n("br"),n("span",{staticClass:"line-number"},[s._v("156")]),n("br"),n("span",{staticClass:"line-number"},[s._v("157")]),n("br"),n("span",{staticClass:"line-number"},[s._v("158")]),n("br"),n("span",{staticClass:"line-number"},[s._v("159")]),n("br"),n("span",{staticClass:"line-number"},[s._v("160")]),n("br"),n("span",{staticClass:"line-number"},[s._v("161")]),n("br"),n("span",{staticClass:"line-number"},[s._v("162")]),n("br"),n("span",{staticClass:"line-number"},[s._v("163")]),n("br"),n("span",{staticClass:"line-number"},[s._v("164")]),n("br"),n("span",{staticClass:"line-number"},[s._v("165")]),n("br"),n("span",{staticClass:"line-number"},[s._v("166")]),n("br"),n("span",{staticClass:"line-number"},[s._v("167")]),n("br"),n("span",{staticClass:"line-number"},[s._v("168")]),n("br"),n("span",{staticClass:"line-number"},[s._v("169")]),n("br"),n("span",{staticClass:"line-number"},[s._v("170")]),n("br"),n("span",{staticClass:"line-number"},[s._v("171")]),n("br"),n("span",{staticClass:"line-number"},[s._v("172")]),n("br")])]),n("h3",{attrs:{id:"八-redis中实现一人一单的限购"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#八-redis中实现一人一单的限购"}},[s._v("#")]),s._v(" (八)：Redis中实现一人一单的限购")]),s._v(" "),n("ul",[n("li",[s._v("示例代码")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("func "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Script "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tscript "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\n\t\t\n\t\t\t-- 声明局部变量\n\t\t\tlocal goodsSurplus\n\t\t\tlocal flag\n\t\t\t\n\t\t\t-- existUserIds：hadBuyUids\n\t\t\t-- goodsSurplusKey：goodsSurplus\n\t\t\tlocal existUserIds    = tostring(KEYS[1])\n\t\t\tlocal goodsSurplusKey = tostring(KEYS[2])\n\t\t\t\n\t\t\t-- memberUid：5824742984\n\t\t\tlocal memberUid       = tonumber(ARGV[1])\n\t\t\t\n\t\t\t-- 执行Redis命令：查看existUserIds集合中是否存在memberUid\n\t\t\tlocal hasBuy = redis.call("sIsMember", existUserIds, memberUid)\n\t\t\t\n\t\t\t-- 判断用户是否买了商品，如果为0，说明没有买，如果不为0，说明买了，那么直接结束脚本\n\t\t\tif hasBuy ~= 0 then\n\t\t\t  return 0\n\t\t\tend\n\t\t\t\n\t\t\t-- 如果用户没有买，获取goodsSurplusKey商品的库存，如果库存不存在，那么直接结束脚本\n\t\t\tgoodsSurplus =  redis.call("GET", goodsSurplusKey)\n\t\t\tif goodsSurplus == false then\n\t\t\t  return 0\n\t\t\tend\n\t\t\t\n\t\t\t-- 如果库存存在，且库存为0，那么直接结束脚本\n\t\t\tgoodsSurplus = tonumber(goodsSurplus)\n\t\t\tif goodsSurplus <= 0 then\n\t\t\t  return 0\n\t\t\tend\n\t\t\t\n\t\t\t-- 扣减库存：先将用户的id加入到已买集合，再让库存减一\n\t\t\tflag = redis.call("SADD", existUserIds, memberUid)\n\t\t\tflag = redis.call("DECR", goodsSurplusKey)\n\t\t\t\n\t\t\t-- 最后返回1，表示扣减库存成功\n\t\t\treturn 1\n\t')]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" script\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// evalScript 执行lua脚本")]),s._v("\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("evalScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("client "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" userId string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tdefer wg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取脚本对象")]),s._v("\n\tscript "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("createScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建sha值与脚本的对应关系")]),s._v("\n\tsha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" script"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Load")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Fatalln")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// 执行sha值对应的脚本，key是"hadBuyUids", "goodsSurplus"，args是userId，例如5824742984，keys和args会传递到Redis脚本中')]),s._v("\n\tret "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("EvalSha")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sha"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hadBuyUids"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"goodsSurplus"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" userId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获取Redis的返回结果")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ret"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Result")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" nil "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tlog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Fatalf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Execute Redis fail: %v\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("int64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"userId：%s，第一次抢购商品，扣减库存成功\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" userId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tfmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Printf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"userId：%s，已经抢购过商品，扣减库存失败\\n"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" userId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nfunc "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" wg sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup\n\tclient "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewClient")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("redis"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tAddr"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("     "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"localhost:6379"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tPassword"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DB")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("       "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这里假设4个用户发送了6个请求去扣减库存")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" _"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" range "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742984"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742984"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742983"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742983"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742982"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5824742980"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tgo "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("evalScript")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("client"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" v"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("wg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\twg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br")])]),n("h3",{attrs:{id:"三-redis实现好友功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-redis实现好友功能"}},[s._v("#")]),s._v(" 三：Redis实现好友功能")]),s._v(" "),n("h3",{attrs:{id:"一-业务表模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-业务表模型"}},[s._v("#")]),s._v(" (一)：业务表模型")]),s._v(" "),n("ul",[n("li",[s._v("好友相关的功能包括：关注，取消关注，我的关注，我的粉丝，共同关注等。"),n("code",[s._v("粉丝表")]),s._v("相关字段如下，主要功能是记录谁关注谁")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：表id\ndiner_id：用户外键\nfollow_diner_id：被关注用户的外键\nis_valid：关注、取关、未关注\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("ul",[n("li",[s._v("关注和取关的业务逻辑")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1687),alt:"Alt text"}})]),s._v(" "),n("h3",{attrs:{id:"二-设计思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-设计思路"}},[s._v("#")]),s._v(" (二)：设计思路")]),s._v(" "),n("ul",[n("li",[s._v("需要在Redis中，创建关注集合和粉丝集合两个key，使用set数据类型来做")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("关注集合的key：following"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("，value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n粉丝集合的key：follower"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("，value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v("，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"三-获取共同关注的列表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-获取共同关注的列表"}},[s._v("#")]),s._v(" (三)：获取共同关注的列表")]),s._v(" "),n("ul",[n("li",[s._v("这个就可以直接在Redis里面来做了，"),n("code",[s._v("由于可以从Redis中获取每个用户的关注列表，那么就可以获取两个用户的关注列表，然后取交集，就可以获取共同关注的用户id列表")])])]),s._v(" "),n("h3",{attrs:{id:"四-redis实现feed功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-redis实现feed功能"}},[s._v("#")]),s._v(" 四：Redis实现Feed功能")]),s._v(" "),n("h3",{attrs:{id:"一-feed的特征"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-feed的特征"}},[s._v("#")]),s._v(" (一)：Feed的特征")]),s._v(" "),n("ul",[n("li",[s._v("什么是Feed")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("Feed的分类有多种，例如微信的朋友圈，微博，说说等，常见的有两类\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：Timeline：按发布的时间顺序，先发布的排列在最顶端，类似微信朋友圈。如果产品选择Feed流，那么就认为每个Feed不多，可枚举，但是重要性相同，用户都需要看到\n\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：Rank：按照排名发布，一般推送实时的Top "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("N")]),s._v("，应用场景为新闻推荐、商品推荐等\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"二-feed流需要解决两个问题-一个是存储-一个是推送"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-feed流需要解决两个问题-一个是存储-一个是推送"}},[s._v("#")]),s._v(" (二)：Feed流需要解决两个问题：一个是存储，一个是推送")]),s._v(" "),n("ul",[n("li",[s._v("存储")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("数据结果比较简单的可以使用MySQL存储，较为复杂的使用MongoDB或者Hbase存储\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("推送")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：拉取\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：推送：使用Redis 的sorted "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("可以按照时间排序"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("维护粉丝的Feed集合，当博主添加Feed，主动将内容推送到粉丝的Feed集合中，这样用户可以方便的从集合中读取\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：推拉结合：在用户量比较多的时候，使用推拉结合，例如粉丝超过了"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("万，那么就使用拉取Feed，低于"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("万使用推送Feed\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"三-feed业务模型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-feed业务模型"}},[s._v("#")]),s._v(" (三)：Feed业务模型")]),s._v(" "),n("ul",[n("li",[s._v("Feed的表结构设计")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：表"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\ncontent：内容\nfk_diner_id：用户id\npraise_amount：点赞数量\ncomment_amount：评论数量\nfk_restaurant_id：餐厅id\nis_valid：是否有效，这里是用来控制是否删除的\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("ul",[n("li",[s._v("Feed业务逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：校验Feed，不能为空，不能太长\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：获取用户信息\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：Feed关联用户信息\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：添加Feed\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：获取粉丝id：如果是微服务的话，需要调用微服务接口\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("：推送到粉丝的Feed列表：这里可以使用rabbitmq，异步推送，提升性能\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("：推送Feed\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("ul",[n("li",[s._v("粉丝的Feed列表使用Redis的sorted set，score是时间，通过score来排序")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("粉丝的FeedKey：key：following_feeds"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("followId"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("，value是"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("feedId1"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("，"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("feedId2"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("p",[s._v("当博主写了一篇Feed，那么需要从Redis中获取博主的FollowerIds，遍历FollowerIds，设置Redis Sorted Set的key为"),n("code",[s._v("following_feeds:<followId>")]),s._v("，value为"),n("code",[s._v("[<feedId1>，<feedId2>]")]),s._v("，score为"),n("code",[s._v("当前时间")]),s._v("（这里提升性能，可以使用消息队列异步执行feed添加操作）")])]),s._v(" "),n("li",[n("p",[s._v("当Feed添加到粉丝用户的"),n("code",[s._v("following_feeds:<followId>")]),s._v("后，用户查看Feed，那么就可以直接先查询Redis，获取feedId，且根据score排序，再根据feedId获取FeedContent等信息了")])])]),s._v(" "),n("h3",{attrs:{id:"四-feed删除"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-feed删除"}},[s._v("#")]),s._v(" (四)：Feed删除")]),s._v(" "),n("ul",[n("li",[s._v("上面说明了Feed添加的逻辑，下面说明一下Feed删除的逻辑，基本逻辑如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：根据FeedId判断Feed是否存在，且判断是否是自己的Feed\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：如果判断添加都通过，那么就逻辑删除，不是真正的删除\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：将对应的FeedId从following_feeds"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("followId"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("中删除")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("也是可以放在rabbitmq来做的"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"五-用户关注和取关-feed的变更业务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五-用户关注和取关-feed的变更业务"}},[s._v("#")]),s._v(" (五)：用户关注和取关，Feed的变更业务")]),s._v(" "),n("ul",[n("li",[s._v("当A用户关注B用户，需将B的所有的FeedId，写入到"),n("code",[s._v("following_feeds:<A用户Id>")]),s._v("的集合中。同理，当A用户取关B用户，需将B的所有的FeedId，从"),n("code",[s._v("following_feeds:<A用户Id>")]),s._v("的集合中删除")])]),s._v(" "),n("h3",{attrs:{id:"六-feed的查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六-feed的查询"}},[s._v("#")]),s._v(" (六)：Feed的查询")]),s._v(" "),n("ul",[n("li",[s._v("Feed的查询是直接从数据库进行分页查询的")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：获取Redis中用户的Feed集合\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：然后按照score排倒叙，分页从Redis的Sorted Set中查询数据\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：Feed一般是查询一般是流式查询，分页的时候，只需要知道page就可以了，pageSize是固定的，那么用户就可以一直向下刷\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：然后从数据库根据主键查询到对应的Feed\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"五-redis实现用户签到"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五-redis实现用户签到"}},[s._v("#")]),s._v(" 五：Redis实现用户签到")]),s._v(" "),n("h3",{attrs:{id:"一-签到逻辑设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-签到逻辑设计"}},[s._v("#")]),s._v(" (一)：签到逻辑设计")]),s._v(" "),n("ul",[n("li",[s._v("签到表")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：表id\nfk_diner_id：用户id\nsign_date：签到日期\namount：连续签到次数\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"二-redis中的bitmap数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-redis中的bitmap数据"}},[s._v("#")]),s._v(" (二)：Redis中的bitmap数据")]),s._v(" "),n("ul",[n("li",[s._v("原理")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("bitmap就是通过最小的单位bit来进行"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("或者"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("的设置，表示某个元素对应的值或者状态，一个bit的值只能是"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("或者"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("相关操作")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在2021年10月，给用户ID为34的用户签到，0表示第一天，1表示签到")]),s._v("\nsetbit user"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("sign"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202110")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从索引为0开始，31天有")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BITFIELD")]),s._v(" user"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("sign"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202110")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("get")]),s._v("  u31 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[s._v("签到逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：获取用户id和日期\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：构建签到的key\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：查看是否今天已经签到：getbit user"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("sign"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202110")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：如果没有签到，就签到：setbit user"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("sign"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("202110")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：统计连续签到次数\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h3",{attrs:{id:"六-redis实现用户签到积分"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六-redis实现用户签到积分"}},[s._v("#")]),s._v(" 六：Redis实现用户签到积分")]),s._v(" "),n("h3",{attrs:{id:"一-签到积分逻辑设计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-签到积分逻辑设计"}},[s._v("#")]),s._v(" (一)：签到积分逻辑设计")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("例如一个月，连续签到2天送30积分，以此类推")])]),s._v(" "),n("li",[n("p",[s._v("积分表设计")])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1688),alt:"Alt text"}})]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：表id\nfk_diner_id：用户id\npoints：积分\ntypes：积分类型："),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("签到，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("关注好友，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("添加评论，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("点赞商户\nis_valid：是否有效\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("ul",[n("li",[s._v("逻辑设计")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("连续签到本质上上根据用户的连续见到了几天，送多少积分，积分会写入到MySQL表中\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"二-mysql实现积分排行榜-topn问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-mysql实现积分排行榜-topn问题"}},[s._v("#")]),s._v(" (二)：MySQL实现积分排行榜，TopN问题")]),s._v(" "),n("ul",[n("li",[s._v("查询用户的积分最高的前20个用户的名称、积分总数，SQL语句如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SELECT")]),s._v(" \n\tt1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("points"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" total"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// rank函数在MySQL8可以使用，直接排序后设置一个字段")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rank")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("over")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ORDER")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("points"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DESC")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ranks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tt2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("nickname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tt2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("avatar_url\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("FROM")]),s._v(" t_diner_point t1\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LEFT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JOIN")]),s._v(" t_diner t2 on t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("WHERE")]),s._v(" t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_valid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AND")]),s._v(" t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_valid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("GROUP")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ORDER")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" total "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DESC")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LIMIT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("ul",[n("li",[s._v("表结果输出如下，"),n("code",[s._v("多了一个ranks字段，字段的值是按照积分倒叙排列生成的顺序值")])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1689),alt:"Alt text"}})]),s._v(" "),n("ul",[n("li",[n("code",[s._v("如果需要查询id为5的用户积分，SQL语句如下")]),s._v("：直接在输出结果之上，再进行子查询即可")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SELECT")]),s._v(" id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" total"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ranks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nickname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" avatar_url "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("FROM")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SELECT")]),s._v(" \n\t\tt1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("points"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" total"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("rank")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("over")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ORDER")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("points"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DESC")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" ranks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tt2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("nickname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tt2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("avatar_url\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("FROM")]),s._v(" t_diner_point t1\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LEFT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JOIN")]),s._v(" t_diner t2 on t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("WHERE")]),s._v(" t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_valid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AND")]),s._v(" t2"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_valid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("GROUP")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" t1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("fk_diner_id\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ORDER")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("BY")]),s._v(" total "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DESC")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("LIMIT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" t\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("WHERE")]),s._v(" id "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[s._v("输出的表结果如下")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1690),alt:"Alt text"}})]),s._v(" "),n("h3",{attrs:{id:"三-redis实现积分排行榜-topn问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-redis实现积分排行榜-topn问题"}},[s._v("#")]),s._v(" (三)：Redis实现积分排行榜，TopN问题")]),s._v(" "),n("ul",[n("li",[s._v("TopN问题可以使用Redis的Sorted Set数据类型来解决，优势在于：")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：Redis是内存数据库，可以有效减少磁盘"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("IO")]),s._v("问题\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：Sorted Set数据类型，由于携带score分数，直接保证了就是按照积分排序的\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ul",[n("li",[s._v("那么在存储用户的积分的时候，就需要将积分写入一份到Redis的Sorted Set中， 但是写的过程中，"),n("strong",[s._v("要做score求和")]),s._v("，也就是使用"),n("code",[s._v("ZINCRBY命令")]),s._v("，那么对Redis查询TopN就很方便了")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ZREVRANGE")]),s._v(" diner"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("points "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" withscores\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("输出结果如下：结果返回用户的ID和积分")])]),s._v(" "),n("p",[n("img",{attrs:{src:a(1691),alt:"Alt text"}})]),s._v(" "),n("ul",[n("li",[s._v("如果要获取用户的积分")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("zscore diner"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("points "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1689")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 输出：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("837")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ul",[n("li",[s._v("如果要获取用户的排名")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("zrevrank diner"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("points "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1689")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 输出：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"四-mysql、redis实现积分排行榜-解决topn问题性能对比"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-mysql、redis实现积分排行榜-解决topn问题性能对比"}},[s._v("#")]),s._v(" (四)：MySQL、Redis实现积分排行榜，解决TopN问题性能对比")]),s._v(" "),n("ul",[n("li",[s._v("性能测试表明：使用Redis解决比MySQL解决吞吐量明显提升")])]),s._v(" "),n("h3",{attrs:{id:"七-redis实现附件的人"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#七-redis实现附件的人"}},[s._v("#")]),s._v(" 七：Redis实现附件的人")]),s._v(" "),n("h3",{attrs:{id:"一-需求分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-需求分析"}},[s._v("#")]),s._v(" (一)：需求分析")]),s._v(" "),n("ul",[n("li",[s._v("Redis实现附近的人"),n("code",[s._v("设计思路")])])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("解决基于地理位置的搜索，很多数据库都支持，MySQL、MongoDB、Redis等都支持地理位置的存储\n\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：当用户登录"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("APP")]),s._v("时候，客户端可能获取用户的地理位置，然后将地理位置发送给后台，"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("分钟更新一次\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：当用户点击【附近的人】功能的时候，那么后台以当前用户的位置为圆点，距离为半径查询相关用户即可\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ul",[n("li",[s._v("这个使用Redis的GEO来做，具体思路如下")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：获取当前用户的key，用户的经纬度，以及附近人距离\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：限制附近的人为"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("人，包含距离，按照由近到远返回\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：以用户的经纬度为圆心，范围"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("m，获取附近人的location信息\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：返回用户信息\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"八-redis实现缓存餐厅数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#八-redis实现缓存餐厅数据"}},[s._v("#")]),s._v(" 八：Redis实现缓存餐厅数据")]),s._v(" "),n("h3",{attrs:{id:"一-需求分析-缓存的数据-必须保证mysql也有一份"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-需求分析-缓存的数据-必须保证mysql也有一份"}},[s._v("#")]),s._v(" (一)：需求分析：缓存的数据，必须保证MySQL也有一份")]),s._v(" "),n("ul",[n("li",[s._v("使用什么数据结构做缓存")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("一般Redis作为缓存，常用的有两种结构：string类型，hash类型：\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("：string类型：结构比较简单，例如用户信息")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("用户名，昵称，头像，年龄等"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("，写入时需要序列化，读取时需要反序列化，如果数据量比较小，可以忽略这种序列化的开销，适合固定数据结构，且数据量较小的数据缓存\n\n\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：hash类型：hash在写入和读取都没有序列化的开销，适合存储数据量较大，且经常变换的数据类型\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ul",[n("li",[s._v("餐厅表")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：餐厅表"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\nname：餐厅英文名称\ncnname：餐厅中文名称\nx：经度\ny：维度\nlocation：英文位置信息\ncnlocation：中文位置信息\narea：商圈\ntelephone：电话\nemail：邮箱\nwebsite：餐厅网址\ncuisine：菜系\naverage_price：均价\nintroduction：介绍\nthumbnail：缩略图\nlike_votes：喜欢数量\ndislike_votes：不喜欢数量\ncity_id：城市id\nis_valid：是否有效\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h3",{attrs:{id:"二-写缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-写缓存"}},[s._v("#")]),s._v(" (二)：写缓存")]),s._v(" "),n("ul",[n("li",[s._v("将餐厅数据加入缓存：加入缓存的方式有两种 "),n("code",[s._v("全量添加")]),s._v("、"),n("code",[s._v("增量添加")])])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("全量添加：\n\t在某些特殊情况下，例如初始化数据异常，缓存出现异常，需要及时将数据进行同步，这是需要全量添加，全量添加为了提高写入Redis的性能，需要使用pipeline管道，降低命令来回传输的性能开销\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("当用户对某个餐厅喜欢和不喜欢进行选择的时候，需要先操作MySQL的餐厅表的"),n("code",[s._v("like_votes字段")]),s._v("，再同步字段数据到Redis中")])]),s._v(" "),n("h3",{attrs:{id:"三-读缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-读缓存"}},[s._v("#")]),s._v(" (三)：读缓存")]),s._v(" "),n("ul",[n("li",[s._v("缓存的失效时间需要按照业务实际情况设定，避免"),n("code",[s._v("缓存击穿")]),s._v("，直接将请求打到MySQL。下面是读取Redis缓存数据的逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：根据restaurantId创建key\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：查询key对应的hash类型数据\n\t①：如果Redis中不存在，则查询数据库\n\t\ti：如果数据库不为空，先写入缓存，且设置过期时间，再返回数据\n\t\tii：如果数据库为空，也写入缓存，让缓存的值为空，且设置过期时间，再返回数据\n\t②：如果Redis中数据存在，延长缓存失效时间，再返回数据\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"九-redis实现缓存餐厅评论"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#九-redis实现缓存餐厅评论"}},[s._v("#")]),s._v(" 九：Redis实现缓存餐厅评论")]),s._v(" "),n("h3",{attrs:{id:"一-使用mysql存储-缓存的数据-必须保证mysql也有一份"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-使用mysql存储-缓存的数据-必须保证mysql也有一份"}},[s._v("#")]),s._v(" (一)：使用MySQL存储：缓存的数据，必须保证MySQL也有一份")]),s._v(" "),n("ul",[n("li",[s._v("餐厅评论表设计")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：评论表"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\nfk_restaurant_id：餐厅"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\ncontent：评论内容\nfk_diner_id：用户"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("\nlike_id：是否喜欢\nis_valid：是否有效\ncreate_date：创建日期\nupdate_date：更新日期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("写入数据逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：获取餐厅"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("、用户"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ID")]),s._v("、评论内容\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：写入到数据库\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("查询")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("select id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("fk_restaurant_id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("content from table where is_valid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" order by create_date desc limit "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"二-使用redis作为评论数据的缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-使用redis作为评论数据的缓存"}},[s._v("#")]),s._v(" (二)：使用Redis作为评论数据的缓存")]),s._v(" "),n("ul",[n("li",[s._v("使用Redis的 list数据类型存储评论数据")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("添加：将评论数据lpush key value 写入队列\n查询：lrange key "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" 查询前"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("条数据\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("修改和删除缓存就会相对比较麻烦")])]),s._v(" "),n("h3",{attrs:{id:"三-给餐厅添加评论"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-给餐厅添加评论"}},[s._v("#")]),s._v(" (三)：给餐厅添加评论")]),s._v(" "),n("ul",[n("li",[s._v("业务逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：判断餐厅id是否存在\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：将评论数据写入到数据库\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：写入评论数据到Redis中，这里评论数据永不过期\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"三-查询餐厅评论"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-查询餐厅评论"}},[s._v("#")]),s._v(" (三)：查询餐厅评论")]),s._v(" "),n("ul",[n("li",[s._v("业务逻辑")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：从Redis的lish中获取前"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("条数据\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：由于都是字符串，需要对字符串数据进行解析，例如用户信息和餐厅信息\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：然后返回\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"四-多级评论的设计思考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-多级评论的设计思考"}},[s._v("#")]),s._v(" (四)：多级评论的设计思考")]),s._v(" "),n("ul",[n("li",[s._v("再设计一张评论回复表")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("id：评论回复表id\nfk_review_id：回复某个评论的id\nfk_reply_id：\nfk_reply_diner_id：回复谁的id\nfk_diner_id：发表评论的人的id\nfk_content：评论内容\ngrade：层级\nis_valid：是否合法\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("对于评论系统需要思考的是：是做一个功能，还是做一个系统")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("如果只是做某个功能，那么只针对某一个对象做评论，可以基于这个思想进行\n\n如果是做一个评论系统，那么就需要设计多张表，评论系统可以针对任意对象进行评论\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"十-redis实现缓存异常问题解决"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十-redis实现缓存异常问题解决"}},[s._v("#")]),s._v(" 十：Redis实现缓存异常问题解决")]),s._v(" "),n("h3",{attrs:{id:"一-缓存击穿"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-缓存击穿"}},[s._v("#")]),s._v(" (一)：缓存击穿")]),s._v(" "),n("ul",[n("li",[s._v("原因：指缓存和数据库中都没有的数据，而用户不断发起请求，例如id为"),n("code",[s._v("-1")]),s._v("的的请求")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：创建临时空值缓存\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：服务降级\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"二-缓存穿透"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-缓存穿透"}},[s._v("#")]),s._v(" (二)：缓存穿透")]),s._v(" "),n("ul",[n("li",[s._v("原因：指缓存中没有但数据库中有的数据，一般是缓存过期造成")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：布隆过滤器\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：异步更新\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：服务降级\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：互斥锁\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"三-缓存雪崩"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-缓存雪崩"}},[s._v("#")]),s._v(" (三)：缓存雪崩")]),s._v(" "),n("ul",[n("li",[s._v("解决方法：所有的缓存同时过期")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：随机失效时间\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：服务降级\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：互斥锁\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"四-缓存淘汰"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-缓存淘汰"}},[s._v("#")]),s._v(" (四)：缓存淘汰")]),s._v(" "),n("ul",[n("li",[s._v("在redis.conf中，设置最大内存参数")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("maxmemory "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("mb\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("如果超过了最大内存限制，Redis会使用内存淘汰策略，Redis有8中内存淘汰策略。默认是不淘汰，生成环境使用最多的是"),n("code",[s._v("volatile-lru")]),s._v("策略")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("maxmemory"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("policy noeviction\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"十一-redis-总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#十一-redis-总结"}},[s._v("#")]),s._v(" 十一：Redis 总结")]),s._v(" "),n("h3",{attrs:{id:"一-应用场景总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-应用场景总结"}},[s._v("#")]),s._v(" (一)：应用场景总结")]),s._v(" "),n("ul",[n("li",[s._v("不同业务场景使用的Redis数据类型")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：单点登录：String类型，存储token和登录用户信息\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("：抢购优惠券：Hash类型，防止超卖、限购")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("分布式锁")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("多进程"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Redis事务")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("多线程"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：好友功能：Set类型，主要存储关注集合，粉丝集合\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：Feed功能：Sorted Set类型，关注人的Feed流\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：签到功能：Bitmap\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("：积分排行榜：Sorted Set类型，用户积分排序\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("：附近人：Geo类型，计算地理位置信息\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("：餐厅缓存：Hash类型，存储餐厅热点数据\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("：最新餐厅评论：List类型，存储最新餐厅评论\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h3",{attrs:{id:"二-应用性能总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-应用性能总结"}},[s._v("#")]),s._v(" (二)：应用性能总结")]),s._v(" "),n("ul",[n("li",[s._v("客户端优化")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：pipeline\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：连接池\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("设置合理的内存淘汰机制")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：设置合理的最大使用内存大小\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：给key设置合理过期时间\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：选择合适的淘汰算法\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[s._v("key的设计")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：业务名"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("表明"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("id\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);