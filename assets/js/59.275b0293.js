(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{2156:function(n,s,t){"use strict";t.r(s);var a=t(9),e=Object(a.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h2",{attrs:{id:"一-jaeger-链路追踪"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-jaeger-链路追踪"}},[n._v("#")]),n._v(" 一：Jaeger 链路追踪")]),n._v(" "),a("h3",{attrs:{id:"一-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-安装"}},[n._v("#")]),n._v(" (一)：安装")]),n._v(" "),a("ul",[a("li",[n._v("使用docker安装")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("docker run -d --name jaeger \\\n  -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 \\\n  -p 5775:5775/udp \\\n  -p 6831:6831/udp \\\n  -p 6832:6832/udp \\\n  -p 5778:5778 \\\n  -p 16686:16686 \\\n  -p 14268:14268 \\\n  -p 14250:14250 \\\n  -p 9411:9411 \\\n  jaegertracing/all-in-one:1.23\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br")])]),a("h2",{attrs:{id:"二-jaeger-架构介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-jaeger-架构介绍"}},[n._v("#")]),n._v(" 二：Jaeger 架构介绍")]),n._v(" "),a("h3",{attrs:{id:"一-概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-概念"}},[n._v("#")]),n._v(" (一)：概念")]),n._v(" "),a("ul",[a("li",[n._v("受Dapper和OpenZipkin启发的Jaeger是由Uber Technologies作为开源发布的分布式跟踪系统。它用于监视和诊断基于微服务的分布式系统，包括：")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("1：分布式上下文传播\n2：分布式交易监控\n3：根本原因分析\n4：服务依赖性分析性能/延迟优化\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("ul",[a("li",[n._v("支持原生的opentracing")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("Jaeger后端，Web UI和工具库已完全设计为支持OpenTracing标准。\n\n\t1:通过跨度引用将迹线表示为有向无环图（不仅是树）\n\t2:支持强类型的跨度标签和结构化日志通过行李\n\t3:支持通用的分布式上下文传播机制\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br")])]),a("ul",[a("li",[n._v("多端数据库支持")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\tJaeger支持两个流行的开源NoSQL数据库作为跟踪存储后端：Cassandra 3.4+和Elasticsearch 5.x / 6.x / 7.x。正在进行使用其他数据库的社区实验，例如ScyllaDB，InfluxDB，Amazon DynamoDB。Jaeger还附带了一个简单的内存存储区，用于测试设置\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("现代化UI")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\tJaeger Web UI是使用流行的开源框架（如React）以Javascript实现的。v1.0中发布了几项性能改进，以允许UI有效处理大量数据，并显示具有成千上万个跨度的跟踪（例如，我们尝试了具有80,000个跨度的跟踪）\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("云原生部署")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\tJaeger后端作为Docker映像的集合进行分发。这些二进制文件支持各种配置方法，包括命令行选项，环境变量和多种格式（yaml，toml等）的配置文件。Kubernetes模板和Helm图表有助于将其部署到Kubernetes集群\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("可观察性")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t默认情况下，所有Jaeger后端组件都公开Prometheus指标（也支持其他指标后端）。使用结构化日志库zap将日志写到标准输出\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("h3",{attrs:{id:"二-架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-架构"}},[n._v("#")]),n._v(" (二)：架构")]),n._v(" "),a("ul",[a("li",[n._v("Span表示Jaeger中的逻辑工作单元，具有操作名称，操作的开始时间和持续时间。跨度可以嵌套并排序以建立因果关系模型。")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(620),alt:"Alt text"}})]),n._v(" "),a("ul",[a("li",[n._v("Agent")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\tJaeger代理是一个网络守护程序，它侦听通过UDP发送的跨度，然后将其分批发送给收集器。它旨在作为基础结构组件部署到所有主机。该代理将收集器的路由和发现抽象到远离客户端的位置。\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("Collector")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("Jaeger收集器从Jaeger代理接收跟踪，并通过处理管道运行它们。当前，我们的管道会验证跟踪，为其建立索引，执行任何转换并最终存储它们。Jaeger的存储设备是可插拔组件，目前支持Cassandra，Elasticsearch和Kafka。\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("Query")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("查询是一项从存储中检索跟踪并托管UI来显示跟踪的服务。\n\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("ul",[a("li",[n._v("Ingester")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("Ingester is a service that reads from Kafka topic and writes to another storage backend (Cassandra, Elasticsearch)\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("Sampling")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("Jaeger库实现了一致的前期（或基于头）的采样。例如，假设我们有一个简单的调用图，其中服务A调用服务B，服务B调用服务C：A-> B->C。当服务A收到不包含跟踪信息的请求时，Jaeger跟踪器将开始新的跟踪，为其分配一个随机跟踪ID，然后根据当前安装的采样策略做出采样决定。采样决策将与请求一起传播到B和C，因此这些服务将不会再次做出采样决策，而是会尊重顶级服务A做出的决策。这种方法保证了，如果对跟踪进行了采样，则所有其跨度将记录在后端。如果每个服务都做出自己的抽样决定，那么我们很少会在后端获得完整的跟踪。\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("h2",{attrs:{id:"三-python中使用jaeger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-python中使用jaeger"}},[n._v("#")]),n._v(" 三：Python中使用jaeger")]),n._v(" "),a("ul",[a("li",[n._v("安装客户端")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("# 使用 jaeger-client-python这个库\npip install jaeger-client\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("h3",{attrs:{id:"一-将download函数的tracing数据发送到jaeger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-将download函数的tracing数据发送到jaeger"}},[n._v("#")]),n._v(" (一)：将download函数的tracing数据发送到jaeger")]),n._v(" "),a("ul",[a("li",[n._v("单个函数发送日志到jaeger")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("import requests\nimport logging\nimport time\nfrom random import randint\nfrom jaeger_client import Config\n\ndef download():\n    rsp = requests.get(\"https://www.baidu.com\")\n    return rsp\n\nif __name__ == \"__main__\":\n\n    log_level = logging.DEBUG\n    logging.getLogger('').handlers = []\n    logging.basicConfig(format='%(asctime)s %(message)s', level=log_level)\n\n    # 这里可以从nacos中读取\n    config = Config(\n        config={\n            'sampler': {\n                'type': 'const', #全部\n                'param': 1, #1 开启全部采样 0 表示关闭全部采样\n            },\n            'local_agent': {  # 指定将日志打到jaeger中\n              'reporting_host':'192.168.100.203',\n              'reporting_port': '6831',\n            },\n            'logging': True,\n        },\n        service_name='ipfsmain', # 这是给服务指定的名称\n        validate=True,\n    )\n\n    # 初始化一个tracer， tracer是一个链\n    tracer = config.initialize_tracer()\n\n    with tracer.start_span('get') as get_span:\n        # 这里的函数要调用\n        download()\n\n\n    time.sleep(2)\n    tracer.close()\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br")])]),a("h3",{attrs:{id:"二-让span具有层级关系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-让span具有层级关系"}},[n._v("#")]),n._v(" (二)：让span具有层级关系")]),n._v(" "),a("ul",[a("li",[n._v("span的追踪可以具有层级关系的，也就是说，可以一层一层的执行过程进行分析")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("import requests\nimport logging\nimport time\nfrom random import randint\nfrom jaeger_client import Config\n\n\ndef download():\n    rsp = requests.get(\"https://www.baidu.com\")\n    return rsp\n\n\ndef parser():\n    time.sleep(randint(1, 9) * 0.1)\n\n\ndef insert_to_mysql(parent_span):\n    #1. 生成sql的时间\n    with tracer.start_span('prepare', child_of=parent_span) as prepare_span:\n        time.sleep(randint(1, 9) * 0.1)\n\n    #2. 插入数据库的时间\n    with tracer.start_span('execute', child_of=parent_span) as execute_span:\n        time.sleep(randint(1, 9) * 0.1)\n\n\nif __name__ == \"__main__\":\n\n    log_level = logging.DEBUG\n    logging.getLogger('').handlers = []\n    logging.basicConfig(format='%(asctime)s %(message)s', level=log_level)\n\n    # 这里可以从nacos中读取\n    config = Config(\n        config={\n            'sampler': {\n                'type': 'const', #全部\n                'param': 1, #1 开启全部采样 0 表示关闭全部采样\n            },\n            'local_agent': {  # 指定将日志打到jaeger中\n              'reporting_host':'192.168.100.203',\n              'reporting_port': '6831',\n            },\n            'logging': True,\n        },\n        service_name='ipfsmain', # 这是给服务指定的名称\n        validate=True,\n    )\n\n    # 初始化一个tracer， tracer是一个链\n    tracer = config.initialize_tracer()\n\n    # with tracer.start_span('get') as get_span:\n    #     # 这里的函数要调用\n    #     download()\n\n    with tracer.start_span(\"spider\") as spider_span:\n\n        # 这个span是spider下的子span\n        with tracer.start_span('get', child_of=spider_span) as get_span:\n            # 这里的函数要调用\n            download()\n\n        #解析\n        with tracer.start_span('parser', child_of=spider_span) as parser_span:\n            parser()\n\n        # 入库\n        with tracer.start_span('insert', child_of=spider_span) as insert_span:\n            # 这里把父span传递进来了\n            insert_to_mysql(insert_span)\n    \n    # 这里必须等待日志发送到jaeger中\n    time.sleep(2)\n    tracer.close()\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br")])]),a("ul",[a("li",[n._v("访问"),a("code",[n._v("http://192.168.100.203:16686/")]),n._v("，找到"),a("code",[n._v("ipfsmain")]),n._v("这个service，可以发现调用的事件消耗")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(621),alt:"Alt text"}})]),n._v(" "),a("h3",{attrs:{id:"三-在grpc中使用jaegle-使用github中grpc-ecosystem-grpc-opentracing库中grpc-opentracing-python-grpc-opentracing目录-将这个目录拷贝到项目中"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-在grpc中使用jaegle-使用github中grpc-ecosystem-grpc-opentracing库中grpc-opentracing-python-grpc-opentracing目录-将这个目录拷贝到项目中"}},[n._v("#")]),n._v(" (三)：在grpc中使用jaegle(使用GitHub中grpc-ecosystem/grpc-opentracing库中grpc-opentracing/python/grpc_opentracing目录，将这个目录拷贝到项目中)")]),n._v(" "),a("p",[a("img",{attrs:{src:t(622),alt:"Alt text"}})]),n._v(" "),a("ul",[a("li",[a("p",[n._v("这里把Python实现的代码下载到项目中，这里实现链路追踪最核心的概念在于"),a("code",[n._v("使用了grpc 的metadate，将spancontext注入到metadata中，使得span可以从grpc调用端一直沿用到服务器端")])])]),n._v(" "),a("li",[a("p",[n._v("这是server.py代码，在方法里面，获取了父span，将父span与子span合并")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("from concurrent import futures\nimport logging\nimport grpc\nimport time\nfrom test.proto import helloworld_pb2_grpc, helloworld_pb2\n# 导入服务器端的\nfrom grpc_opentracing import open_tracing_server_interceptor\nfrom grpc_opentracing.grpcext import intercept_server\nfrom jaeger_client import Config\n\n\n\n# 日志级别\nlog_level = logging.DEBUG\nlogging.getLogger('').handlers = []\nlogging.basicConfig(format='%(asctime)s %(message)s', level=log_level)\n\n# 这里可以从nacos中读取\nconfig = Config(\n    config={\n        'sampler': {\n            'type': 'const', #全部\n            'param': 1, #1 开启全部采样 0 表示关闭全部采样\n        },\n        'local_agent': {  # 指定将日志打到jaeger中\n          'reporting_host':'192.168.100.203',\n          'reporting_port': '6831',\n        },\n        'logging': True,\n    },\n    service_name='ipfsmain-srv', # 这是给服务指定的名称\n    validate=True,\n)\n\n# 初始化一个tracer， tracer是一个链\ntracer = config.initialize_tracer()\n\n\nclass Greeter(helloworld_pb2_grpc.GreeterServicer):\n    def SayHello(self, request, context):\n        # 获取客户端的span，将链拼凑在一起\n        with tracer.start_span('execute', child_of=context.get_active_span()) as excute_span:\n\t        time.sleep(1)\n            pass\n        return helloworld_pb2.HelloReply(message=\"你好....... {}\".format(request.name))\n\n\nif __name__ == '__main__':\n\n    # 创建拦截器\n    tracing_interceptor = open_tracing_server_interceptor(tracer)\n    # 创建server\n    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10), )\n    # 创建带拦截器的server\n    server = intercept_server(server, tracing_interceptor)\n\n    helloworld_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)\n    server.add_insecure_port('localhost:18080')\n    server.start()\n    server.wait_for_termination()\n    tracer.close()\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br")])]),a("ul",[a("li",[n._v("客户端调用grpc接口的时候，显示如下, 结果显示：【ipfsmain-srv】这个服务的时间损耗都集中在grpc调用上")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(623),alt:"Alt text"}})]),n._v(" "),a("h2",{attrs:{id:"四-golang中使用jaeger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-golang中使用jaeger"}},[n._v("#")]),n._v(" 四：Golang中使用jaeger")]),n._v(" "),a("ul",[a("li",[n._v("安装客户端")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('# 使用 jaeger-client-go这个库\nimport "github.com/uber/jaeger-client-go"\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("h3",{attrs:{id:"一-测试在golang代码中-统计add任务执行消耗时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-测试在golang代码中-统计add任务执行消耗时间"}},[n._v("#")]),n._v(" (一)：测试在golang代码中，统计add任务执行消耗时间")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import (\n\t"fmt"\n\t"github.com/uber/jaeger-client-go"\n\tjaegercfg "github.com/uber/jaeger-client-go/config"\n\t"time"\n)\n\nfunc add(a, b int)  {\n\ttime.Sleep(time.Second * 2)\n\tfmt.Println(a + b)\n}\n\nfunc main() {\n\tcfg := jaegercfg.Configuration{\n\t\tSampler: &jaegercfg.SamplerConfig{\n\t\t\tType:  jaeger.SamplerTypeConst,\n\t\t\tParam: 1,\n\t\t},\n\t\tReporter: &jaegercfg.ReporterConfig{\n\t\t\tLogSpans: true,\n\t\t\t// 设置jaeger的地址\n\t\t\tLocalAgentHostPort: "192.168.100.203:6831",\n\t\t},\n\t\tServiceName: "ipfsmain-web",\n\t}\n\n\t// 获取tracer\n\ttracer, closer, err := cfg.NewTracer(jaegercfg.Logger(jaeger.StdLogger))\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tdefer closer.Close()\n\n\tspan := tracer.StartSpan("go-grpc-web")\n\n\tadd(1,2)  // 统计add函数执行消耗的时间\n\n\tdefer span.Finish()\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br")])]),a("h3",{attrs:{id:"二-统计golang中grpc调用时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-统计golang中grpc调用时间"}},[n._v("#")]),n._v(" (二)：统计Golang中GRPC调用时间")]),n._v(" "),a("ul",[a("li",[n._v("依然使用"),a("code",[n._v("grpc-ecosystem/grpc-opentracing")]),n._v("库中，go的代码库otgrpc，下载到项目中")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(624),alt:"Alt text"}})]),n._v(" "),a("ul",[a("li",[n._v("在test代码中，开发client.go端的grpc tracer，将调用耗时发送到jaeger中")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import (\n\t"all-server/order_web/utils/otgrpc"\n\t"all-server/test/test4/proto"\n\t"context"\n\t"fmt"\n\t"github.com/opentracing/opentracing-go"\n\t"github.com/uber/jaeger-client-go"\n\tjaegercfg "github.com/uber/jaeger-client-go/config"\n\t"google.golang.org/grpc"\n)\n\nfunc main() {\n\n\t// 生成tracer\n\tcfg := jaegercfg.Configuration{\n\t\tSampler: &jaegercfg.SamplerConfig{\n\t\t\tType:  jaeger.SamplerTypeConst,\n\t\t\tParam: 1,\n\t\t},\n\t\tReporter: &jaegercfg.ReporterConfig{\n\t\t\tLogSpans: true,\n\t\t\t// 设置jaeger的地址\n\t\t\tLocalAgentHostPort: "192.168.100.203:6831",\n\t\t},\n\t\tServiceName: "ipfsmain-web",\n\t}\n\n\t// 获取tracer\n\ttracer, closer, err := cfg.NewTracer(jaegercfg.Logger(jaeger.StdLogger))\n\topentracing.SetGlobalTracer(tracer)  // 将tracer进行全局化\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tdefer closer.Close()\n\n\t// 调用grpc接口\n\tvar opts []grpc.DialOption\n\topts = append(opts, grpc.WithInsecure())\n\t// 将tracer加入到拦截器, opentracing.GlobalTracer()是获取传递进来的tracer\n\topts = append(opts, grpc.WithUnaryInterceptor(otgrpc.OpenTracingClientInterceptor(opentracing.GlobalTracer())))\n\tconn, err := grpc.Dial("127.0.0.1:18080", opts...)\n\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tdefer conn.Close()\n\n\tc := proto.NewGreeterClient(conn)\n\tr, err := c.SayHello(context.Background(), &proto.HelloRequest{\n\t\tName: "Robby",\n\t})\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\n\tfmt.Printf("%s", r.Message)\n\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br")])]),a("ul",[a("li",[n._v("jaeger中显示的效果如下")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(625),alt:"Alt text"}})]),n._v(" "),a("h3",{attrs:{id:"三-在gin框架中-使用jaeger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-在gin框架中-使用jaeger"}},[n._v("#")]),n._v(" (三)：在gin框架中，使用jaeger")]),n._v(" "),a("ul",[a("li",[a("p",[n._v("在路由中，添加一个"),a("code",[n._v("Trace中间件")]),n._v("，在这个中间件中创建一个span起点，并且将这个span添加到gin的context中")])]),n._v(" "),a("li",[a("p",[n._v("创建goods/middleware/tracing.go")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: tracing.go\n * @Create date: 2021-06-30\n * @Function:\n **/\n\npackage middleware\n\nimport (\n\t"all-server/goods_web/global"\n\t"fmt"\n\t"github.com/gin-gonic/gin"\n\t"github.com/uber/jaeger-client-go"\n\tjaegercfg "github.com/uber/jaeger-client-go/config"\n)\n\n// Trace 添加一个链路追踪\nfunc Trace() gin.HandlerFunc {\n\treturn func(context *gin.Context) {\n\t\taddr := fmt.Sprintf("%s:%d", global.Conf.JaegerConfig.Host, global.Conf.JaegerConfig.Port)\n\t\tfmt.Println(addr)\n\t\t// 生成tracer\n\t\tcfg := jaegercfg.Configuration{\n\t\t\tSampler: &jaegercfg.SamplerConfig{\n\t\t\t\tType:  jaeger.SamplerTypeConst,\n\t\t\t\tParam: 1,\n\t\t\t},\n\t\t\tReporter: &jaegercfg.ReporterConfig{\n\t\t\t\tLogSpans: true,\n\t\t\t\t// 设置jaeger的地址\n\t\t\t\tLocalAgentHostPort: fmt.Sprintf("%s:%d", global.Conf.JaegerConfig.Host, global.Conf.JaegerConfig.Port),\n\t\t\t},\n\t\t\t// 服务名称\n\t\t\tServiceName: global.Conf.JaegerConfig.Name,\n\t\t}\n\n\t\t// 获取tracer\n\t\ttracer, closer, err := cfg.NewTracer(jaegercfg.Logger(jaeger.StdLogger))\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n\t\tdefer closer.Close()\n\n\t\t// 将url请求的路径，作为span的起点名称\n\t\tstartSpan := tracer.StartSpan(context.Request.URL.Path)\n\t\tdefer startSpan.Finish()\n\t\t\n\t\t// 将gaeger的tracer和parentSpan封装在context中，为后续grpc调用中，子链路耗时统计提供数据\n\t\tcontext.Set("tracer", tracer)\n\t\tcontext.Set("parentSpan", startSpan)\n\t\tcontext.Next()\n\n\t}\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br")])]),a("ul",[a("li",[n._v("将这个"),a("code",[n._v("Trace")]),n._v("中间件，添加到每一个路由中，例如添加到"),a("code",[n._v("/g/v1/goods/这个路径下")]),n._v("，让请求这个路径的时候，将请求耗时写入到jaeger中")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func InitGoodsRouter(Router *gin.RouterGroup){\n\t// 请求添加Trace中间件\n\tGoodsRouter := Router.Group("goods").Use(middleware.Trace())\n\t{\n\t\tGoodsRouter.GET("", goods.List) //商品列表\n\t\tGoodsRouter.POST("", middleware.JWTAuth(), middleware.IsAdminAuth(), goods.New) //改接口需要管理员权限\n\t\tGoodsRouter.GET("/:id", goods.Detail) //获取商品的详情\n\t\tGoodsRouter.DELETE("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.Delete) //删除商品\n\t\tGoodsRouter.GET("/:id/stocks", goods.Stocks) //获取商品的库存\n\n\t\tGoodsRouter.PUT("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.Update)  // 修改商品的全部属性\n\t\tGoodsRouter.PATCH("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.UpdateStatus)  // 修改商品的部分属性\n\t}\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br")])]),a("ul",[a("li",[n._v("在yapi中，请求一下商品列表，在jaeger记录如下（这里只有/g/v1/goods的耗时记录，但是并没有商品列表调用grpc的耗时记录，所以需要以/g/v1/goods为parentSpan，将grpc的耗时记录作为子span即可）")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(626),alt:"Alt text"}})]),n._v(" "),a("h3",{attrs:{id:"四-在gin-grpc框架中-使用jaeger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-在gin-grpc框架中-使用jaeger"}},[n._v("#")]),n._v(" (四)：在gin + grpc框架中，使用jaeger")]),n._v(" "),a("ul",[a("li",[a("p",[n._v("上面在gin框架中，在路由的拦截器中，添加了一个Trace拦截器，可以捕获到/g/v1/goods接口的耗时，但是内部的grpc的耗时没有捕获到，因此这里需要在grpc.Dail拨号的时候，也创建一个拦截器，在拦截器中，获取到gin框架的context对象(在调用grpc接口时候，会基于context封装gin框架的context对象，在otgrpc.OpenTracingClientInterceptor拦截器中，会捕获到context对象，并且提取出gin框架的context对象，进一步提取jaeger的tracer和parentSpan)")])]),n._v(" "),a("li",[a("p",[n._v("第一步：需要修改goods_web/utils/otgrpc/client.go中"),a("code",[n._v("OpenTracingClientInterceptor")]),n._v("拦截器的代码，在拦截器中需要捕获调用grpc接口时候，传递的context对象")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func OpenTracingClientInterceptor(tracer opentracing.Tracer, optFuncs ...Option) grpc.UnaryClientInterceptor {\n\totgrpcOpts := newOptions()\n\totgrpcOpts.apply(optFuncs...)\n\treturn func(\n\t\tctx context.Context,\n\t\tmethod string,\n\t\treq, resp interface{},\n\t\tcc *grpc.ClientConn,\n\t\tinvoker grpc.UnaryInvoker,\n\t\topts ...grpc.CallOption,\n\t) error {\n\t\tvar err error\n\t\tvar parentCtx opentracing.SpanContext\n\n\t\tif parent := opentracing.SpanFromContext(ctx); parent != nil {\n\t\t\tparentCtx = parent.Context()\n\t\t}\n\n\t\t// Todo: 修改源码, 这里主要是获取到context中，传递进来的ginContext\n\t\tginContext := ctx.Value("ginContext")\n\t\t// 判断ginContext的类型，获取到ginContext中传递进来的tracer和parentSpan\n\t\tswitch ginContext.(type) {\n\t\tcase *gin.Context:\n\t\t\tif iTracer, ok := ginContext.(*gin.Context).Get("tracer"); ok {\n\t\t\t\t// 这里覆盖掉了传递进来的tracer，使用ginContext中添加的tracer\n\t\t\t\ttracer = iTracer.(opentracing.Tracer)\n\t\t\t}\n\n\t\t\tif iParentSpan, ok := ginContext.(*gin.Context).Get("parentSpan"); ok {\n\t\t\t\t// 将这个span的值覆盖掉，使用Trace中间件中创建的parentSpan\n\t\t\t\tparentCtx = iParentSpan.(*jaegerClient.Span).Context() // 获取SpanContext, 作为parentCtx\n\t\t\t}\n\t\t}\n\n\t\tif otgrpcOpts.inclusionFunc != nil &&\n\t\t\t!otgrpcOpts.inclusionFunc(parentCtx, method, req, resp) {\n\t\t\treturn invoker(ctx, method, req, resp, cc, opts...)\n\t\t}\n\t\tclientSpan := tracer.StartSpan(\n\t\t\tmethod,\n\t\t\topentracing.ChildOf(parentCtx),\n\t\t\text.SpanKindRPCClient,\n\t\t\tgRPCComponentTag,\n\t\t)\n\t\tdefer clientSpan.Finish()\n\t\tctx = injectSpanContext(ctx, tracer, clientSpan)\n\t\tif otgrpcOpts.logPayloads {\n\t\t\tclientSpan.LogFields(log.Object("gRPC request", req))\n\t\t}\n\t\terr = invoker(ctx, method, req, resp, cc, opts...)\n\t\tif err == nil {\n\t\t\tif otgrpcOpts.logPayloads {\n\t\t\t\tclientSpan.LogFields(log.Object("gRPC response", resp))\n\t\t\t}\n\t\t} else {\n\t\t\tSetSpanTags(clientSpan, err, true)\n\t\t\tclientSpan.LogFields(log.String("event", "error"), log.String("message", err.Error()))\n\t\t}\n\t\tif otgrpcOpts.decorator != nil {\n\t\t\totgrpcOpts.decorator(clientSpan, method, req, resp, err)\n\t\t}\n\t\treturn err\n\t}\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br")])]),a("ul",[a("li",[n._v("第二步，在goods_web/initailize/srv_conn.go中，初始化grpc 客户端的时候，负载均衡拨号时，加上grpc的jaeger拦截器")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func InitSrvConn()  {\n\t// 在consul中获取的是服务名称, consul上的服务如果动态更新，那么这里的负载均衡也是一样，会动态调用\n\ttarget := fmt.Sprintf("consul://%s:%d/%s?wait=14s", global.Conf.ConsulConfig.Host, global.Conf.ConsulConfig.Port, global.Conf.GoodsSrvConfig.Name)\n\tconn, err := grpc.Dial(\n\t\ttarget,\n\t\tgrpc.WithInsecure(),\n\t\t// grpc的调用写在拦截器中, 这个拦截器会拦截到调用grpc接口时候，传递的context\n\t\tgrpc.WithUnaryInterceptor(otgrpc.OpenTracingClientInterceptor(opentracing.GlobalTracer())),\n\t\tgrpc.WithDefaultServiceConfig(`{"loadBalancingPolicy": "round_robin"}`),\n\t)\n\tif err != nil {\n\t\t// Fatal是打印日志后退出程序\n\t\tzap.L().Fatal("grpc.Dial Error", zap.Error(err))\n\t}\n\n\tGoodsSrvClient := proto.NewGoodsClient(conn)\n\tglobal.GoodsSrvClient = GoodsSrvClient\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br")])]),a("ul",[a("li",[n._v("第三步，如果需要捕获"),a("code",[n._v("/g/v1/goods/1")]),n._v("的商品详情调用的耗时情况，那么只需要在goods_web/api/goods/goods.go的"),a("code",[n._v("Detail")]),n._v("接口中，将context对象中封装gin的context对象。"),a("code",[n._v("其他的接口也是如此")])])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// Detail 商品详情\nfunc Detail(ctx *gin.Context)  {\n\tid := ctx.Param("id")\n\t// 字符串转换为int32, 第二个参数是进制数，例如10进制，8进制，第三个参数是类型，例如int32\n\ti, err := strconv.ParseInt(id, 10, 32)\n\tif err != nil {\n\t\tctx.Status(http.StatusNotFound)\n\t\treturn\n\t}\n\n\t//localCtx, cancel := context.WithTimeout(context.Background(), time.Second*3)\n\tlocalCtx := context.WithValue(context.Background(), "ginContext", ctx)\n\tgoodsSrvClient := global.GoodsSrvClient\n\n\tresp, err := goodsSrvClient.GetGoodsDetail(localCtx, &proto.GoodInfoRequest{\n\t\tId: int32(i),\n\t})\n\n\tif err != nil {\n\t\tapi.HandleGrpcErrorToHttp(ctx, err)\n\t\treturn\n\t}\n\t// 这里应该是使用结构体返回的，基于嵌套结构体\n\trsp := map[string]interface{}{\n\t\t"id":          resp.Id,\n\t\t"name":        resp.Name,\n\t\t"goods_brief": resp.GoodsBrief,\n\t\t"desc":        resp.GoodsDesc,\n\t\t"ship_free":   resp.ShipFree,\n\t\t"images":      resp.Images,\n\t\t"desc_images": resp.DescImages,\n\t\t"front_image": resp.GoodsFrontImage,\n\t\t"shop_price":  resp.ShopPrice,\n\t\t"ctegory": map[string]interface{}{\n\t\t\t"id":   resp.Category.Id,\n\t\t\t"name": resp.Category.Name,\n\t\t},\n\t\t"brand": map[string]interface{}{\n\t\t\t"id":   resp.Brand.Id,\n\t\t\t"name": resp.Brand.Name,\n\t\t\t"logo": resp.Brand.Logo,\n\t\t},\n\t\t"is_hot":  resp.IsHot,\n\t\t"is_new":  resp.IsNew,\n\t\t"on_sale": resp.OnSale,\n\t}\n\tctx.JSON(http.StatusOK, rsp)\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br")])]),a("ul",[a("li",[n._v("第四步，在goods_web/initailize/router.go中，给每个路由分组加上Trace中间件")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func InitGoodsRouter(Router *gin.RouterGroup){\n\t// 请求添加Trace中间件\n\tGoodsRouter := Router.Group("goods").Use(middleware.Trace())\n\t{\n\t\tGoodsRouter.GET("", goods.List) //商品列表\n\t\tGoodsRouter.POST("", middleware.JWTAuth(), middleware.IsAdminAuth(), goods.New) //改接口需要管理员权限\n\t\tGoodsRouter.GET("/:id", goods.Detail) //获取商品的详情\n\t\tGoodsRouter.DELETE("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.Delete) //删除商品\n\t\tGoodsRouter.GET("/:id/stocks", goods.Stocks) //获取商品的库存\n\n\t\tGoodsRouter.PUT("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.Update)  // 修改商品的全部属性\n\t\tGoodsRouter.PATCH("/:id",middleware.JWTAuth(), middleware.IsAdminAuth(), goods.UpdateStatus)  // 修改商品的部分属性\n\t}\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br")])]),a("ul",[a("li",[n._v("此时效果如下")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(627),alt:"Alt text"}})])])}),[],!1,null,null,null);s.default=e.exports},620:function(n,s,t){n.exports=t.p+"assets/img/2021-06-292.13.03.93f6e440.png"},621:function(n,s,t){n.exports=t.p+"assets/img/2021-06-293.44.59.b75df0bb.png"},622:function(n,s,t){n.exports=t.p+"assets/img/2021-07-058.47.50.054c4c0f.png"},623:function(n,s,t){n.exports=t.p+"assets/img/2021-06-309.45.20.960f43b3.png"},624:function(n,s,t){n.exports=t.p+"assets/img/2021-06-3011.09.03.274e8aaf.png"},625:function(n,s,t){n.exports=t.p+"assets/img/2021-06-3011.54.45.0d668977.png"},626:function(n,s,t){n.exports=t.p+"assets/img/2021-06-302.29.48.7fa2c2ed.png"},627:function(n,s,t){n.exports=t.p+"assets/img/2021-06-304.57.12.02c6b25f.png"}}]);