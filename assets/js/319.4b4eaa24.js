(window.webpackJsonp=window.webpackJsonp||[]).push([[319],{1841:function(s,e,n){s.exports=n.p+"assets/img/2019-09-151.42.31.1306b5f6.png"},2727:function(s,e,n){"use strict";n.r(e);var a=n(9),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一-service-对iptables或ipvs的调度方式控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-service-对iptables或ipvs的调度方式控制"}},[s._v("#")]),s._v(" 一：Service 对iptables或ipvs的调度方式控制")]),s._v(" "),a("p",[a("img",{attrs:{src:n(1841),alt:"Alt text"}})]),s._v(" "),a("h3",{attrs:{id:"一-service在k8s集群中的通信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-service在k8s集群中的通信"}},[s._v("#")]),s._v(" (一)service在k8s集群中的通信")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1：在k8s集群中，节点网络是配置在node网络接口上；pod网络是配置在pod资源上是软件模拟的；cluster网络是虚拟的，配置在service之上\n\n2：当一个Client Pod的请求发给Service的时候，Service会创建iptables或ipvs规则，将请求调度到其他的Server Pod上\n\n3：当一个Server Pod被创建或删除，kube-apiserver会将信息传递给kube-proxy，kube-proxy会将信息传递给Service，Service收到信息后直接修改iptables或ipvs规则\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ul",[a("li",[s._v("将k8s中之前创建的多个service删除")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("kubectl delete service myapp nginx redis\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("service的类型")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ExternalName，ClusterIP, NodePort, LoadBalancer\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"二-基于yaml文件创建一个clusterip的service资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-基于yaml文件创建一个clusterip的service资源"}},[s._v("#")]),s._v(" (二)基于yaml文件创建一个ClusterIP的service资源")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: redis\n  namespace: default\nspec:\n  # 设置匹配到的pod资源\n  selector:\n    app: redis\n    role: logstor\n  type: ClusterIP\n  ports:\n    # 这个端口是service的端口\n  - port: 6379\n    # 这个端口是容器的端口\n    targetPort: 6379\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("ul",[a("li",[s._v("基于yaml文件，创建service")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 创建service\nkubectl apply -f redis-service.yaml \n\n# 查看描述， Endpoints是service基于selector的定义匹配到的pod资源\n# service先将请求转发到Endpoints，Endpoints再将请求转发到后端的pods\nkubectl describe service redis\nName:              redis\nNamespace:         default\nLabels:            <none>\nAnnotations:       kubectl.kubernetes.io/last-applied-configuration:\n                     {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"name":"redis","namespace":"default"},"spec":{"ports":[{"port":6379,"targ...\nSelector:          app=redis,role=logstor\nType:              ClusterIP\nIP:                10.1.4.183\nPort:              <unset###  6379/TCP\nTargetPort:        6379/TCP\nEndpoints:         10.244.4.24:6379\nSession Affinity:  None\nEvents:            <none>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"三-基于yaml文件创建一个nodeport的service资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-基于yaml文件创建一个nodeport的service资源"}},[s._v("#")]),s._v(" (三) 基于yaml文件创建一个NodePort的service资源")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: myapp\n  namespace: default\nspec:\n  # 设置匹配到的pod资源\n  selector:\n    app: myapp\n    release: canary\n  type: NodePort\n  ports:\n    # 这个端口是service的端口，需要与容器暴露端口对应\n  - port: 80\n    # 这个端口是容器的端口，需要与容器定义的端口对应\n    targetPort: 80\n    # 这个是指定节点的端口, 这个端口的范围是：30000-32767\n    nodePort: 30080\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("ul",[a("li",[s._v("基于yaml文件，创建service资源")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 创建service\nkubectl apply -f myapp-service.yaml \n\n# 查看service, Endpoints必须有pod地址，才说明service的selector选择到了pod资源\nkubectl describe service myapp\nName:                     myapp\nNamespace:                default\nLabels:                   <none>\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration:\n                            {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"name":"myapp","namespace":"default"},"spec":{"ports":[{"nodePort":30080,...\nSelector:                 app=myapp,release=canary\nType:                     NodePort\nIP:                       10.1.126.228\nPort:                     <unset###  80/TCP\nTargetPort:               80/TCP\nNodePort:                 <unset###  30080/TCP\nEndpoints:                10.244.3.16:80,10.244.4.26:80\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <none>\n\n# 在k8s集群外部可以直接访问, 这里的调度策略是轮训的调度策略\ncurl http://192.168.43.201:30080/hostname.html\nmyapp-deploy-55b78d8548-xsz8x\n\n# 如果在yaml文件中spec字段中加入一个字段：sessionAffinity: ClientIP， 那么这个service的调度请求的方式将会使得同一个客户端的IP始终转发到同一个pod上， 这个sessionAffinity字段的默认值是None\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h3",{attrs:{id:"四-基于yaml文件创建一个headless的service资源-这种service是clusterip类型的service的一种"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-基于yaml文件创建一个headless的service资源-这种service是clusterip类型的service的一种"}},[s._v("#")]),s._v(" (四)基于yaml文件创建一个headless的service资源, 这种service是ClusterIP类型的service的一种")]),s._v(" "),a("ul",[a("li",[s._v("之前创建的service都是基于service本身，将请求调度到pod上，可以根据kube-dns解析到service名称的IP地址")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 查看kube-dns的IP\nkubectl get services -n kube-system\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE\nkube-dns   ClusterIP   10.1.0.10    <none###        53/UDP,53/TCP,9153/TCP   4d21h\n\n# 使用dig命令指定dns为kube-dns地址，解析service的名称， 解析的地址就是当前service的地址\ndig -t A myapp.default.svc.cluster.local @10.1.0.10\n;; ANSWER SECTION:\nmyapp.default.svc.cluster.local. 30 IN  A       10.1.126.228\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("ul",[a("li",[s._v("创建一个headless的service")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("apiVersion: v1\nkind: Service\nmetadata:\n  name: myapp-headless\n  namespace: default\nspec:\n  # 设置匹配到的pod资源\n  selector:\n    app: myapp\n    release: canary\n  clusterIP: None\n  ports:\n    # 这个端口是service的端口\n  - port: 80\n    # 这个端口是容器的端口\n    targetPort: 80\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("ul",[a("li",[s._v("基于yaml文件，创建service")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 创建\nkubectl apply -f  myapp-headless-service.yaml \n\n# 查看service\nkubectl get service\nNAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE\nmyapp-headless   ClusterIP   None           <none###        80/TCP         15s\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ul",[a("li",[s._v("基于kube-dns解析myapp-headless service的时候，发现IP是service选择的pod的IP地址")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 解析\ndig -t A myapp-headless.default.svc.cluster.local @10.1.0.10\n;; ANSWER SECTION:\nmyapp-headless.default.svc.cluster.local. 30 IN A 10.244.4.26\nmyapp-headless.default.svc.cluster.local. 30 IN A 10.244.3.16\n\n# 查看pod的IP\nkubectl get pods -o wide\nNAME                            READY   STATUS    RESTARTS   AGE   IP            NODE      NOMINATED NODE   READINESS GATES\nmyapp-deploy-55b78d8548-68xgj   1/1     Running   0          77m   10.244.4.26   worker2   <none###           <none>\nmyapp-deploy-55b78d8548-xsz8x   1/1     Running   0          77m   10.244.3.16   worker1   <none###           <none>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);