(window.webpackJsonp=window.webpackJsonp||[]).push([[488],{2455:function(s,n,a){"use strict";a.r(n);var e=a(9),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一-sqlalchemy-查询超时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-sqlalchemy-查询超时"}},[s._v("#")]),s._v(" 一：SQLAlchemy 查询超时")]),s._v(" "),a("h3",{attrs:{id:"一-思考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-思考"}},[s._v("#")]),s._v(" （一）思考")]),s._v(" "),a("ul",[a("li",[s._v("每次对Model的一次操作，需要经历9个步骤，比较繁琐，存在如下几个问题：，在"),a("code",[s._v("fil-execute-engine")]),s._v("项目中，其实使用到了单例模式，对创建engine是一个单例，但是创建session会话是重复创建的，可能这里使用数据库连接池有问题")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"二-别人是这样封装sqlalchemy的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-别人是这样封装sqlalchemy的"}},[s._v("#")]),s._v(" （二）别人是这样封装sqlalchemy的")]),s._v(" "),a("ul",[a("li",[s._v("gumi/db.py内容如下")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("from django.conf import settings\nfrom django.core import signals\nfrom django.dispatch import dispatcher\nimport sqlalchemy\nfrom sqlalchemy.orm import scoped_session, sessionmaker\nfrom sqlalchemy.engine.url import URL\n\n__all__ = ['Session', 'metadata']\n\n\ndef create_engine():\n    url = URL(drivername=settings.DATABASE_ENGINE,\n              database=settings.DATABASE_NAME,\n              username=settings.DATABASE_USER,\n              password=settings.DATABASE_PASSWORD,\n              host=settings.DATABASE_HOST,\n              port=settings.DATABASE_PORT or None,\n              query=getattr(settings, 'DATABASE_OPTIONS', {})\n              )\n\n    options = getattr(settings, 'SQLALCHEMY_OPTIONS', {})\n    engine = sqlalchemy.create_engine(url, **options)\n    return engine\n\n\ndef end_request(signal, sender):\n    Session.remove()\n\n\ndispatcher.connect(receiver=end_request,\n                   signal=signals.request_finished)\n\nmetadata = sqlalchemy.MetaData()\n\nSession = scoped_session(sessionmaker(autoflush=True,\n                                      transactional=True,\n                                      bind=create_engine()))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("ul",[a("li",[s._v("模块代码内容如下")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("from sqlalchemy.orm import *\nfrom gumi.db import Session, metadata \n\n\nsome_table = Table('some_table', metadata, \n       Column('id', Integer, primary_key=True), \n       Column('some_value', String(100), nullable=False, \n       mysql_engine='InnoDB', \n       ) \nclass SomeObject(object): \n pass\n \nmapper(SomeObject, some_table)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ul",[a("li",[s._v("视图代码")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import django.newforms as forms \n\nfrom gumi.db import Session \n  \nclass SomeForm(forms.Form): \n  # newform \n  pass\n  \ndef some_action(req): \n  if req.method != \"POST\": \n   form = SomeForm() \n  else: \n   form = SomeForm(req.POST) \n   if form.is_valid(): \n     data = form.clean() \n     obj = SomeObject() \n     obj.some_param = data['a'] \n     obj.another_param = data['b'] \n     # 这里直接使用到Session\n     Session.save(obj) \n     Session.commit() \n     return HttpResponseRedirect('/') \n  return render_to_response('some/template.html')\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);