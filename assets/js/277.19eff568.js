(window.webpackJsonp=window.webpackJsonp||[]).push([[277],{1293:function(s,e,n){s.exports=n.p+"assets/img/2018-11-1111.33.35.b07573ec.png"},2434:function(s,e,n){"use strict";n.r(e);var a=n(9),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"一-使用不同的user-agent-来规避反爬策略-这种方式有高度的代码耦合性-可以通过scrapy的middleware解决耦合问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-使用不同的user-agent-来规避反爬策略-这种方式有高度的代码耦合性-可以通过scrapy的middleware解决耦合问题"}},[s._v("#")]),s._v(" （一）使用不同的User-Agent， 来规避反爬策略（这种方式有高度的代码耦合性，可以通过scrapy的middleware解决耦合问题）")]),s._v(" "),a("ul",[a("li",[s._v("在JobboleSpider类中，写入类变量headers")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("headers = {\n        'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',\n        'Accept-Encoding':  'gzip, deflate',\n        'Accept-Language': 'zh-CN,zh;q=0.9',\n        'Connection':  'keep-alive',\n        'host': 'blog.jobbole.com',\n        'Referer': 'http://blog.jobbole.com/',\n    }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ul",[a("li",[s._v("在settings文件中添加User Agent列表")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('user_agent_list = [\n    "Opera/9.80 (X11; Linux i686; Ubuntu/14.10) Presto/2.12.388 Version/12.16",\n    "Opera/9.80 (Windows NT 6.0) Presto/2.12.388 Version/12.14",\n    "Mozilla/5.0 (Windows NT 6.0; rv:2.0) Gecko/20100101 Firefox/4.0 Opera 12.14",\n    "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.0) Opera 12.14",\n    "Opera/12.80 (Windows NT 5.1; U; en) Presto/2.10.289 Version/12.02",\n    "Opera/9.80 (Windows NT 6.1; U; es-ES) Presto/2.9.181 Version/12.00",\n    "Opera/9.80 (Windows NT 5.1; U; zh-sg) Presto/2.9.181 Version/12.00",\n    "Opera/12.0(Windows NT 5.2;U;en)Presto/22.9.168 Version/12.00",\n    "Opera/12.0(Windows NT 5.1;U;en)Presto/22.9.168 Version/12.00",\n    "Mozilla/5.0 (Windows NT 5.1) Gecko/20100101 Firefox/14.0 Opera/12.0",\n    "Opera/9.80 (Windows NT 6.1; WOW64; U; pt) Presto/2.10.229 Version/11.62",\n    "Opera/9.80 (Windows NT 6.0; U; pl) Presto/2.10.229 Version/11.62",\n    "Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52",\n    "Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; de) Presto/2.9.168 Version/11.52",\n    "Opera/9.80 (Windows NT 5.1; U; en) Presto/2.9.168 Version/11.51",\n    "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; de) Opera 11.51",\n    "Opera/9.80 (X11; Linux x86_64; U; fr) Presto/2.9.168 Version/11.50",\n    "Opera/9.80 (X11; Linux i686; U; hu) Presto/2.9.168 Version/11.50",\n    "Opera/9.80 (X11; Linux i686; U; ru) Presto/2.8.131 Version/11.11",\n    "Opera/9.80 (X11; Linux i686; U; es-ES) Presto/2.8.131 Version/11.11",\n    "Mozilla/5.0 (Windows NT 5.1; U; en; rv:1.8.1) Gecko/20061208 Firefox/5.0 Opera 11.11",\n    "Opera/9.80 (X11; Linux x86_64; U; bg) Presto/2.8.131 Version/11.10",\n    "Opera/9.80 (Windows NT 6.0; U; en) Presto/2.8.99 Version/11.10",\n    "Opera/9.80 (Windows NT 5.1; U; zh-tw) Presto/2.8.131 Version/11.10",\n    "Opera/9.80 (Windows NT 6.1; Opera Tablet/15165; U; en) Presto/2.8.149 Version/11.1",\n    "Opera/9.80 (X11; Linux x86_64; U; Ubuntu/10.10 (maverick); pl) Presto/2.7.62 Version/11.01",\n]\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("ul",[a("li",[s._v("在common.py文件中，写一个获取随机数的函数，通过传递一个列表，获取列表的长度，且返回不超过列表长度的随机数")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import random\ndef get_randam_int(lst):\n    return random.randint(0, len(lst)-1)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[s._v("在JobboleSpider类的parse方法中，有yield Request的地方，将headers作为Request类的参数传递进去")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("from settings import user_agent_list\n\n# 生成自定义的User-Agent\nrandom_index = get_randam_int(user_agent_list)\nrandom_agent = user_agent_list[random_index]\nself.headers['User-Agent'] = random_agent\n\nyield Request(url=parse.urljoin(response.url, post_url),\n              headers=self.headers,\n              meta={\"front_image_url\": parse.urljoin(response.url, image_url)},\n              callback=self.parse_detail)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("这样每一次User-Agent都会发生变化， 但是这样使得代码的耦合度太高了，可以使用Downloader Middleware降低代码的耦合度")])])]),s._v(" "),a("h3",{attrs:{id:"二-download-middleware介绍-实现随机的useragent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-download-middleware介绍-实现随机的useragent"}},[s._v("#")]),s._v(" （二）Download Middleware介绍, 实现随机的UserAgent")]),s._v(" "),a("ul",[a("li",[s._v("1：Downloader Middleware处理的过程主要在调度器发送requests请求的时候以及网页将response结果返回给spiders的时候，所以从这里我们可以知道Downloader Middleware是介于Scrapy的request/response处理的钩子，用于修改Scrapy request和response。")]),s._v(" "),a("li",[s._v("2：编辑settings文件，将 Downloader Middleware 的注释打开，添加"),a("code",[s._v("ArticleSpider.middlewares.RandomUserAgentMiddleware")]),s._v(", 将默认的UserAgent中间件"),a("code",[s._v("scrapy.downloadermiddlewares.useragent.UserAgentMiddleware")]),s._v("设置为None，不让其覆盖了自定义的UserAgent")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("DOWNLOADER_MIDDLEWARES = {\n    'ArticleSpider.middlewares.RandomUserAgentMiddleware': 543,\n    'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware': None,\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("3：由于默认的middleware中有一个"),a("code",[s._v("scrapy.downloadermiddlewares.useragent.UserAgentMiddleware")]),s._v("，这个UserAgentMiddleware会将每一个请求的User-Agent赋值为Scrapy，所以在DOWNLOADER_MIDDLEWARES让其不生效即可")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("DOWNLOADER_MIDDLEWARES = {\n    'ArticleSpider.middlewares.RandomUserAgentMiddleware': 543,\n    'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware': None,\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[s._v("4：在middlewares.py文件中，创建一个自定义的UserAgent的Downloader Middleware。"),a("code",[s._v("在自建的Downloader Middleware中，一般可以重载这几个方法：process_request(request, spider)、process_response(request, response, spider)、process_exception(request, exception, spider)、from_crawler(cls, crawler)")])]),s._v(" "),a("li",[s._v("这里用到了一个第三方库：fake_useragent，自动生成UserAgent")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("from fake_useragent import UserAgent\n\nclass RandomUserAgentMiddleware:\n\n    def __init__(self, crawler):\n        self.user_agent = UserAgent()\n        self.user_agent_type = crawler.settings.get('RANDOM_UA_TYPE', 'random')\n\t\n\t# from_crawler方法会被首先调用\n    @classmethod\n    def from_crawler(cls, crawler):  # 传递进来的crawler参数，不仅会携带settings信息，还会有其他的信息\n        return cls(crawler)\n\n    def process_request(self, request, spider):\n\n        # 这里只需要获取对象，不需要调用，不是getattr(self.user_agent, self.user_agent_type)()，因为 ua.ie直接返回的是agent的\n        def get_ua_type():\n            return getattr(self.user_agent, self.user_agent_type)\n\n        request.headers.setdefault('User-Agent', get_ua_type())\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("ul",[a("li",[a("strong",[a("code",[s._v("这里我自己写了一个反射的方法，将上面的代码进行的反射原理的改造（这样写没有考虑到crawler在__init__方法中发挥的作用，因此这里只是给大家回顾一下Python中的反射的应用场景）")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("class RandomUserAgentMiddleware:\n\n    def __init__(self, crawler):\n        pass\n\t\n\t# 在这个类方法里面，给self绑定user_agent和user_agent_type两个属性\n    @classmethod\n    def from_crawler(cls, crawler):\n        agent_middleware = cls(crawler)\n        if not hasattr(agent_middleware, 'user_agent'):\n            setattr(agent_middleware, 'user_agent',UserAgent())\n\n        if not hasattr(agent_middleware, 'user_agent_type'):\n            setattr(agent_middleware, 'user_agent_type', crawler.settings.get('RANDOM_UA_TYPE', 'random'))\n        return agent_middleware\n\n\n    def process_request(self, request, spider):\n        # 这里只需要获取对象，不需要调用，不是getattr(self.user_agent, self.user_agent_type)()，因为 ua.ie直接返回的是agent\n        # 这里相当于UserAgent().random 获取随机的Agent\n        agent = getattr(self.user_agent, self.user_agent_type)\n        request.headers.setdefault('User-Agent', agent)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("ul",[a("li",[s._v("5：使用第三方的UserAgent(fake-useragent)，给headers传递不同的UserAgent。维护的User-Agent列表（http://fake-useragent.herokuapp.com/browsers/0.1.11）")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1：安装fake-useragent\npip install fake-useragent\n\n2: 测试功能（每一次都有不同的UserAgent）\n>>### from fake_useragent import UserAgent\n>>### ua = UserAgent()\n>>### ua.ie\n'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)'\n>>### ua.ie\n'Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; .NET CLR 2.7.58687; SLCC2; Media Center PC 5.0; Zune 3.4; Tablet PC 3.6; InfoPath.3)'\n>>### ua.random\n'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.1 Safari/537.36'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("ul",[a("li",[a("strong",[a("code",[s._v("到这里使用随机的useragent反爬虫完毕")])])])]),s._v(" "),a("h3",{attrs:{id:"三-download-middleware-实现-ip-proxy代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-download-middleware-实现-ip-proxy代理"}},[s._v("#")]),s._v(" （三）Download Middleware 实现 IP Proxy代理")]),s._v(" "),a("ul",[a("li",[a("strong",[a("code",[s._v("1：使用西刺Proxy代理(http://www.xicidaili.com/nn/)")])])]),s._v(" "),a("li",[s._v("①：随便找一个西刺代理上的IP")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("118.190.95.35\t9001\t广西\t高匿\tHTTP\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("②：将这个代理IP添加到RandomUserAgentMiddleware的process_request方法的最后")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("class RandomUserAgentMiddleware:\n\n    def __init__(self, crawler):\n        pass\n\n    @classmethod\n    def from_crawler(cls, crawler):\n        agent_middleware = cls(crawler)\n        if not hasattr(agent_middleware, 'user_agent'):\n            setattr(agent_middleware, 'user_agent',UserAgent())\n\n        if not hasattr(agent_middleware, 'user_agent_type'):\n            setattr(agent_middleware, 'user_agent_type', crawler.settings.get('RANDOM_UA_TYPE', 'random'))\n        return agent_middleware\n\n\n    def process_request(self, request, spider):\n        # 这里只需要获取对象，不需要调用，不是getattr(self.user_agent, self.user_agent_type)()，因为 ua.ie直接返回的是agent的\n        agent = getattr(self.user_agent, self.user_agent_type)\n        request.headers.setdefault('User-Agent', agent)\n        # 添加西刺代理的IP地址\n        request.meta['proxy'] = 'http://118.190.95.35:9001'\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("ul",[a("li",[s._v("③：在jobbole.py文件中修改start_urls")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("start_urls = ['http://bbs.yhyblog.cn/']\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("④：运行main.py脚本，在自己的阿里云服务器上看NGINX的日志，确实是代理的IP地址")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('118.190.95.35 - - [11/Nov/2018:20:57:02 +0800] "GET / HTTP/1.1" 200 1443 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1664.3 Safari/537.36" "-"\n\n118.190.95.35 - - [11/Nov/2018:20:57:36 +0800] "GET / HTTP/1.1" 200 1443 "-" "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.2 Safari/537.36" "-"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[a("strong",[a("code",[s._v("2：爬取西刺Proxy代理IP，构建自己的动态Proxy IP代理池")])])]),s._v(" "),a("li",[s._v("①：在项目的根目录中，添加一个包"),a("code",[s._v("tools")]),s._v("，在tools下面创建一个爬虫脚本, "),a("code",[s._v("crawl_xici_ip.py")]),s._v(",")]),s._v(" "),a("li",[s._v("②：使用"),a("code",[s._v("requests")]),s._v("包来爬取页面, 其实也可以直接使用scrapy爬取，这里讲解如何使用requests + scrapy selector爬取数据，且解析，且写入数据库, 写一个"),a("code",[s._v("ProxyIp")]),s._v("类完成字段解析和写库，")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("class ProxyIp:\n\n    def __init__(self):\n        # 获取数据库连接， 创建表\n        self.connect = MySQLdb.connect(host='localhost', user='article', password='123456', database='ArticleSpider',use_unicode=True, charset='utf8')\n        self.cursor = self.connect.cursor()\n        self.headers = {\n        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',\n        'Accept-Encoding': 'gzip, deflate',\n        'Accept-Language': 'zh-CN,zh;q=0.9',\n        'Connection': 'keep-alive',\n        'host': 'www.xicidaili.com',\n        'User-Agent': 'Opera/9.80 (X11; Linux i686; Ubuntu/14.10) Presto/2.12.388 Version/12.16',\n        }\n        self.result = requests.get(url='http://www.xicidaili.com/nn/', headers=self.headers)\n        self.proxy_ips = []\n\n    def __enter__(self):\n        return self\n\n    def __exit__(self, exc_type, exc_val, exc_tb):\n        self.cursor.close()\n        self.connect.close()\n\n    def process_item(self):\n        # select可以解析HTML文档\n        selector = Selector(text=self.result.text)\n        # 选择所有的列表\n        all_trs = selector.css(\"#ip_list tr\")\n        # 遍历所有的tr标签, 由于第一个tr标签是表头，所以剔除\n        for tr in all_trs[1:]:\n\n            # 1: 先获取速度\n            speed_raw = tr.css('.bar::attr(title)').extract()[0]\n            if speed_raw:\n                speed = float(speed_raw.split(\"秒\")[0])\n            else:\n                speed = 0.00\n\n            # 2: 获取所有的问题\n            all_texts = tr.css(\"td::text\").extract()\n\n            # 3：获取IP\n            ip = all_texts[0]\n            port = all_texts[1]\n            protocol = all_texts[5]\n\n            # 添加到列表\n            self.proxy_ips.append((ip, port, protocol, speed))\n\n    def store_item(self):\n        # 将字段写入数据库\n        for ip_info in self.proxy_ips:\n            self.cursor.execute(\n                \"insert proxy_ip(ip, port, speed, protocol) VALUES('{0}', '{1}', {2}, '{3}')\".format(ip_info[0],ip_info[1],ip_info[3],ip_info[2]))\n            # 提交\n            self.connect.commit()\n\n    def delete_item(self):\n        delete_sql = \"delete from proxy_ip;\"\n        self.cursor.execute(delete_sql)\n        self.connect.commit()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br")])]),a("ul",[a("li",[s._v("③：表结构如下\n"),a("img",{attrs:{src:n(1293),alt:"Alt text"}})]),s._v(" "),a("li",[s._v("④：写一个"),a("code",[s._v("ObtainProxyIP")]),s._v("类获取"),a("code",[s._v("代理的IP、端口、协议")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 从数据库获取代理\nclass ObtainProxyIP(object):\n    def __init__(self):\n        self.connect = MySQLdb.connect(host='localhost', user='article', password='123456', database='ArticleSpider',use_unicode=True, charset='utf8')\n        self.cursor = self.connect.cursor()\n\n    def __enter__(self):\n        return self\n\n    def __exit__(self, exc_type, exc_val, exc_tb):\n        self.cursor.close()\n        self.connect.close()\n\n    # 删除\n    def delete_ip(self, ip):\n        #从数据库中删除无效的ip\n        delete_sql = \"delete from proxy_ip where ip='{}'\".format(ip)\n        self.cursor.execute(delete_sql)\n        self.connect.commit()\n\n    # 检查代理IP是否可用\n    def is_OK(self, ip, port, protocol):\n        #判断ip是否可用\n        http_url = \"http://www.baidu.com\"\n        proxy_url = \"{}://{}:{}\".format(protocol, ip, port)\n        try:\n            # 拼接proxies参数, 判断代理是否有效\n            proxy_dict = {\"{}\".format(protocol):proxy_url,}\n            response = requests.get(http_url, proxies=proxy_dict)\n\n        except Exception as e:\n            self.delete_ip(ip)\n            return False\n        else:\n            code = response.status_code\n            if code >= 200 and code < 300:\n                return True\n            else:\n                self.delete_ip(ip)\n                return False\n\n    # 从库里面获取随机的IP地址\n    def get_item(self):\n        #从数据库中随机获取一个可用的ip\n        sql = \"SELECT * FROM proxy_ip ORDER BY RAND() LIMIT 1\"\n        self.cursor.execute(sql)\n        results = self.cursor.fetchall()\n        for ip_info in results:\n            ip = ip_info[0]\n            port = ip_info[1]\n            protocol = ip_info[3]\n            if self.is_OK(ip, port, protocol):\n                return \"{}://{}:{}\".format(protocol.lower(), ip, port)\n            else:\n                return self.get_item()\n\n    def __getattr__(self, item):\n        if item and item == 'item':\n            return self.get_item()\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br")])]),a("ul",[a("li",[s._v("⑤：模块接口测试")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('if __name__ == "__main__":\n\n    # 解析西刺，获取代理，写入数据库\n    with ProxyIp() as proxy_ip:\n        proxy_ip.process_item()\n        proxy_ip.store_item()\n\n    # 从本地数据库获取代理\n    with ObtainProxyIP() as proxy_ip:\n        result = proxy_ip.item\n        print(result)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ul",[a("li",[a("strong",[a("code",[s._v("3：在middlewares.py文件里面，创建一个RandomProxyMiddleware类, 动态设置Proxy IP 代理")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('\n# 设置动态随机IP\nclass RandomProxyMiddleware(object):\n    #动态设置ip代理\n    def process_request(self, request, spider):\n        with ObtainProxyIP() as proxy_ip:\n            request.meta["proxy"] = proxy_ip.item\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"四-二维码识别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四-二维码识别"}},[s._v("#")]),s._v(" （四）二维码识别")]),s._v(" "),a("ul",[a("li",[s._v("1：二维码识别分类")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1：谷歌开源 tesseract-ocr\n\n2：在线打码 ：模型训练，\n\n3：人工打码 ：人工识别\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])}),[],!1,null,null,null);e.default=r.exports}}]);