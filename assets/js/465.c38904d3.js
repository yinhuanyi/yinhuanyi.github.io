(window.webpackJsonp=window.webpackJsonp||[]).push([[465],{2389:function(s,n,a){"use strict";a.r(n);var t=a(9),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"一-aiohttp基础"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-aiohttp基础"}},[s._v("#")]),s._v(" 一：aiohttp基础")]),s._v(" "),a("h3",{attrs:{id:"一-基本概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-基本概念"}},[s._v("#")]),s._v(" (一)：基本概念")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("aiohttp是基于asyncio开发的HTTP客户端和服务器端框架")])]),s._v(" "),a("li",[a("p",[s._v("安装")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pip install aiohttp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"二-将aiohttp作为asyncio的http客户端使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-将aiohttp作为asyncio的http客户端使用"}},[s._v("#")]),s._v(" (二)：将aiohttp作为asyncio的HTTP客户端使用")]),s._v(" "),a("ul",[a("li",[s._v("下面代码中：首先驱动了main协程，并且调用"),a("code",[s._v("loop.run_forever()")]),s._v("，让事件无限循环。在main协程中，创建了pool MySQL线程池，基于aiohttp创建了session，然后调用了fetch协程，后去到HTTP请求的返回值，将返回的结果添加到waitting_urls列表中，再运行consumer协程，consumer协程是一个无限循环协程，判断waitting_urls是否有值，如果有值就取出，然后调用article_handler协程，article_handler协程调用fetch协程获取HTTP请求数据，然后解析HTTP数据，将有效字段写入到数据库中")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import aiohttp\nimport asyncio\nimport aiomysql\n\nwaitting_urls = ['https://www.baidu.com', 'https://www.baidu.com', 'https://www.baidu.com']\n\nstopping = False\n\n# 设置请求并发\n# sem = asyncio.Semaphore(3)\n\n\nasync def fetch(url, session):\n    # async with sem:\n    try:\n        async with session.get(url) as resp:\n            if resp.status in [200, 201]:\n                data = await resp.text()\n                # print(data)\n                return data\n    except Exception as e:\n        print(e)\n\n\n# 解析文章，获取title，写入数据库\nasync def article_handler(url, session, pool):\n    # doto: 获取文章返回的数据\n    html = await fetch(url, session)\n    print(html)\n    async with pool.acquire() as conn:\n        async with conn.cursor() as cur:\n            insert_sql = \"insert into test (`title`) values ('文章标题');\"\n            await cur.execute(insert_sql)\n\n\n# 消费waitting_urls中的url，将url传递到article_handler解析解析\nasync def consumer(pool):\n    async with aiohttp.ClientSession() as session:\n        while not stopping:\n            if len(waitting_urls) == 0:\n                await asyncio.sleep(0.5)\n                continue\n            # 如果列表有值\n            if waitting_urls:\n                # print('yes')\n                # 等待一下\n                print('yes')\n                await asyncio.sleep(0.0000000000000000001)\n                # 启动文章处理协程\n                asyncio.ensure_future(article_handler('https://www.ipfsmain.cn/', session, pool))\n\n# 获取数据库连接\nasync def main(loop):\n    # 获取连接池\n    pool = await aiomysql.create_pool(host=\"127.0.0.1\", port=3306, user='root', password='yhy3426356', db='db1',\n                                      loop=loop,\n                                      charset='utf8', autocommit=True)\n\n    # 基于aiohttp创建session连接\n    async with aiohttp.ClientSession() as session:\n        html = await fetch(\"https://www.baidu.com/\", session)\n        # 加入到队列，这应该使用queue替代列表\n        waitting_urls.append('https://www.baidu.com')\n\n    # 驱动消费者协程，只要\n    asyncio.ensure_future(consumer(pool))\n\n\nif __name__ == '__main__':\n    loop = asyncio.get_event_loop()\n    # 驱动协程\n    asyncio.ensure_future(main(loop))\n    try:\n        loop.run_forever()\n    except KeyboardInterrupt:\n        loop.stop()\n    finally:\n        loop.close()\n    # loop.run_until_complete(main(loop))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("上面代码有个问题：在consumer协程中，如果去掉"),a("code",[s._v("await asyncio.sleep(0.0000000000000000001)")]),s._v("，"),a("code",[s._v("那么无法发起网路请求，通过在本机基于tcpdump抓包后发现，数据包并没有发送出去，说明此时本地网卡的缓冲区已经满了，那么只能把数据包丢弃了")])])]),s._v(" "),a("li",[a("p",[s._v("loop事件循环有两种方式：可终止的事件循环 和 无限事件循环")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("第一种：当main协程或者main的子协程执行完毕后，loop停止\n\tloop.run_until_complete(main(loop))\n\n第二种：直接通过asyncio.ensure_future调用协程，因为内部会创建一个future对象，驱动协程。loop事件无限循环\n\tasyncio.ensure_future(main(loop))\n\tloop.run_forever()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[s._v("在协程中调用子协程有两种情况：需要获取子线程的返回值 和 不需要获取子线程的返回值")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("第一种：需要获取子线程的返回值\n\t例如：在article_handler协程中调用fetch协程，使用 html = await fetch(url, session)，获取fetch协程reture的数据\n\n\n第二种：不需要获取子线程的返回值，只需要调用子线程\n\t例如：在main协程中调用consumer协程，直接asyncio.ensure_future(consumer(pool))即可调用\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);