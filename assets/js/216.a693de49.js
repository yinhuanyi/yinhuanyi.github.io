(window.webpackJsonp=window.webpackJsonp||[]).push([[216],{1698:function(s,a,n){s.exports=n.p+"assets/img/2020-09-102.27.30.a7270cf1.png"},1699:function(s,a,n){s.exports=n.p+"assets/img/2020-10-198.28.04.8e07ebe1.png"},2658:function(s,a,n){"use strict";n.r(a);var e=n(9),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"一-版本差异"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-版本差异"}},[s._v("#")]),s._v(" 一：版本差异")]),s._v(" "),e("h3",{attrs:{id:"一-ansible版本差异与选择"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-ansible版本差异与选择"}},[s._v("#")]),s._v(" （一）ansible版本差异与选择")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("ansible在2.7版本以前是基于"),e("code",[s._v("collections.namedtuple")]),s._v("初始化ansible配置项，ansible在2.8版本以后，基于自身封装的"),e("code",[s._v("ImmutableDict")]),s._v("来初始化ansible的配置项。")])]),s._v(" "),e("li",[e("p",[s._v("本次开发以ansible2.9版本为例进行讲解")])])]),s._v(" "),e("h3",{attrs:{id:"二-ansible核心类介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-ansible核心类介绍"}},[s._v("#")]),s._v(" （二）ansible核心类介绍")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 配置项管理器，读取 json/ymal/ini 格式的文件的数据解析器\nfrom ansible.module_utils.common.collections import ImmutableDict\n# 上下文管理器，用于接收ImmutableDict的对象\nfrom ansible import context\n# 获取ansible临时文档\nimport ansible.constants as C\n# 加载器，读取 json/ymal/ini 格式的文件的数据解析器\nfrom ansible.parsing.dataloader import DataLoader\n# 资产管理器，管理主机和主机组的变量管理器\nfrom ansible.inventory.manager import InventoryManager\n# 变量管理器，管理主机和主机组的变量管理器\nfrom ansible.vars.manager import VariableManager\n# 执行 Ad-hoc， ,需要传入相应的参数\nfrom ansible.playbook.play import Play\n# 底层用到的任务队列管理器\nfrom ansible.executor.task_queue_manager import TaskQueueManager\n# 处理任务执行后返回的状态\nfrom ansible.plugins.callback import CallbackBase\n# 执行 playbook 的核心类\nfrom ansible.executor.playbook_executor import PlaybookExecutor\n# 对主机组执行操作\nfrom ansible.inventory.host import Group\n# 对主机执行操作\nfrom ansible.inventory.host import Host\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("h3",{attrs:{id:"三-ansible回调基类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-ansible回调基类"}},[s._v("#")]),s._v(" （三）ansible回调基类")]),s._v(" "),e("ul",[e("li",[s._v("ansible中，CallbackBase可以获取Ad-hoc、Playbook执行的结果，可以重写CallbackBase类的方法，存储ansible执行的结果")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class AdhocCallback(CallbackBase):\n    def v2_runner_on_unreachable(self, result):\n        pass\n\n    # 任务执行成功调用的方法\n    def v2_runner_on_ok(self, result):\n        host = result._host\n        print(json.dumps({host.name: result._result}, indent=4))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"四-ansible资产"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-ansible资产"}},[s._v("#")]),s._v(" （四）ansible资产")]),s._v(" "),e("ul",[e("li",[s._v("ansible中，资产是基于InventoryManager类进行管理的，解析资产文件需要DataLoader类")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[INVENTORY_FILE, ])\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("这里的sources参数可以是资产文件，也可以是以逗号隔开的字符串, 例如")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("inventory = InventoryManager(loader=loader, sources='localhost, 127.0.0.1')\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"五-ansible变量和资产变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-ansible变量和资产变量"}},[s._v("#")]),s._v(" （五）ansible变量和资产变量")]),s._v(" "),e("ul",[e("li",[s._v("ansible变量一般是指"),e("code",[s._v("/etc/ansible/ansible.cfg")]),s._v("文件中的变量,  可以使用ImmutableDict类对变量进行指定")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 定义ansible配置项\ncontext.CLIARGS = ImmutableDict(connection='smart',\n                                sudo_user='root',\n                                timeout=10,\n                                forks=500,\n                                command_warnings=False,\n                                deprecation_warnings=False,\n                                system_warnings=False,\n                                remote_user='root',\n                                become=True,\n                                become_method='sudo',\n                                become_user='root',\n                                become_ask_pass=False,\n                                gathering=False,\n                                host_key_checking=False,\n                                log_path=ADHOC_LOG,)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("ul",[e("li",[s._v("ansible与远程主机通信的变量一般是写在资产文件中"),e("code",[s._v("/etc/ansible/hosts")]),s._v("，例如：ansible_ssh_port、ansible_ssh_user、ansible_ssh_pass、ansible_sudo_pass、ansible_ssh_private_key_file、ansible_shell_type、ansible_python_interpreter。这些变量可以被"),e("code",[s._v("VariableManager")]),s._v("类解析")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 从资产文件中加载变量\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\n# 也可以动态添加变量, 下面是给10.102.0.13主机添加变量\nvariable_manager.set_host_variable(host='10.102.0.13', varname='ansible_ssh_user', value='ipfsmain')\nvariable_manager.set_host_variable(host='10.102.0.13', varname='ansible_ssh_pass', value='ipfsmain')\nvariable_manager.set_host_variable(host='10.102.0.13', varname='ansible_sudo_pass', value='ipfsmain')\nvariable_manager.set_host_variable(host='10.102.0.13', varname='ansible_python_interpreter', value='/usr/bin/python3')\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ul",[e("li",[s._v("查看资产变量")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("ret = variable_manager.get_vars(host=Host(name='10.102.0.13'))\nprint(json.dumps(ret))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("输出结果")])]),s._v(" "),e("p",[e("img",{attrs:{src:n(1698),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"六-创建一个ad-hoc任务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六-创建一个ad-hoc任务"}},[s._v("#")]),s._v(" （六）创建一个Ad-hoc任务")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 定义需要执行的任务， 注意任务主机必须在inventory里面\nplay_source = dict(\n    name=\"ansible test\",\n    hosts='10.102.0.13',  # 这个IP地址必须在inventory文件中，或者这里改写为域名，但是这个域名一定要在inventory文件，且在主机的/etc/hosts文件中需要有解析\n    gather_facts='no', # 是否获取主机的基本信息\n    tasks=[            # 这里是一个任务列表，可以一个任务一个任务的写, 写多个任务\n        dict(action={'module': 'shell', 'args': 'mkdir /root/hello'}),\n    ]\n)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"二-一个完整的ansible-2-9版本adhoc任务-这里的ipfsmain用户的密码是ipfsmain-并且ipfsmain默认的sudo不需要密码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-一个完整的ansible-2-9版本adhoc任务-这里的ipfsmain用户的密码是ipfsmain-并且ipfsmain默认的sudo不需要密码"}},[s._v("#")]),s._v(" 二：一个完整的Ansible 2.9版本adhoc任务(这里的ipfsmain用户的密码是ipfsmain，并且ipfsmain默认的sudo不需要密码)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# coding: utf-8\n\"\"\"\n\"\"\"\n\n\n\nfrom __future__ import (absolute_import, division, print_function)\n__metaclass__ = type\n\nimport json\nimport shutil\n\n# 导入ansible的核心类\nimport ansible.constants as C\nfrom ansible.executor.task_queue_manager import TaskQueueManager\nfrom ansible.module_utils.common.collections import ImmutableDict\nfrom ansible.inventory.manager import InventoryManager\nfrom ansible.parsing.dataloader import DataLoader\nfrom ansible.playbook.play import Play\nfrom ansible.plugins.callback import CallbackBase\nfrom ansible.vars.manager import VariableManager\nfrom ansible import context\nfrom utils.const_file import ADHOC_LOG\n\n\n\n# 获取jons格式的ansible ad-hoc输出\nclass ResultsCollectorJSONCallback(CallbackBase):\n\n    def __init__(self, *args, **kwargs):\n        super(ResultsCollectorJSONCallback, self).__init__(*args, **kwargs)\n        self.host_ok = {}\n        self.host_unreachable = {}\n        self.host_failed = {}\n\n    def v2_runner_on_unreachable(self, result):\n        host = result._host\n        self.host_unreachable[host.get_name()] = result\n        print('unreachable')\n        print(json.dumps({host.name: result._result}, indent=4))\n\n    def v2_runner_on_ok(self, result, *args, **kwargs):\n        \"\"\"Print a json representation of the result.\n\n        Also, store the result in an instance attribute for retrieval later\n        \"\"\"\n        host = result._host\n        self.host_ok[host.get_name()] = result\n        print('ok')\n        print(json.dumps({host.name: result._result}, indent=4))\n\n    def v2_runner_on_failed(self, result, *args, **kwargs):\n        host = result._host\n        self.host_failed[host.get_name()] = result\n        print('failed')\n        print(json.dumps({host.name: result._result}, indent=4))\n\n\ndef main():\n    # 定义主机列表\n    host_list = ['10.110.119.5',]\n\n    # 将主机列表转换为主机字符串\n    sources = ','.join(host_list)\n    if len(host_list) == 1:\n        sources += ','\n\n    # 这是ansible.cfg参数\n    context.CLIARGS = ImmutableDict(connection='smart',\n                                    module_path=None,\n                                    timeout=3,\n                                    forks=10,\n                                    become=True,\n                                    become_method='sudo',\n                                    become_user='root',\n                                    check=False,\n                                    become_ask_pass=False,\n                                    command_warnings=False,\n                                    deprecation_warnings=False,\n                                    system_warnings=False,\n                                    diff=False,\n                                    verbosity=5,\n                                    host_key_checking=False,\n                                    gathering=False,\n                                    log_path=ADHOC_LOG)\n\n\n    # 创建loader\n    loader = DataLoader() \n    \n    # 指定密码使用口令\n    passwords = dict(vault_pass='secret')\n\n    # 指定自定义的回调类\n    results_callback = ResultsCollectorJSONCallback()\n\n    # 创建资产对象\n    inventory = InventoryManager(loader=loader, sources=sources)\n\n    # 添加资产变量\n    variable_manager = VariableManager(loader=loader, inventory=inventory)\n    variable_manager.set_host_variable(host='10.110.119.5', varname='ansible_ssh_user', value='ipfsmain')\n    variable_manager.set_host_variable(host='10.110.119.5', varname='ansible_ssh_pass', value='ipfsmain')\n    variable_manager.set_host_variable(host='10.110.119.5', varname='ansible_sudo_pass', value='ipfsmain')\n    variable_manager.set_host_variable(host='10.110.119.5', varname='ansible_python_interpreter', value='/usr/bin/python3')\n    \n    # 创建任务队列管理器\n    tqm = TaskQueueManager(\n        inventory=inventory,\n        variable_manager=variable_manager,\n        loader=loader,\n        passwords=passwords,\n        stdout_callback=results_callback,\n    )\n    \n    \n    # 定义需要执行的任务\n    play_source = dict(\n        name=\"Ansible Play\",\n        hosts=host_list,\n        gather_facts='no',\n        tasks=[\n            dict(action={'module': 'shell', 'args': 'mkdir -pv /root/hello'}),\n            dict(action={'module': 'shell', 'args': 'chown -R root.root /root/hello'}),\n            # dict(action={'module': 'shell', 'args': 'rm -fr /root/hello'}),\n\n            # dict(action={'module': 'copy', 'args': 'src=/etc/fstab dest=/tmp/'}),\n            # dict(action={'module': 'shell', 'args': 'apt install -y sysstat'}),\n            # dict(action={'module': 'ping'}),\n            # dict(action=dict(module='shell', args='ls'), register='shell_out'),\n            # dict(action=dict(module='debug', args=dict(msg='{{shell_out.stdout}}'))),\n            # dict(action=dict(module='command', args=dict(cmd='/usr/bin/uptime'))),\n        ]\n    )\n\n    # 创建play对象\n    play = Play().load(play_source, variable_manager=variable_manager, loader=loader)\n\n    # 在任务队列中执行play对象\n    try:\n        result = tqm.run(play)  # most interesting data for a play is actually sent to the callback's methods\n    finally:\n        # 每次执行完毕后，清理任务队列中的任务\n        tqm.cleanup()\n        if loader:\n            loader.cleanup_all_tmp_files()\n\n    # Remove ansible tmpdir，清理临时目录\n    shutil.rmtree(C.DEFAULT_LOCAL_TMP, True)\n\n    \n    print(\"UP ***********\")\n    for host, result in results_callback.host_ok.items():\n        print(result)\n        print(result._result)\n        print('{0} >>> {1}'.format(host, result._result['stdout']))\n\n    print(\"FAILED *******\")\n    for host, result in results_callback.host_failed.items():\n        print('{0} >>> {1}'.format(host, result._result['stderr']))\n\n    print(\"DOWN *********\")\n    for host, result in results_callback.host_unreachable.items():\n        print('{0} >>> {1}'.format(host, result._result['msg']))\n\n\nif __name__ == '__main__':\n    main()\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br"),e("span",{staticClass:"line-number"},[s._v("108")]),e("br"),e("span",{staticClass:"line-number"},[s._v("109")]),e("br"),e("span",{staticClass:"line-number"},[s._v("110")]),e("br"),e("span",{staticClass:"line-number"},[s._v("111")]),e("br"),e("span",{staticClass:"line-number"},[s._v("112")]),e("br"),e("span",{staticClass:"line-number"},[s._v("113")]),e("br"),e("span",{staticClass:"line-number"},[s._v("114")]),e("br"),e("span",{staticClass:"line-number"},[s._v("115")]),e("br"),e("span",{staticClass:"line-number"},[s._v("116")]),e("br"),e("span",{staticClass:"line-number"},[s._v("117")]),e("br"),e("span",{staticClass:"line-number"},[s._v("118")]),e("br"),e("span",{staticClass:"line-number"},[s._v("119")]),e("br"),e("span",{staticClass:"line-number"},[s._v("120")]),e("br"),e("span",{staticClass:"line-number"},[s._v("121")]),e("br"),e("span",{staticClass:"line-number"},[s._v("122")]),e("br"),e("span",{staticClass:"line-number"},[s._v("123")]),e("br"),e("span",{staticClass:"line-number"},[s._v("124")]),e("br"),e("span",{staticClass:"line-number"},[s._v("125")]),e("br"),e("span",{staticClass:"line-number"},[s._v("126")]),e("br"),e("span",{staticClass:"line-number"},[s._v("127")]),e("br"),e("span",{staticClass:"line-number"},[s._v("128")]),e("br"),e("span",{staticClass:"line-number"},[s._v("129")]),e("br"),e("span",{staticClass:"line-number"},[s._v("130")]),e("br"),e("span",{staticClass:"line-number"},[s._v("131")]),e("br"),e("span",{staticClass:"line-number"},[s._v("132")]),e("br"),e("span",{staticClass:"line-number"},[s._v("133")]),e("br"),e("span",{staticClass:"line-number"},[s._v("134")]),e("br"),e("span",{staticClass:"line-number"},[s._v("135")]),e("br"),e("span",{staticClass:"line-number"},[s._v("136")]),e("br"),e("span",{staticClass:"line-number"},[s._v("137")]),e("br"),e("span",{staticClass:"line-number"},[s._v("138")]),e("br"),e("span",{staticClass:"line-number"},[s._v("139")]),e("br"),e("span",{staticClass:"line-number"},[s._v("140")]),e("br"),e("span",{staticClass:"line-number"},[s._v("141")]),e("br"),e("span",{staticClass:"line-number"},[s._v("142")]),e("br"),e("span",{staticClass:"line-number"},[s._v("143")]),e("br"),e("span",{staticClass:"line-number"},[s._v("144")]),e("br"),e("span",{staticClass:"line-number"},[s._v("145")]),e("br"),e("span",{staticClass:"line-number"},[s._v("146")]),e("br"),e("span",{staticClass:"line-number"},[s._v("147")]),e("br"),e("span",{staticClass:"line-number"},[s._v("148")]),e("br"),e("span",{staticClass:"line-number"},[s._v("149")]),e("br"),e("span",{staticClass:"line-number"},[s._v("150")]),e("br"),e("span",{staticClass:"line-number"},[s._v("151")]),e("br"),e("span",{staticClass:"line-number"},[s._v("152")]),e("br"),e("span",{staticClass:"line-number"},[s._v("153")]),e("br"),e("span",{staticClass:"line-number"},[s._v("154")]),e("br"),e("span",{staticClass:"line-number"},[s._v("155")]),e("br"),e("span",{staticClass:"line-number"},[s._v("156")]),e("br"),e("span",{staticClass:"line-number"},[s._v("157")]),e("br"),e("span",{staticClass:"line-number"},[s._v("158")]),e("br"),e("span",{staticClass:"line-number"},[s._v("159")]),e("br"),e("span",{staticClass:"line-number"},[s._v("160")]),e("br"),e("span",{staticClass:"line-number"},[s._v("161")]),e("br"),e("span",{staticClass:"line-number"},[s._v("162")]),e("br"),e("span",{staticClass:"line-number"},[s._v("163")]),e("br"),e("span",{staticClass:"line-number"},[s._v("164")]),e("br"),e("span",{staticClass:"line-number"},[s._v("165")]),e("br"),e("span",{staticClass:"line-number"},[s._v("166")]),e("br"),e("span",{staticClass:"line-number"},[s._v("167")]),e("br"),e("span",{staticClass:"line-number"},[s._v("168")]),e("br")])]),e("ul",[e("li",[s._v("总结一下ansible命令行与api的对应关系")])]),s._v(" "),e("p",[e("img",{attrs:{src:n(1699),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"三-在ansible-api的调用过程中-目标主机执行任务的用户-如果没有设置sudo免密-会造成taskqueuemanager执行任务无法获取返回结果-任务卡死"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-在ansible-api的调用过程中-目标主机执行任务的用户-如果没有设置sudo免密-会造成taskqueuemanager执行任务无法获取返回结果-任务卡死"}},[s._v("#")]),s._v(" 三：在Ansible API的调用过程中，目标主机执行任务的用户，如果没有设置sudo免密，会造成TaskQueueManager执行任务无法获取返回结果，任务卡死")]),s._v(" "),e("h3",{attrs:{id:"一-解决办法1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-解决办法1"}},[s._v("#")]),s._v(" （一）解决办法1")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("最简单方式是给目标主机，设置ipfsmain sudo免密\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"二-解决办法2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-解决办法2"}},[s._v("#")]),s._v(" （二）解决办法2")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("在ansible的task_queue_manager.py模块中，设置超时时间\n使用func-timeout模块，对执行任务的函数进行超时时长限制，相关代码如下\n\ntqm = self.__get_task_queue_manager()\n# 这里设置了超时时长\nfunc_timeout(self.exec_timeout, tqm.run, args=(play, ))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"四-在ansible-api的调用过程中-在线程中封装ansible-api执行过程碰到的问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-在ansible-api的调用过程中-在线程中封装ansible-api执行过程碰到的问题"}},[s._v("#")]),s._v(" 四：在Ansible API的调用过程中，在线程中封装ansible api执行过程碰到的问题")]),s._v(" "),e("ul",[e("li",[s._v("由于ansible的执行，会在主机的"),e("code",[s._v("/root/.ansible/tmp/")]),s._v("目录下，创建一个临时目录，例如："),e("code",[s._v("/root/.ansible/tmp/ansible-local-e577eb19-9d08-4995-b449-3cef5bbc11b9j8hw572m/tmp0l7ual18")]),s._v("这个目录，那么每个线程执行都会创建一个目录，但是创建完毕后又会删除，"),e("code",[s._v("shutil.rmtree(C.DEFAULT_LOCAL_TMP, True)")]),s._v("，因此会导致"),e("code",[s._v("目录找不到错误")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("FileNotFoundError: [Errno 2] No such file or directory: '/root/.ansible/tmp/ansible-local-e577eb19-9d08-4995-b449-3cef5bbc11b9j8hw572m/tmp0l7ual18'\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("解决办法（有难度：https://blog.csdn.net/avenger19/article/details/104430485）")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1: 采用多进程结构，确保每个进程只有一个TaskQueueManager对象被创建\n2: 保证constants在TaskQueueManager子进程创建之前不被引用\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("在星际大陆解决的方案")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("设置一个全局的flag单例变量，当一个ansible进程运行的时候，无论是执行的adhoc命令还是playbook命令，只要有任务再运行，那么就无法执行下一个任务\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);