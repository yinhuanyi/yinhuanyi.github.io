(window.webpackJsonp=window.webpackJsonp||[]).push([[179],{2224:function(s,e,n){"use strict";n.r(e);var t=n(9),a=Object(t.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"一-securecookie包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-securecookie包"}},[s._v("#")]),s._v(" 一：securecookie包")]),s._v(" "),t("h3",{attrs:{id:"一-基本使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-基本使用"}},[s._v("#")]),s._v(" (一)：基本使用")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("securecookie包提供了一种安全的 cookie加密方式，通过在服务端给 cookie 加密，让cookie内容不可读，也不可伪造，")]),s._v("但是用户的敏感信息不能放在cookie中，下面是一个web后端给浏览器设置cookie的示例，代码中将cookie的value进行了编码，当获取到用户的cookie，可以对其进行解码")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('type User struct {\n\tName string\n\tAge int\n}\n\n// 声明全局的cookie变量\nvar s *securecookie.SecureCookie\n\nfunc InitCookie() {\n\t// 随机生成两个byte[]数组，作为hashKey和blockKey，用于防止cookie的value被篡改\n\thashKey := securecookie.GenerateRandomKey(16)\n\tblockKey := securecookie.GenerateRandomKey(16)\n\t// 生成一个securityCookie\n\ts = securecookie.New(hashKey, blockKey)\n}\n\nfunc SetCookieHandler(w http.ResponseWriter, r *http.Request) {\n\tuser := &User {\n\t\tName: "Robby",\n\t\tAge: 20,\n\t}\n\n\t// 将user对象编码为加密字符串\n\tif encoded, err := s.Encode("user", user); err == nil {\n\t\t// 创建一个cookie结构体，value是用户加密内容\n\t\tcookie := &http.Cookie{\n\t\t\tName: "user",\n\t\t\tValue: encoded,\n\t\t\tPath: "/",\n\t\t\tSecure: true,\n\t\t\tHttpOnly: true,\n\t\t\t// 替代Expires属性，设置过期时间\n\t\t\tMaxAge: int(time.Hour * 24 / time.Second),\n\n\t\t}\n\t\t// 将cookie写入到响应报文的响应头中, 添加set-cookie协议头，浏览器会自动将cookie信息写入到Application中\n\t\thttp.SetCookie(w, cookie)\n\t}\n\n\tfmt.Fprintln(w, "Hello World")\n}\n\nfunc ReadCookieHandler(w http.ResponseWriter, r *http.Request) {\n\n\t// 这里从请求报文中获取name为user的cookie对象\n\tif cookie, err := r.Cookie("user"); err == nil {\n\n\t\tuser := User{}\n\n\t\t// 对cookie的value进行解码，将解码数据映射到user结构体对象中\n\t\tif err = s.Decode("user", cookie.Value, &user); err == nil {\n\t\t\tfmt.Fprintf(w, "name:%s age:%d", user.Name, user.Age)\n\n\t\t}\n\n\t}\n\n}\n\nfunc main() {\n\tInitCookie()\n\n\thttp.HandleFunc("/setcookie", SetCookieHandler)\n\thttp.HandleFunc("/getcookie", ReadCookieHandler)\n\n\n\n\terr := http.ListenAndServe(":9090", nil)\n\tif err != nil {\n\t\tfmt.Printf("http server failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br")])]),t("ul",[t("li",[s._v("securecookie底层默认使用了encoding/gob的编解码规则，对cookie的value进行编解码，当然也可以选择使用encoding/json的编解码规则")])]),s._v(" "),t("h3",{attrs:{id:"二-hashkey和blockkey"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-hashkey和blockkey"}},[s._v("#")]),s._v(" (二)：hashKey和blockKey")]),s._v(" "),t("ul",[t("li",[s._v("securecookie默认使用sha256.New作为 Hash 函数(用于 HMAC 算法)，默认使用aes.NewCipher作为 Block 函数(用于加解密)")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("func New(hashKey, blockKey []byte) *SecureCookie {\n\ts := &SecureCookie{\n\t\thashKey:   hashKey,\n\t\tblockKey:  blockKey,\n\t\thashFunc:  sha256.New, // hash函数\n\t\tmaxAge:    86400 * 30,\n\t\tmaxLength: 4096,\n\t\tsz:        GobEncoder{},\n\t}\n\tif hashKey == nil {\n\t\ts.err = errHashKeyNotSet\n\t}\n\tif blockKey != nil {\n\t\ts.BlockFunc(aes.NewCipher) // block函数\n\t}\n\treturn s\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ul",[t("li",[s._v("出于cookie加密的安全考虑也可以选择使用其他的"),t("code",[s._v("Hash 函数")]),s._v("和"),t("code",[s._v("Block 函数")]),s._v("。可以通过HashFunc方法改默认的Hash 函数，参数需要传递一个函数对象")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("func (s *SecureCookie) HashFunc(f func() hash.Hash) *SecureCookie {\n  s.hashFunc = f\n  return s\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("ul",[t("li",[s._v("也可以通过BlockFunc方法改默认的Block函数，参数需要传递一个函数对象")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("func (s *SecureCookie) BlockFunc(f func([]byte) (cipher.Block, error)) *SecureCookie {\n  if s.blockKey == nil {\n    s.err = errBlockKeyNotSet\n  } else if block, err := f(s.blockKey); err == nil {\n    s.block = block\n  } else {\n    s.err = cookieError{cause: err, typ: usageError}\n  }\n  return s\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[s._v("例如下面代码使用sha512.New512_256替换原有的Hash函数")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("s.HashFunc(sha512.New512_256)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"三-更换-key"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-更换-key"}},[s._v("#")]),s._v(" (三)：更换 Key")]),s._v(" "),t("ul",[t("li",[s._v("虽然每个cookie都有过期时间，但是服务器端为了防止 cookie 泄露造成安全风险，有个常用的安全策略："),t("code",[s._v("定期更换加密Key")]),s._v("，在securecookie库中，就是定期更换SecureCookie对象。下面代码中，考虑到每个请求都是在一个goroutine中完成，对cookie的读写操作需要考虑到并发安全，可以使用map对象来存储轮换的cookie对象，然后map对象封装一个Mutex互斥锁，但是这样效率不高，最好使用atomic方式来实现并发情况下数据的同步。但是这里还有一个问题，atomic操作不支持自定义数据类型，因此可以将"),t("code",[s._v("SecureCookie")]),s._v("封装为unsafe.Pointer类型，就可以使用"),t("code",[s._v("atomic.StorePointer、atomic.LoadPointer")]),s._v("对临界资源进行读写了。cookie更换的代码如下")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('type User struct {\n\tName string\n\tAge int\n}\n\nvar (\n\tprevCookie    unsafe.Pointer\n\tcurrentCookie unsafe.Pointer\n)\n\n// init 自动执行函数，生成两个cookie对象，将其封装为unsafe.Pointer类型\nfunc init() {\n\n\tprevCookie = unsafe.Pointer(securecookie.New(\n\t\tsecurecookie.GenerateRandomKey(64),\n\t\tsecurecookie.GenerateRandomKey(32),\n\t))\n\n\tcurrentCookie = unsafe.Pointer(securecookie.New(\n\t\tsecurecookie.GenerateRandomKey(64),\n\t\tsecurecookie.GenerateRandomKey(32),\n\t))\n\n}\n\n// 使用新的cookie对象，替换老的cookie对象\nfunc rotateKey() {\n\tfmt.Println("替换之前的cookie对象")\n\n\t// 创建一个新的cookie对象\n\tnewcookie := securecookie.New(\n\t\tsecurecookie.GenerateRandomKey(64),\n\t\tsecurecookie.GenerateRandomKey(32),\n\t)\n\n\t// 将当前的cookie对象覆盖旧的cookie对象\n\tatomic.StorePointer(&prevCookie, currentCookie)\n\t// 将新的cookie对象覆盖当前的cookie对象\n\tatomic.StorePointer(&currentCookie, unsafe.Pointer(newcookie))\n\n}\n\n// RotateKey 定时器，30秒执行一次cookie对象更新\nfunc RotateKey(ctx context.Context) {\n\n\tticker := time.NewTicker(30 * time.Second)\n\tdefer ticker.Stop()\n\n\tfor {\n\t\tselect {\n\t\tcase <-ctx.Done():\n\t\t\tbreak\n\t\tcase <-ticker.C:\n\t\t}\n\t\t// 执行更新cookie\n\t\trotateKey()\n\t}\n}\n\n\nfunc SetCookieHandler(w http.ResponseWriter, r *http.Request) {\n\n\tuser := User {\n\t\tName: "Robby",\n\t\tAge: 20,\n\t}\n\n\t// 将user对象编码为加密字符串\n\tif encoded, err := securecookie.EncodeMulti("user", &user, (*securecookie.SecureCookie)(atomic.LoadPointer(&currentCookie))); err == nil {\n\t\tcookie := &http.Cookie{\n\t\t\tName: "user",\n\t\t\tValue: encoded,\n\t\t\tPath: "/",\n\t\t\tSecure: true,\n\t\t\tHttpOnly: true,\n\t\t\t// 替代Expires属性，设置过期时间\n\t\t\tMaxAge: int(time.Hour * 24 / time.Second),\n\n\t\t}\n\n\t\thttp.SetCookie(w, cookie)\n\n\t}\n\n\n\tfmt.Fprintln(w, "Hello World")\n}\n\nfunc ReadCookieHandler(w http.ResponseWriter, r *http.Request) {\n\n\t// 这里从请求报文中获取name为user的cookie对象\n\tif cookie, err := r.Cookie("user"); err == nil {\n\n\t\tuser := User{}\n\n\t\tif err = securecookie.DecodeMulti("user",\n\t\t\tcookie.Value,\n\t\t\t&user,\n\t\t\t(*securecookie.SecureCookie)(atomic.LoadPointer(&currentCookie)), // 获取当前的cookie对象\n\t\t\t(*securecookie.SecureCookie)(atomic.LoadPointer(&prevCookie)),    // 获取之前的cookie对象\n\t\t\t); err == nil {\n\n\t\t\tfmt.Fprintf(w, "name:%s age:%d", user.Name, user.Age)\n\n\t\t}else {\n\t\t\tfmt.Fprintf(w, "Parse cookie error: %v", err)\n\t\t}\n\n\t}\n\n}\n\nfunc main() {\n\n\t// 更新cookie\n\tctx, cancel := context.WithCancel(context.Background())\n\tdefer cancel()\n\t// 30秒更新一次cookie对象\n\tgo RotateKey(ctx)\n\n\n\thttp.HandleFunc("/setcookie", SetCookieHandler)\n\thttp.HandleFunc("/getcookie", ReadCookieHandler)\n\n\n\terr := http.ListenAndServe(":9090", nil)\n\tif err != nil {\n\t\tfmt.Printf("http server failed, err:%v\\n", err)\n\t\treturn\n\t}\n\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br"),t("span",{staticClass:"line-number"},[s._v("85")]),t("br"),t("span",{staticClass:"line-number"},[s._v("86")]),t("br"),t("span",{staticClass:"line-number"},[s._v("87")]),t("br"),t("span",{staticClass:"line-number"},[s._v("88")]),t("br"),t("span",{staticClass:"line-number"},[s._v("89")]),t("br"),t("span",{staticClass:"line-number"},[s._v("90")]),t("br"),t("span",{staticClass:"line-number"},[s._v("91")]),t("br"),t("span",{staticClass:"line-number"},[s._v("92")]),t("br"),t("span",{staticClass:"line-number"},[s._v("93")]),t("br"),t("span",{staticClass:"line-number"},[s._v("94")]),t("br"),t("span",{staticClass:"line-number"},[s._v("95")]),t("br"),t("span",{staticClass:"line-number"},[s._v("96")]),t("br"),t("span",{staticClass:"line-number"},[s._v("97")]),t("br"),t("span",{staticClass:"line-number"},[s._v("98")]),t("br"),t("span",{staticClass:"line-number"},[s._v("99")]),t("br"),t("span",{staticClass:"line-number"},[s._v("100")]),t("br"),t("span",{staticClass:"line-number"},[s._v("101")]),t("br"),t("span",{staticClass:"line-number"},[s._v("102")]),t("br"),t("span",{staticClass:"line-number"},[s._v("103")]),t("br"),t("span",{staticClass:"line-number"},[s._v("104")]),t("br"),t("span",{staticClass:"line-number"},[s._v("105")]),t("br"),t("span",{staticClass:"line-number"},[s._v("106")]),t("br"),t("span",{staticClass:"line-number"},[s._v("107")]),t("br"),t("span",{staticClass:"line-number"},[s._v("108")]),t("br"),t("span",{staticClass:"line-number"},[s._v("109")]),t("br"),t("span",{staticClass:"line-number"},[s._v("110")]),t("br"),t("span",{staticClass:"line-number"},[s._v("111")]),t("br"),t("span",{staticClass:"line-number"},[s._v("112")]),t("br"),t("span",{staticClass:"line-number"},[s._v("113")]),t("br"),t("span",{staticClass:"line-number"},[s._v("114")]),t("br"),t("span",{staticClass:"line-number"},[s._v("115")]),t("br"),t("span",{staticClass:"line-number"},[s._v("116")]),t("br"),t("span",{staticClass:"line-number"},[s._v("117")]),t("br"),t("span",{staticClass:"line-number"},[s._v("118")]),t("br"),t("span",{staticClass:"line-number"},[s._v("119")]),t("br"),t("span",{staticClass:"line-number"},[s._v("120")]),t("br"),t("span",{staticClass:"line-number"},[s._v("121")]),t("br"),t("span",{staticClass:"line-number"},[s._v("122")]),t("br"),t("span",{staticClass:"line-number"},[s._v("123")]),t("br"),t("span",{staticClass:"line-number"},[s._v("124")]),t("br"),t("span",{staticClass:"line-number"},[s._v("125")]),t("br"),t("span",{staticClass:"line-number"},[s._v("126")]),t("br"),t("span",{staticClass:"line-number"},[s._v("127")]),t("br"),t("span",{staticClass:"line-number"},[s._v("128")]),t("br"),t("span",{staticClass:"line-number"},[s._v("129")]),t("br"),t("span",{staticClass:"line-number"},[s._v("130")]),t("br"),t("span",{staticClass:"line-number"},[s._v("131")]),t("br"),t("span",{staticClass:"line-number"},[s._v("132")]),t("br")])]),t("ul",[t("li",[s._v("当访问"),t("code",[s._v("http://localhost:9090/setcookie")]),s._v("，会使用currentCookie对象加密cookie的value，当访问"),t("code",[s._v("http://localhost:9090/getcookie")]),s._v("的时候，会使用currentCookie对象和prevCookie对象对cookie.value进行验证和解码。如果在此期间出现了"),t("code",[s._v("新SecureCookie对象替换旧SecureCookie对象的操作")]),s._v("，那么此时可能以前写入到用户浏览器的cookie.value，无法通过currentCookie对象和prevCookie对象的校验，出现cookie.value解码失败")])]),s._v(" "),t("p",[t("img",{attrs:{src:n(748),alt:"Alt text"}})]),s._v(" "),t("ul",[t("li",[s._v("1分钟后，获取cookie.value，进行解码")])]),s._v(" "),t("p",[t("img",{attrs:{src:n(749),alt:"Alt text"}})]),s._v(" "),t("h3",{attrs:{id:"四-注意点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-注意点"}},[s._v("#")]),s._v(" (四)：注意点")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("securecookie为cookie.value添加了一层加密保护，让 cookie.value 不能轻易地被读取、篡改，但是用户的敏感数据不应该存储在cookie中")])]),s._v(" "),t("li",[t("p",[s._v("使用cookie来校验用户身份合法性的方式只适用于单进程服务中，如果想在多进程模式下，依然使用cookie的方式校验用户的身份，那么就需要将来自同一个用户的请求，调度给同一个进程处理。因此特殊情况下，可以考虑使用"),t("code",[s._v("一致性哈希算法")]),s._v("，将相同用户的请求调度到同一个服务器上的同一进程处理即可")])])])])}),[],!1,null,null,null);e.default=a.exports},748:function(s,e,n){s.exports=n.p+"assets/img/2021-10-312.35.46.0fd35404.png"},749:function(s,e,n){s.exports=n.p+"assets/img/2021-10-312.36.08.d86319ad.png"}}]);