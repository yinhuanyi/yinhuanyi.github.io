(window.webpackJsonp=window.webpackJsonp||[]).push([[586],{2639:function(s,a,n){"use strict";n.r(a);var t=n(9),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"一-redis持久化的方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-redis持久化的方式"}},[s._v("#")]),s._v(" 一：Redis持久化的方式")]),s._v(" "),n("h3",{attrs:{id:"一-三种持久化方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一-三种持久化方式"}},[s._v("#")]),s._v(" (一)：三种持久化方式")]),s._v(" "),n("ul",[n("li",[s._v("分类")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("："),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("：在指定的时间间隔内对数据进行快照，\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("："),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("：每次记录数据库的写操作，当Redis重启后，读取这些数据来恢复Redis\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("："),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("和"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("混合使用："),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("读取"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("数据重建数据集\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"二-rdb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-rdb"}},[s._v("#")]),s._v(" (二)：RDB")]),s._v(" "),n("ul",[n("li",[s._v("基于快照实现持久化存储，数据文件叫dump.rdb，会存储在配置文件中"),n("code",[s._v("dir所指的数据目录中")])])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("save "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("900")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 900秒内，有一次更新就会快照")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 300秒内，有10次更新，就会快照")]),s._v("\nsave "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ul",[n("li",[s._v("生成快照的方式有如下几种")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：手动 bgsave执行：非阻塞\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：手动 save执行：阻塞\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：根据配置文件自动执行\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("：客户端发送shutdown，系统会先执行save命令阻塞客户端，然后关闭服务器\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("：当存在主从架构，从节点发送sync命令给主节点执行复制操作，主服务器会执行bgsave操作\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("ul",[n("li",[s._v("RDB快照生成的原理")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("快照复制的时候，基于Linux内核的写时复制思想，所以速度快\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"三-aof持久化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三-aof持久化"}},[s._v("#")]),s._v(" (三)：AOF持久化")]),s._v(" "),n("ul",[n("li",[s._v("AOF默认是关闭的，通过修改配置文件开启AOF")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[s._v("appendonly yes "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开启AOF")]),s._v("\nappendfilename "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly.aof"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定AOF文件名称")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("Redis提供了三种AOF同步策略")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：appendfsync everysec 每秒同步：每秒调用fsync \n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：appendfsync always 每次修改同步：每次都会调用fsync，降低Redis性能\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：appendfsync no 不主动同步：由操作系统调度\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[n("p",[s._v("如果不小心执行了flushdb操作，数据库中的数据被清空，但是没有关系，停止Redis，可以将"),n("code",[s._v("appendonly.aof")]),s._v("文件中的flushdb字符串删除，那么重启后，Redis的数据将会恢复")])]),s._v(" "),n("li",[n("p",[s._v("AOF有自动重写机制：可以会将一些命令操作合并，保证AOF文件不会持续膨胀")])])]),s._v(" "),n("h3",{attrs:{id:"四-如何选择rdb和aof"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四-如何选择rdb和aof"}},[s._v("#")]),s._v(" (四)：如何选择RDB和AOF")]),s._v(" "),n("ul",[n("li",[s._v("混合模式：同时开启RDB和AOF")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开启aof和rdb")]),s._v("\naof"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("use"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("rdb"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("preamble yes\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("混合模式的执行过程：新的AOF文件中，一部分数据来自RDB文件，一部分数据来自Redis运行过程的增量数据")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("：子进程会将内存中的数据以"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("的方式写入到"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("中\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("：把重写缓冲区的增量命令以"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("方式写入到文件\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("：将含有"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RDB")]),s._v("个数和"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("格式的"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("数据覆盖旧的"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("AOF")]),s._v("文件\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"五-rdb切换到aof文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五-rdb切换到aof文件"}},[s._v("#")]),s._v(" (五)：RDB切换到AOF文件")]),s._v(" "),n("ul",[n("li",[s._v("可以在不重启Redis情况下，将RDB切换到AOF")])]),s._v(" "),n("div",{staticClass:"language-javascript line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开启aof")]),s._v("\nredis"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli config "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" appendonly yes\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 关闭rdb")]),s._v("\nredis"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli config "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" save "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"六-redis持久化优化方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六-redis持久化优化方案"}},[s._v("#")]),s._v(" (六)：Redis持久化优化方案")]),s._v(" "),n("ul",[n("li",[s._v("主从模式下，关闭主节点的持久化")])])])}),[],!1,null,null,null);a.default=e.exports}}]);