(window.webpackJsonp=window.webpackJsonp||[]).push([[334],{2157:function(n,s,t){"use strict";t.r(s);var a=t(9),e=Object(a.a)({},(function(){var n=this,s=n.$createElement,t=n._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[t("h2",{attrs:{id:"一-服务雪崩"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-服务雪崩"}},[n._v("#")]),n._v(" 一：服务雪崩")]),n._v(" "),t("h3",{attrs:{id:"一-服务雪崩产生的原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-服务雪崩产生的原因"}},[n._v("#")]),n._v(" (一)：服务雪崩产生的原因")]),n._v(" "),t("ul",[t("li",[n._v("服务不可用")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("1：硬件故障\n2：程序bug\n3：缓存击穿 (这个要研究一下)\n4：用户大量请求\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br")])]),t("ul",[t("li",[n._v("重试加大流量")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("1：用户重试\n2：代码逻辑重试\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br")])]),t("ul",[t("li",[n._v("服务调用者不可用")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("同步等待造成资源消耗\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("h3",{attrs:{id:"二-服务雪崩应对措施"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-服务雪崩应对措施"}},[n._v("#")]),n._v(" (二)：服务雪崩应对措施")]),n._v(" "),t("ul",[t("li",[n._v("应用扩容")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("加机器\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("ul",[t("li",[n._v("流控")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("1：限流，排队等待\n2：关闭重试\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br")])]),t("ul",[t("li",[n._v("缓存")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("缓存预加载\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("ul",[t("li",[n._v("服务降级")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("1：服务接口拒绝服务\n2：页面拒绝服务\n3：延迟持久化\n4：随机拒绝服务，请稍后重试\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br")])]),t("ul",[t("li",[n._v("服务熔断：服务调用超时")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("h2",{attrs:{id:"二-sentinel的qps限流"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-sentinel的qps限流"}},[n._v("#")]),n._v(" 二：Sentinel的qps限流")]),n._v(" "),t("h3",{attrs:{id:"一-sentinel介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-sentinel介绍"}},[n._v("#")]),n._v(" (一)：sentinel介绍")]),n._v(" "),t("ul",[t("li",[n._v("什么是流量控制")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("\t流量控制(flow control)，其原理是监控资源(Resource)的统计指标，然后根据Token计算策略来计算资源的可用Token(也就是阈值)，然后根据流量控制策略对请求进行控制，避免被瞬时的流量高峰冲垮，从而保障应用的高可用性\n\n\tSentinel 通过定义流控规则来实现对 Resource 的流量控制。在 Sentinel 内部会在加载流控规则时候将每个 flow.Rule 都会被转换成流量控制器(TrafficShapingController)。每个流量控制器实例都会有自己独立的统计结构，这里统计结构是一个滑动窗口。Sentinel 内部会尽可能复用 Resource 级别的全局滑动窗口，如果流控规则的统计设置没法复用Resource的全局统计结构，那么Sentinel会为流量控制器创建一个全新的私有的滑动窗口，然后通过flow.StandaloneStatSlot 这个统计Slot来维护统计指标。\n\t\n\tSentinel 的流量控制组件对Resource的检查结果要么通过，要么会block，对于block的流量相当于拒绝。 \n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br")])]),t("ul",[t("li",[n._v("基本介绍")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("\t几乎覆盖了近10年双11（11.11）购物节的所有核心场景，比如“秒杀”需要限制突发流量到满足系统容量、节流、下游不可靠业务断路、分布式限速等\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("ul",[t("li",[t("p",[n._v("sentinel的Golang版本文档介绍(https://sentinelguard.io/zh-cn/docs/introduction.html)")])]),n._v(" "),t("li",[t("p",[n._v("golang集成到sentinel的示例代码："),t("code",[n._v("sentinel-golang/example/flow/")])])])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("1：qps 流量控制\n2：warm_up 预热\n3：memory_adaptive 内存自适应\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br")])]),t("ul",[t("li",[t("strong",[n._v("先给一个限流示例代码")]),n._v("，主要是演示到了一定的qps后，流量就会被sentinel block")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('import (\n\t"fmt"\n\tsentinel "github.com/alibaba/sentinel-golang/api"\n\t"github.com/alibaba/sentinel-golang/core/base"\n\t"github.com/alibaba/sentinel-golang/core/flow"\n\t"go.uber.org/zap"\n)\n\nfunc main() {\n\n\t// 如果有特定的配置，那么直接指明sentinel.InitWithConfigFile()\n\terr := sentinel.InitDefault()\n\n\tif err != nil {\n\t\tzap.L().Fatal("sentinel init err", zap.Error(err))\n\t}\n\n\t// 定义限流的规则，规则可以配置多个\n\t_, err = flow.LoadRules([]*flow.Rule{\n\t\t{\n\t\t\tResource:               "some-rule1",\n\t\t\tTokenCalculateStrategy: flow.Direct,\n\t\t\tControlBehavior:        flow.Reject,  // 直接拒绝\n\t\t\tThreshold:              10,           // 阈值\n\t\t\tStatIntervalInMs:       1000,         // 表示1000ms\n\t\t},\n\t\t{\n\t\t\tResource:               "some-rule2",\n\t\t\tTokenCalculateStrategy: flow.Direct,  //\n\t\t\tControlBehavior:        flow.Reject,  // 直接决绝\n\t\t\tThreshold:              11,\n\t\t\tStatIntervalInMs:       1000,\n\t\t},\n\t})\n\n\tif err != nil {\n\t\tzap.L().Fatal("rule init err", zap.Error(err))\n\t}\n\n\t// 这里让流量直接被访问12次，使用了some-rule1这个限流规则\n\tfor i:=0;i<12;i++{\n\t\t// 指定使用哪个流控配置作用到入口流量或出口流量\n\t\te, b := sentinel.Entry("some-rule1", sentinel.WithTrafficType(base.Inbound))\n\t\tif b != nil {  // 如果b ！= nil，说明流量被block了\n\t\t\tfmt.Println("被限流")\n\t\t}else {\n\t\t\tfmt.Println("检查通过")\n\t\t\te.Exit()\n\t\t}\n\t}\n\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br"),t("span",{staticClass:"line-number"},[n._v("34")]),t("br"),t("span",{staticClass:"line-number"},[n._v("35")]),t("br"),t("span",{staticClass:"line-number"},[n._v("36")]),t("br"),t("span",{staticClass:"line-number"},[n._v("37")]),t("br"),t("span",{staticClass:"line-number"},[n._v("38")]),t("br"),t("span",{staticClass:"line-number"},[n._v("39")]),t("br"),t("span",{staticClass:"line-number"},[n._v("40")]),t("br"),t("span",{staticClass:"line-number"},[n._v("41")]),t("br"),t("span",{staticClass:"line-number"},[n._v("42")]),t("br"),t("span",{staticClass:"line-number"},[n._v("43")]),t("br"),t("span",{staticClass:"line-number"},[n._v("44")]),t("br"),t("span",{staticClass:"line-number"},[n._v("45")]),t("br"),t("span",{staticClass:"line-number"},[n._v("46")]),t("br"),t("span",{staticClass:"line-number"},[n._v("47")]),t("br"),t("span",{staticClass:"line-number"},[n._v("48")]),t("br"),t("span",{staticClass:"line-number"},[n._v("49")]),t("br"),t("span",{staticClass:"line-number"},[n._v("50")]),t("br"),t("span",{staticClass:"line-number"},[n._v("51")]),t("br"),t("span",{staticClass:"line-number"},[n._v("52")]),t("br")])]),t("ul",[t("li",[n._v("代码执行结果")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n检查通过\n被限流  // 第11次就被限流了\n被限流\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br")])]),t("h3",{attrs:{id:"二-sentinel的预热warm-up功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-sentinel的预热warm-up功能"}},[n._v("#")]),n._v(" (二)：sentinel的预热warm_up功能")]),n._v(" "),t("ul",[t("li",[n._v("模拟warm_up功能")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('import (\n\t"fmt"\n\tsentinel "github.com/alibaba/sentinel-golang/api"\n\t"github.com/alibaba/sentinel-golang/core/base"\n\t"github.com/alibaba/sentinel-golang/core/flow"\n\t"go.uber.org/zap"\n\t"math/rand"\n\t"time"\n)\n\nfunc main() {\n\n\t// 如果有特定的配置，那么直接指明sentinel.InitWithConfigFile()\n\terr := sentinel.InitDefault()\n\n\tif err != nil {\n\t\tzap.L().Fatal("sentinel init err", zap.Error(err))\n\t}\n\n\t// 定义限流的规则，规则可以配置多个\n\t_, err = flow.LoadRules([]*flow.Rule{\n\t\t// 这里是当流量太大，60秒内才会增长到1000\n\t\t{\n\t\t\tResource:               "some-rule1",\n\t\t\tTokenCalculateStrategy: flow.WarmUp, // 冷启动策略\n\t\t\tControlBehavior:        flow.Reject, // 直接拒绝\n\t\t\tThreshold:              1000,        // 阈值\n\t\t\tWarmUpPeriodSec:        60,          // 预热的时长， 60秒增长到1000\n\t\t},\n\t})\n\n\tif err != nil {\n\t\tzap.L().Fatal("rule init err", zap.Error(err))\n\t}\n\n\tvar globalTotal int\n\tvar passTotal int\n\tvar blockTotal int\n\n\tch := make(chan struct{})  // 通道作用是保证主线程不退出\n\n\t// 统计每一秒通过了多少次，block了多少次，一共多少次\n\tfor i:=0;i<100;i++ {\n\t\tgo func() {\n\t\t\tfor  {\n\t\t\t\tglobalTotal++\n\t\t\t\te, b := sentinel.Entry("some-rule1", sentinel.WithTrafficType(base.Inbound))\n\t\t\t\tif b != nil {\n\t\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%10)*time.Millisecond)\n\t\t\t\t\tblockTotal++\n\t\t\t\t} else {\n\t\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%10)*time.Millisecond)\n\t\t\t\t\tpassTotal++\n\t\t\t\t\te.Exit()\n\t\t\t\t}\n\t\t\t}\n\t\t}()\n\t}\n\n\t// 打印全局变量的值\n\tgo func() {\n\n\t\tvar oldTotal int\n\t\tvar oldPass int\n\t\tvar oldBlock int\n\n\t\tfor {\n\t\t\toneSecondTotal := globalTotal - oldTotal\n\t\t\toldTotal = globalTotal\n\n\t\t\toneSecondPass := passTotal - oldPass\n\t\t\toldPass = passTotal\n\n\t\t\toneSecondBlock := blockTotal - oldBlock\n\t\t\toldBlock = blockTotal\n\n\t\t\ttime.Sleep(time.Second)\n\t\t\tfmt.Printf("total:%d, pass:%d, block:%d\\n", oneSecondTotal, oneSecondPass, oneSecondBlock)\n\t\t}\n\t}()\n\n\t<-ch // 主线程会在这里阻塞\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br"),t("span",{staticClass:"line-number"},[n._v("34")]),t("br"),t("span",{staticClass:"line-number"},[n._v("35")]),t("br"),t("span",{staticClass:"line-number"},[n._v("36")]),t("br"),t("span",{staticClass:"line-number"},[n._v("37")]),t("br"),t("span",{staticClass:"line-number"},[n._v("38")]),t("br"),t("span",{staticClass:"line-number"},[n._v("39")]),t("br"),t("span",{staticClass:"line-number"},[n._v("40")]),t("br"),t("span",{staticClass:"line-number"},[n._v("41")]),t("br"),t("span",{staticClass:"line-number"},[n._v("42")]),t("br"),t("span",{staticClass:"line-number"},[n._v("43")]),t("br"),t("span",{staticClass:"line-number"},[n._v("44")]),t("br"),t("span",{staticClass:"line-number"},[n._v("45")]),t("br"),t("span",{staticClass:"line-number"},[n._v("46")]),t("br"),t("span",{staticClass:"line-number"},[n._v("47")]),t("br"),t("span",{staticClass:"line-number"},[n._v("48")]),t("br"),t("span",{staticClass:"line-number"},[n._v("49")]),t("br"),t("span",{staticClass:"line-number"},[n._v("50")]),t("br"),t("span",{staticClass:"line-number"},[n._v("51")]),t("br"),t("span",{staticClass:"line-number"},[n._v("52")]),t("br"),t("span",{staticClass:"line-number"},[n._v("53")]),t("br"),t("span",{staticClass:"line-number"},[n._v("54")]),t("br"),t("span",{staticClass:"line-number"},[n._v("55")]),t("br"),t("span",{staticClass:"line-number"},[n._v("56")]),t("br"),t("span",{staticClass:"line-number"},[n._v("57")]),t("br"),t("span",{staticClass:"line-number"},[n._v("58")]),t("br"),t("span",{staticClass:"line-number"},[n._v("59")]),t("br"),t("span",{staticClass:"line-number"},[n._v("60")]),t("br"),t("span",{staticClass:"line-number"},[n._v("61")]),t("br"),t("span",{staticClass:"line-number"},[n._v("62")]),t("br"),t("span",{staticClass:"line-number"},[n._v("63")]),t("br"),t("span",{staticClass:"line-number"},[n._v("64")]),t("br"),t("span",{staticClass:"line-number"},[n._v("65")]),t("br"),t("span",{staticClass:"line-number"},[n._v("66")]),t("br"),t("span",{staticClass:"line-number"},[n._v("67")]),t("br"),t("span",{staticClass:"line-number"},[n._v("68")]),t("br"),t("span",{staticClass:"line-number"},[n._v("69")]),t("br"),t("span",{staticClass:"line-number"},[n._v("70")]),t("br"),t("span",{staticClass:"line-number"},[n._v("71")]),t("br"),t("span",{staticClass:"line-number"},[n._v("72")]),t("br"),t("span",{staticClass:"line-number"},[n._v("73")]),t("br"),t("span",{staticClass:"line-number"},[n._v("74")]),t("br"),t("span",{staticClass:"line-number"},[n._v("75")]),t("br"),t("span",{staticClass:"line-number"},[n._v("76")]),t("br"),t("span",{staticClass:"line-number"},[n._v("77")]),t("br"),t("span",{staticClass:"line-number"},[n._v("78")]),t("br"),t("span",{staticClass:"line-number"},[n._v("79")]),t("br"),t("span",{staticClass:"line-number"},[n._v("80")]),t("br"),t("span",{staticClass:"line-number"},[n._v("81")]),t("br"),t("span",{staticClass:"line-number"},[n._v("82")]),t("br"),t("span",{staticClass:"line-number"},[n._v("83")]),t("br")])]),t("ul",[t("li",[n._v("打印结果：可以看到pass是逐渐递增，最终到1000")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("total:21633, pass:338, block:21302\ntotal:21495, pass:343, block:21157\ntotal:21693, pass:346, block:21348\ntotal:21744, pass:346, block:21403\ntotal:21768, pass:348, block:21427\ntotal:21727, pass:350, block:21387\ntotal:21268, pass:357, block:20910\ntotal:21693, pass:354, block:21342\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br")])]),t("h3",{attrs:{id:"三-sentinel的匀速通过throttling功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-sentinel的匀速通过throttling功能"}},[n._v("#")]),n._v(" (三)：sentinel的匀速通过Throttling功能")]),n._v(" "),t("ul",[t("li",[n._v("匀速通过的意义在于：如果流量猛增，那么Throttling只允许匀速的流量通过，那么猛增的流量将会被block掉，只需要修改配置规则即可")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('// 定义限流的规则，规则可以配置多个\n_, err = flow.LoadRules([]*flow.Rule{\n\t{\n\t\tResource:               "some-rule1",\n\t\tTokenCalculateStrategy: flow.Direct,\n\t\tControlBehavior:        flow.Throttling,  // 匀速通过\n\t\tThreshold:              10,               // 阈值\n\t\tStatIntervalInMs:       1000,             // 表示1000ms\n\t},\n})\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br")])]),t("h2",{attrs:{id:"三-sentinel的熔断机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-sentinel的熔断机制"}},[n._v("#")]),n._v(" 三：Sentinel的熔断机制")]),n._v(" "),t("h3",{attrs:{id:"一-error-count熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-error-count熔断"}},[n._v("#")]),n._v(" (一)：error count熔断")]),n._v(" "),t("ul",[t("li",[t("p",[n._v("出现多少次错误后，拒绝服务，启动熔断")])]),n._v(" "),t("li",[t("p",[n._v("示例代码在"),t("code",[n._v("sentinel-golang/example/circuitbreaker/")]),n._v("库")])]),n._v(" "),t("li",[t("p",[n._v("出现错误的熔断代码示例，在"),t("code",[n._v("sentinel-golang/example/circuitbreaker/error_count/circuit_breaker_error_count_example.go")]),n._v("基础上添加了统计数据")])])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('package main\n\nimport (\n\t"errors"\n\t"fmt"\n\t"log"\n\t"math/rand"\n\t"time"\n\n\tsentinel "github.com/alibaba/sentinel-golang/api"\n\t"github.com/alibaba/sentinel-golang/core/circuitbreaker"\n\t"github.com/alibaba/sentinel-golang/core/config"\n\t"github.com/alibaba/sentinel-golang/logging"\n\t"github.com/alibaba/sentinel-golang/util"\n)\n\ntype stateChangeTestListener struct {\n}\n\nfunc (s *stateChangeTestListener) OnTransformToClosed(prev circuitbreaker.State, rule circuitbreaker.Rule) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Closed, time: %d\\n", rule.Strategy, prev.String(), util.CurrentTimeMillis())\n}\n\nfunc (s *stateChangeTestListener) OnTransformToOpen(prev circuitbreaker.State, rule circuitbreaker.Rule, snapshot interface{}) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Open, snapshot: %d, time: %d\\n", rule.Strategy, prev.String(), snapshot, util.CurrentTimeMillis())\n}\n\nfunc (s *stateChangeTestListener) OnTransformToHalfOpen(prev circuitbreaker.State, rule circuitbreaker.Rule) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Half-Open, time: %d\\n", rule.Strategy, prev.String(), util.CurrentTimeMillis())\n}\n\nfunc main() {\n\n\ttotal := 0\n\ttotalPass := 0\n\ttotalBlock := 0\n\ttotalErr := 0\n\n\t// 创建配置\n\tconf := config.NewDefaultConfig()\n\tconf.Sentinel.Log.Logger = logging.NewConsoleLogger()\n\t// 加载配置\n\terr := sentinel.InitWithConfig(conf)\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tch := make(chan struct{})\n\n\tcircuitbreaker.RegisterStateChangeListeners(&stateChangeTestListener{})\n\n\t_, err = circuitbreaker.LoadRules([]*circuitbreaker.Rule{\n\t\t{\n\t\t\tResource:                     "abc",\n\t\t\tStrategy:                     circuitbreaker.ErrorCount,\n\t\t\tRetryTimeoutMs:               3000, // 3s就尝试恢复\n\t\t\tMinRequestAmount:             10,   // 静默数\n\t\t\tStatIntervalMs:               5000, // 5秒统计一次\n\t\t\tThreshold:                    50,   // 出现50个错误就出现熔断\n\t\t},\n\t})\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tlogging.Info("[CircuitBreaker ErrorCount] Sentinel Go circuit breaking demo is running. You may see the pass/block metric in the metric log.")\n\n\tgo func() {\n\t\tfor {\n\t\t\ttotal++\n\t\t\t// 添加限流机制\n\t\t\te, b := sentinel.Entry("abc")\n\t\t\tif b != nil {\n\t\t\t\ttotalBlock++\n\t\t\t\tfmt.Println("协程熔断了...")\n\t\t\t\t// g1 blocked\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%20) * time.Millisecond)\n\t\t\t} else {\n\t\t\t\ttotalPass++\n\t\t\t\tif rand.Uint64()%20 > 9 {\n\t\t\t\t\ttotalErr++\n\t\t\t\t\t// 创建错误\n\t\t\t\t\tsentinel.TraceError(e, errors.New("biz error"))\n\t\t\t\t}\n\t\t\t\t// g1 passed\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%10+10) * time.Millisecond)\n\t\t\t\te.Exit()\n\t\t\t}\n\t\t}\n\t}()\n\n\tgo func() {\n\t\tfor {\n\t\t\te, b := sentinel.Entry("abc")\n\t\t\tif b != nil {\n\t\t\t\ttotalBlock++\n\t\t\t\t// g2 blocked\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%20) * time.Millisecond)\n\t\t\t} else {\n\t\t\t\t// g2 passed\n\t\t\t\ttotalPass++\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%80) * time.Millisecond)\n\t\t\t\te.Exit()\n\t\t\t}\n\t\t}\n\t}()\n\n\tgo func() {\n\t\tfor  {\n\t\t\tfmt.Printf("出现的错误数: %d\\n", totalErr)\n\t\t\ttime.Sleep(time.Second)\n\t\t}\n\t}()\n\n\t<-ch\n\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br"),t("span",{staticClass:"line-number"},[n._v("34")]),t("br"),t("span",{staticClass:"line-number"},[n._v("35")]),t("br"),t("span",{staticClass:"line-number"},[n._v("36")]),t("br"),t("span",{staticClass:"line-number"},[n._v("37")]),t("br"),t("span",{staticClass:"line-number"},[n._v("38")]),t("br"),t("span",{staticClass:"line-number"},[n._v("39")]),t("br"),t("span",{staticClass:"line-number"},[n._v("40")]),t("br"),t("span",{staticClass:"line-number"},[n._v("41")]),t("br"),t("span",{staticClass:"line-number"},[n._v("42")]),t("br"),t("span",{staticClass:"line-number"},[n._v("43")]),t("br"),t("span",{staticClass:"line-number"},[n._v("44")]),t("br"),t("span",{staticClass:"line-number"},[n._v("45")]),t("br"),t("span",{staticClass:"line-number"},[n._v("46")]),t("br"),t("span",{staticClass:"line-number"},[n._v("47")]),t("br"),t("span",{staticClass:"line-number"},[n._v("48")]),t("br"),t("span",{staticClass:"line-number"},[n._v("49")]),t("br"),t("span",{staticClass:"line-number"},[n._v("50")]),t("br"),t("span",{staticClass:"line-number"},[n._v("51")]),t("br"),t("span",{staticClass:"line-number"},[n._v("52")]),t("br"),t("span",{staticClass:"line-number"},[n._v("53")]),t("br"),t("span",{staticClass:"line-number"},[n._v("54")]),t("br"),t("span",{staticClass:"line-number"},[n._v("55")]),t("br"),t("span",{staticClass:"line-number"},[n._v("56")]),t("br"),t("span",{staticClass:"line-number"},[n._v("57")]),t("br"),t("span",{staticClass:"line-number"},[n._v("58")]),t("br"),t("span",{staticClass:"line-number"},[n._v("59")]),t("br"),t("span",{staticClass:"line-number"},[n._v("60")]),t("br"),t("span",{staticClass:"line-number"},[n._v("61")]),t("br"),t("span",{staticClass:"line-number"},[n._v("62")]),t("br"),t("span",{staticClass:"line-number"},[n._v("63")]),t("br"),t("span",{staticClass:"line-number"},[n._v("64")]),t("br"),t("span",{staticClass:"line-number"},[n._v("65")]),t("br"),t("span",{staticClass:"line-number"},[n._v("66")]),t("br"),t("span",{staticClass:"line-number"},[n._v("67")]),t("br"),t("span",{staticClass:"line-number"},[n._v("68")]),t("br"),t("span",{staticClass:"line-number"},[n._v("69")]),t("br"),t("span",{staticClass:"line-number"},[n._v("70")]),t("br"),t("span",{staticClass:"line-number"},[n._v("71")]),t("br"),t("span",{staticClass:"line-number"},[n._v("72")]),t("br"),t("span",{staticClass:"line-number"},[n._v("73")]),t("br"),t("span",{staticClass:"line-number"},[n._v("74")]),t("br"),t("span",{staticClass:"line-number"},[n._v("75")]),t("br"),t("span",{staticClass:"line-number"},[n._v("76")]),t("br"),t("span",{staticClass:"line-number"},[n._v("77")]),t("br"),t("span",{staticClass:"line-number"},[n._v("78")]),t("br"),t("span",{staticClass:"line-number"},[n._v("79")]),t("br"),t("span",{staticClass:"line-number"},[n._v("80")]),t("br"),t("span",{staticClass:"line-number"},[n._v("81")]),t("br"),t("span",{staticClass:"line-number"},[n._v("82")]),t("br"),t("span",{staticClass:"line-number"},[n._v("83")]),t("br"),t("span",{staticClass:"line-number"},[n._v("84")]),t("br"),t("span",{staticClass:"line-number"},[n._v("85")]),t("br"),t("span",{staticClass:"line-number"},[n._v("86")]),t("br"),t("span",{staticClass:"line-number"},[n._v("87")]),t("br"),t("span",{staticClass:"line-number"},[n._v("88")]),t("br"),t("span",{staticClass:"line-number"},[n._v("89")]),t("br"),t("span",{staticClass:"line-number"},[n._v("90")]),t("br"),t("span",{staticClass:"line-number"},[n._v("91")]),t("br"),t("span",{staticClass:"line-number"},[n._v("92")]),t("br"),t("span",{staticClass:"line-number"},[n._v("93")]),t("br"),t("span",{staticClass:"line-number"},[n._v("94")]),t("br"),t("span",{staticClass:"line-number"},[n._v("95")]),t("br"),t("span",{staticClass:"line-number"},[n._v("96")]),t("br"),t("span",{staticClass:"line-number"},[n._v("97")]),t("br"),t("span",{staticClass:"line-number"},[n._v("98")]),t("br"),t("span",{staticClass:"line-number"},[n._v("99")]),t("br"),t("span",{staticClass:"line-number"},[n._v("100")]),t("br"),t("span",{staticClass:"line-number"},[n._v("101")]),t("br"),t("span",{staticClass:"line-number"},[n._v("102")]),t("br"),t("span",{staticClass:"line-number"},[n._v("103")]),t("br"),t("span",{staticClass:"line-number"},[n._v("104")]),t("br"),t("span",{staticClass:"line-number"},[n._v("105")]),t("br"),t("span",{staticClass:"line-number"},[n._v("106")]),t("br"),t("span",{staticClass:"line-number"},[n._v("107")]),t("br"),t("span",{staticClass:"line-number"},[n._v("108")]),t("br"),t("span",{staticClass:"line-number"},[n._v("109")]),t("br"),t("span",{staticClass:"line-number"},[n._v("110")]),t("br"),t("span",{staticClass:"line-number"},[n._v("111")]),t("br"),t("span",{staticClass:"line-number"},[n._v("112")]),t("br"),t("span",{staticClass:"line-number"},[n._v("113")]),t("br"),t("span",{staticClass:"line-number"},[n._v("114")]),t("br"),t("span",{staticClass:"line-number"},[n._v("115")]),t("br"),t("span",{staticClass:"line-number"},[n._v("116")]),t("br"),t("span",{staticClass:"line-number"},[n._v("117")]),t("br"),t("span",{staticClass:"line-number"},[n._v("118")]),t("br"),t("span",{staticClass:"line-number"},[n._v("119")]),t("br")])]),t("h3",{attrs:{id:"二-error-ratio熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-error-ratio熔断"}},[n._v("#")]),n._v(" (二)：error ratio熔断")]),n._v(" "),t("ul",[t("li",[t("p",[n._v("出现错误比率高达多少后，拒绝服务，启动熔断")])]),n._v(" "),t("li",[t("p",[n._v("示例代码")])])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('package main\n\nimport (\n\t"errors"\n\t"fmt"\n\t"log"\n\t"math/rand"\n\t"time"\n\n\tsentinel "github.com/alibaba/sentinel-golang/api"\n\t"github.com/alibaba/sentinel-golang/core/circuitbreaker"\n\t"github.com/alibaba/sentinel-golang/core/config"\n\t"github.com/alibaba/sentinel-golang/logging"\n\t"github.com/alibaba/sentinel-golang/util"\n)\n\ntype stateChangeTestListener struct {\n}\n\nfunc (s *stateChangeTestListener) OnTransformToClosed(prev circuitbreaker.State, rule circuitbreaker.Rule) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Closed, time: %d\\n", rule.Strategy, prev.String(), util.CurrentTimeMillis())\n}\n\nfunc (s *stateChangeTestListener) OnTransformToOpen(prev circuitbreaker.State, rule circuitbreaker.Rule, snapshot interface{}) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Open, snapshot: %d, time: %d\\n", rule.Strategy, prev.String(), snapshot, util.CurrentTimeMillis())\n}\n\nfunc (s *stateChangeTestListener) OnTransformToHalfOpen(prev circuitbreaker.State, rule circuitbreaker.Rule) {\n\tfmt.Printf("rule.steategy: %+v, From %s to Half-Open, time: %d\\n", rule.Strategy, prev.String(), util.CurrentTimeMillis())\n}\n\nfunc main() {\n\t\n\n\t// 创建配置\n\tconf := config.NewDefaultConfig()\n\tconf.Sentinel.Log.Logger = logging.NewConsoleLogger()\n\t// 加载配置\n\terr := sentinel.InitWithConfig(conf)\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tch := make(chan struct{})\n\n\tcircuitbreaker.RegisterStateChangeListeners(&stateChangeTestListener{})\n\n\t_, err = circuitbreaker.LoadRules([]*circuitbreaker.Rule{\n\t\t{\n\t\t\tResource:                     "abc",\n\t\t\tStrategy:                     circuitbreaker.ErrorRatio, // 设置为错误速率\n\t\t\tRetryTimeoutMs:               3000,\n\t\t\tMinRequestAmount:             10,\n\t\t\tStatIntervalMs:               5000,\n\t\t\tThreshold:                    0.4,  // 设置40%的错误比率就熔断\n\t\t},\n\t})\n\n\tif err != nil {\n\t\tlog.Fatal(err)\n\t}\n\n\tlogging.Info("[CircuitBreaker ErrorCount] Sentinel Go circuit breaking demo is running. You may see the pass/block metric in the metric log.")\n\n\tgo func() {\n\t\tfor {\n\t\t\t// 添加限流机制\n\t\t\te, b := sentinel.Entry("abc")\n\t\t\tif b != nil {\n\t\t\t\tfmt.Println("协程熔断了...")\n\t\t\t\t// g1 blocked\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%20) * time.Millisecond)\n\t\t\t} else {\n\t\t\t\tif rand.Uint64()%20 > 9 {\n\t\t\t\t\tsentinel.TraceError(e, errors.New("biz error"))\n\t\t\t\t}\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%60+10) * time.Millisecond)\n\t\t\t\te.Exit()\n\t\t\t}\n\t\t}\n\t}()\n\n\tgo func() {\n\t\tfor {\n\t\t\te, b := sentinel.Entry("abc")\n\t\t\tif b != nil {\n\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%20) * time.Millisecond)\n\t\t\t} else {\n\t\t\t\ttime.Sleep(time.Duration(rand.Uint64()%80) * time.Millisecond)\n\t\t\t\te.Exit()\n\t\t\t}\n\t\t}\n\t}()\n\n\n\t<-ch\n\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br"),t("span",{staticClass:"line-number"},[n._v("34")]),t("br"),t("span",{staticClass:"line-number"},[n._v("35")]),t("br"),t("span",{staticClass:"line-number"},[n._v("36")]),t("br"),t("span",{staticClass:"line-number"},[n._v("37")]),t("br"),t("span",{staticClass:"line-number"},[n._v("38")]),t("br"),t("span",{staticClass:"line-number"},[n._v("39")]),t("br"),t("span",{staticClass:"line-number"},[n._v("40")]),t("br"),t("span",{staticClass:"line-number"},[n._v("41")]),t("br"),t("span",{staticClass:"line-number"},[n._v("42")]),t("br"),t("span",{staticClass:"line-number"},[n._v("43")]),t("br"),t("span",{staticClass:"line-number"},[n._v("44")]),t("br"),t("span",{staticClass:"line-number"},[n._v("45")]),t("br"),t("span",{staticClass:"line-number"},[n._v("46")]),t("br"),t("span",{staticClass:"line-number"},[n._v("47")]),t("br"),t("span",{staticClass:"line-number"},[n._v("48")]),t("br"),t("span",{staticClass:"line-number"},[n._v("49")]),t("br"),t("span",{staticClass:"line-number"},[n._v("50")]),t("br"),t("span",{staticClass:"line-number"},[n._v("51")]),t("br"),t("span",{staticClass:"line-number"},[n._v("52")]),t("br"),t("span",{staticClass:"line-number"},[n._v("53")]),t("br"),t("span",{staticClass:"line-number"},[n._v("54")]),t("br"),t("span",{staticClass:"line-number"},[n._v("55")]),t("br"),t("span",{staticClass:"line-number"},[n._v("56")]),t("br"),t("span",{staticClass:"line-number"},[n._v("57")]),t("br"),t("span",{staticClass:"line-number"},[n._v("58")]),t("br"),t("span",{staticClass:"line-number"},[n._v("59")]),t("br"),t("span",{staticClass:"line-number"},[n._v("60")]),t("br"),t("span",{staticClass:"line-number"},[n._v("61")]),t("br"),t("span",{staticClass:"line-number"},[n._v("62")]),t("br"),t("span",{staticClass:"line-number"},[n._v("63")]),t("br"),t("span",{staticClass:"line-number"},[n._v("64")]),t("br"),t("span",{staticClass:"line-number"},[n._v("65")]),t("br"),t("span",{staticClass:"line-number"},[n._v("66")]),t("br"),t("span",{staticClass:"line-number"},[n._v("67")]),t("br"),t("span",{staticClass:"line-number"},[n._v("68")]),t("br"),t("span",{staticClass:"line-number"},[n._v("69")]),t("br"),t("span",{staticClass:"line-number"},[n._v("70")]),t("br"),t("span",{staticClass:"line-number"},[n._v("71")]),t("br"),t("span",{staticClass:"line-number"},[n._v("72")]),t("br"),t("span",{staticClass:"line-number"},[n._v("73")]),t("br"),t("span",{staticClass:"line-number"},[n._v("74")]),t("br"),t("span",{staticClass:"line-number"},[n._v("75")]),t("br"),t("span",{staticClass:"line-number"},[n._v("76")]),t("br"),t("span",{staticClass:"line-number"},[n._v("77")]),t("br"),t("span",{staticClass:"line-number"},[n._v("78")]),t("br"),t("span",{staticClass:"line-number"},[n._v("79")]),t("br"),t("span",{staticClass:"line-number"},[n._v("80")]),t("br"),t("span",{staticClass:"line-number"},[n._v("81")]),t("br"),t("span",{staticClass:"line-number"},[n._v("82")]),t("br"),t("span",{staticClass:"line-number"},[n._v("83")]),t("br"),t("span",{staticClass:"line-number"},[n._v("84")]),t("br"),t("span",{staticClass:"line-number"},[n._v("85")]),t("br"),t("span",{staticClass:"line-number"},[n._v("86")]),t("br"),t("span",{staticClass:"line-number"},[n._v("87")]),t("br"),t("span",{staticClass:"line-number"},[n._v("88")]),t("br"),t("span",{staticClass:"line-number"},[n._v("89")]),t("br"),t("span",{staticClass:"line-number"},[n._v("90")]),t("br"),t("span",{staticClass:"line-number"},[n._v("91")]),t("br"),t("span",{staticClass:"line-number"},[n._v("92")]),t("br"),t("span",{staticClass:"line-number"},[n._v("93")]),t("br"),t("span",{staticClass:"line-number"},[n._v("94")]),t("br"),t("span",{staticClass:"line-number"},[n._v("95")]),t("br"),t("span",{staticClass:"line-number"},[n._v("96")]),t("br"),t("span",{staticClass:"line-number"},[n._v("97")]),t("br"),t("span",{staticClass:"line-number"},[n._v("98")]),t("br"),t("span",{staticClass:"line-number"},[n._v("99")]),t("br"),t("span",{staticClass:"line-number"},[n._v("100")]),t("br")])]),t("h2",{attrs:{id:"四-在goods-web服务中集成sentinel"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-在goods-web服务中集成sentinel"}},[n._v("#")]),n._v(" 四：在goods_web服务中集成Sentinel")]),n._v(" "),t("h3",{attrs:{id:"一-在goods-web服务中修改"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-在goods-web服务中修改"}},[n._v("#")]),n._v(" (一)：在goods_web服务中修改")]),n._v(" "),t("ul",[t("li",[n._v("创建"),t("code",[n._v("goods_web/initailize/sentinel.go")]),n._v("文件，初始化sentinel，代码如下")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('package initailize\n\nimport (\n\tsentinel "github.com/alibaba/sentinel-golang/api"\n\t"github.com/alibaba/sentinel-golang/core/flow"\n\t"go.uber.org/zap"\n)\n\n// InitSentinel 初始化\nfunc InitSentinel()  {\n\t// 如果有特定的配置，那么直接指明sentinel.InitWithConfigFile()\n\terr := sentinel.InitDefault()\n\n\tif err != nil {\n\t\tzap.L().Fatal("sentinel init err", zap.Error(err))\n\t}\n\n\t// 定义限流的规则，规则可以配置多个\n\t// 这里其实使用nacos会比较好\n\t_, err = flow.LoadRules([]*flow.Rule{\n\t\t{\n\t\t\tResource:               "goods-list",\n\t\t\tTokenCalculateStrategy: flow.Direct,\n\t\t\tControlBehavior:        flow.Reject,     // 超过阈值，直接拒绝\n\t\t\tThreshold:              3,               // 阈值\n\t\t\tStatIntervalInMs:       5000,            // 表示5000ms\n\t\t},\n\t})\n\n\tif err != nil {\n\t\tzap.L().Fatal("rule init err", zap.Error(err))\n\t}\n}\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br"),t("span",{staticClass:"line-number"},[n._v("22")]),t("br"),t("span",{staticClass:"line-number"},[n._v("23")]),t("br"),t("span",{staticClass:"line-number"},[n._v("24")]),t("br"),t("span",{staticClass:"line-number"},[n._v("25")]),t("br"),t("span",{staticClass:"line-number"},[n._v("26")]),t("br"),t("span",{staticClass:"line-number"},[n._v("27")]),t("br"),t("span",{staticClass:"line-number"},[n._v("28")]),t("br"),t("span",{staticClass:"line-number"},[n._v("29")]),t("br"),t("span",{staticClass:"line-number"},[n._v("30")]),t("br"),t("span",{staticClass:"line-number"},[n._v("31")]),t("br"),t("span",{staticClass:"line-number"},[n._v("32")]),t("br"),t("span",{staticClass:"line-number"},[n._v("33")]),t("br")])]),t("ul",[t("li",[n._v("在main.go中，调用初始化函数")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("// 5：初始化sentinel\ninitailize.InitSentinel()\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br")])]),t("ul",[t("li",[n._v("如果现在想对"),t("code",[n._v("商品列表")]),n._v("接口进行流量控制，那么修改"),t("code",[n._v("goods_web/api/goods/goods.go")]),n._v("文件，在grpc调用的地方加上sentinel流控上下文")])]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v('\t// 使用初始化过程中注册的sentinel规则, 限速的上下文【从这里开始】\n\te, b := sentinel.Entry("goods-list", sentinel.WithTrafficType(base.Inbound))\n\tif b != nil{ // 如果接口被限流阻塞\n\t\tc.JSON(http.StatusTooManyRequests, gin.H{\n\t\t\t"msg": "服务器繁忙，请稍后重试",\n\t\t})\n\t\treturn\n\t}\n\n\t// 将gin的ctx封装到context中\n\tlocalCtx := context.WithValue(context.Background(), "ginContext", c)\n\t// 如果gRPC有错误，熔断器会自动记录err错误\n\tgoodsInfos, err := goodsSrvClient.GoodsList(localCtx, request)\n\t// 如果调用接口有错误, 直接使用http的错误返回\n\tif err != nil {\n\t\tzap.L().Error("goodsSrvClient.GoodsList Error 服务不可达", zap.Error(err))\n\t\tapi.HandleGrpcErrorToHttp(c, err)\n\t\treturn\n\t}\n\t// 熔断的上下文【在这里结束】\n\te.Exit()\n')])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br"),t("span",{staticClass:"line-number"},[n._v("2")]),t("br"),t("span",{staticClass:"line-number"},[n._v("3")]),t("br"),t("span",{staticClass:"line-number"},[n._v("4")]),t("br"),t("span",{staticClass:"line-number"},[n._v("5")]),t("br"),t("span",{staticClass:"line-number"},[n._v("6")]),t("br"),t("span",{staticClass:"line-number"},[n._v("7")]),t("br"),t("span",{staticClass:"line-number"},[n._v("8")]),t("br"),t("span",{staticClass:"line-number"},[n._v("9")]),t("br"),t("span",{staticClass:"line-number"},[n._v("10")]),t("br"),t("span",{staticClass:"line-number"},[n._v("11")]),t("br"),t("span",{staticClass:"line-number"},[n._v("12")]),t("br"),t("span",{staticClass:"line-number"},[n._v("13")]),t("br"),t("span",{staticClass:"line-number"},[n._v("14")]),t("br"),t("span",{staticClass:"line-number"},[n._v("15")]),t("br"),t("span",{staticClass:"line-number"},[n._v("16")]),t("br"),t("span",{staticClass:"line-number"},[n._v("17")]),t("br"),t("span",{staticClass:"line-number"},[n._v("18")]),t("br"),t("span",{staticClass:"line-number"},[n._v("19")]),t("br"),t("span",{staticClass:"line-number"},[n._v("20")]),t("br"),t("span",{staticClass:"line-number"},[n._v("21")]),t("br")])]),t("ul",[t("li",[n._v("此时，3次请求"),t("code",[n._v("商品列表")]),n._v("的时候出现错误，就可以发现，客户端已经被熔断了")])]),n._v(" "),t("h2",{attrs:{id:"五-在goods-srv服务中集成-限流和熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五-在goods-srv服务中集成-限流和熔断"}},[n._v("#")]),n._v(" 五：在goods_srv服务中集成 限流和熔断")]),n._v(" "),t("h3",{attrs:{id:"一-使用pybreaker在python中进行熔断"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-使用pybreaker在python中进行熔断"}},[n._v("#")]),n._v(" (一)：使用pybreaker在Python中进行熔断")]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("用到了再查\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])]),t("h3",{attrs:{id:"二-使用ratelimit在python中进行限流"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-使用ratelimit在python中进行限流"}},[n._v("#")]),n._v(" (二)：使用ratelimit在Python中进行限流")]),n._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[n._v("用到了再查\n")])]),n._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[n._v("1")]),t("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);