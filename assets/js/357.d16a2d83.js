(window.webpackJsonp=window.webpackJsonp||[]).push([[357],{2204:function(n,t,s){"use strict";s.r(t);var a=s(9),e=Object(a.a)({},(function(){var n=this,t=n.$createElement,s=n._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[s("ul",[s("li",[n._v("在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。 当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应该迅速退出，然后系统才能释放这些 goroutine 占用的资源")])]),n._v(" "),s("h2",{attrs:{id:"一-为什么需要context"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-为什么需要context"}},[n._v("#")]),n._v(" 一：为什么需要Context")]),n._v(" "),s("h3",{attrs:{id:"一-context初识"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-context初识"}},[n._v("#")]),n._v(" (一)：Context初识")]),n._v(" "),s("ul",[s("li",[n._v("介绍")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("\tGo1.7加入了一个新的标准库context，它定义了Context类型，专门用来简化 对于处理单个请求的多个 goroutine 之间与请求域的数据、取消信号、截止时间等相关操作，这些操作可能涉及多个 API 调用。\n\t对服务器传入的请求应该创建上下文，而对服务器的传出调用应该接受上下文。它们之间的函数调用链必须传递上下文，或者可以使用WithCancel、WithDeadline、WithTimeout或WithValue创建的派生上下文。当一个上下文被取消时，它派生的所有上下文也被取消。\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("h3",{attrs:{id:"二-context接口和接口中定义的方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二-context接口和接口中定义的方法"}},[n._v("#")]),n._v(" (二)：Context接口和接口中定义的方法")]),n._v(" "),s("ul",[s("li",[n._v("context.Context是一个接口，该接口定义了四个需要实现的方法。具体签名如下：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("type Context interface {\n    Deadline() (deadline time.Time, ok bool)\n    Done() <-chan struct{}\n    Err() error\n    Value(key interface{}) interface{}\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br")])]),s("ul",[s("li",[s("p",[n._v("Deadline方法会返回当前Context被取消的时间，也就是完成工作的截止时间（deadline），当外部调用cancelFunc的时候，可以获取到这个时间点")])]),n._v(" "),s("li",[s("p",[n._v("Done方法需要返回一个Channel，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用Done方法会返回同一个Channel，当外部调用cancelFunc的时候，可以这个channel获取到struct{}{}空结构，下面代码是ctx.Done()应用点，判断context的超时")])])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('select {\n    case <-ch:\n        return nil\n\n    case <-ctx.Done(): // 当外部调用cancelFunc的时候，返回空结构\n        return errors.New("timeout")\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br")])]),s("ul",[s("li",[n._v("Err方法会返回当前Context结束的原因，它只会在Done返回的Channel被关闭时才会返回非空的值")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("如果当前Context被取消就会返回Canceled错误；\n如果当前Context超时就会返回DeadlineExceeded错误；\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br")])]),s("ul",[s("li",[n._v("Value方法会从Context中返回键对应的值，对于同一个上下文来说，多次调用Value 并传入相同的Key会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据。比如说Grpc中传递数据")])]),n._v(" "),s("h3",{attrs:{id:"三-background-和todo-的区别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三-background-和todo-的区别"}},[n._v("#")]),n._v(" (三)：Background()和TODO()的区别")]),n._v(" "),s("ul",[s("li",[n._v("Go内置两个函数：Background()和TODO()，这两个函数分别返回一个实现了Context接口的background和todo。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的partent context，衍生出更多的子上下文对象")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("Background()主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context\n\nTODO()，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个\n\nbackground和todo本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br")])]),s("h2",{attrs:{id:"二-with系列函数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二-with系列函数"}},[n._v("#")]),n._v(" 二：With系列函数")]),n._v(" "),s("ul",[s("li",[n._v("context包中还定义了四个With系列函数")])]),n._v(" "),s("h3",{attrs:{id:"一-withcancel"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-withcancel"}},[n._v("#")]),n._v(" (一)：WithCancel")]),n._v(" "),s("ul",[s("li",[n._v("WithCancel的函数签名如下：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("func WithCancel(parent Context) (ctx Context, cancel CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("ul",[s("li",[n._v("示例代码")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("func gen(ctx context.Context) <-chan int {\n\n\tdst := make(chan int)\n\tn := 1\n\t// 线程并发\n\tgo func() {\n\t\tfor {\n\t\t\t// select 有通道可以获取数据，就不会阻塞\n\t\t\tselect {\n\t\t\t// main函数中调用cancel函数，<-ctx.Done() 读取的元素struct{}{}，会执行return语句，跳出函数，避免goroutine泄漏\n\t\t\tcase <-ctx.Done():\n\t\t\t\treturn // 这里的return是跳出函数\n\t\t\tcase dst <- n:\n\t\t\t\tn++\n\t\t\t}\n\t\t}\n\t}()\n\t\n\treturn dst\n}\n\nfunc main() {\n\t\n\t// context.Background()作为Context这个树结构的最顶层的Context\n\tctx, cancel := context.WithCancel(context.Background())\n\t// 当我们取完需要的整数后调用cancel\n\tdefer cancel()\n\t\n\t// gen返回的是一个chan\n\tfor n := range gen(ctx) {\n\t\tfmt.Println(n)\n\t\tif n == 5 {\n\t\t\tbreak\n\t\t}\n\t}\n}\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br")])]),s("ul",[s("li",[n._v("对上面代码的分析")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("\tgen(ctx)函数返回一个通道，for循环遍历这个通道，遍历到n=5时，调用defer cancel，关闭上下文，在goroutine中，ctx.Done()返回struct {}{}，此时goroutine也会停止，避免goroutine发生泄漏\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("h3",{attrs:{id:"二-withdeadline"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二-withdeadline"}},[n._v("#")]),n._v(" (二)：WithDeadline")]),n._v(" "),s("ul",[s("li",[n._v("WithDeadline的函数签名如下：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("ul",[s("li",[n._v("示例代码")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('func main() {\n\n\t// d是一个context过期的时间点\n\td := time.Now().Add(50 * time.Millisecond)\n\t\n\tctx, cancel := context.WithDeadline(context.Background(), d)\n\n\t// 尽管ctx会过期，但在任何情况下调用它的cancel函数都是很好的实践,如果不这样做，可能会使上下文及其父类存活的时间超过必要的时间\n\tdefer cancel()\n\n\tselect {\n\t// 等1秒\n\tcase <-time.After(1 * time.Second):\n\t\tfmt.Println("overslept")\n\n\t// 如果超过了过期时间，那么ctx.Done()返回1\n\tcase <-ctx.Done():\n\t\tfmt.Println(ctx.Err())\n\t}\n\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br")])]),s("ul",[s("li",[n._v("分析")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("1：上面代码中，d := time.Now().Add(50 * time.Millisecond)，因此超时是50毫秒，因此会执行 ctx.Done()\n\n2：如果将50毫秒改为5秒，那么会执行<-time.After(1 * time.Second)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("h3",{attrs:{id:"三-withtimeout"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三-withtimeout"}},[n._v("#")]),n._v(" (三)：WithTimeout")]),n._v(" "),s("ul",[s("li",[n._v("WithTimeout的函数签名如下：")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br")])]),s("ul",[s("li",[n._v("代码示例")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('var wg sync.WaitGroup\n\nfunc worker(ctx context.Context) {\n\t// 这里for循环的标签\n\tdefer wg.Done()\n\nLOOP:\n\n\t// 死循环不断等待\n\tfor {\n\t\tfmt.Println("db connecting ...")\n\t\ttime.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒\n\n\t\tselect {\n\n\t\tcase x := <-ctx.Done(): // 在ctx.Done()通道中有两种情况获取到数据，1：timeout超时 2：调用cancelFunc\n\t\t\tfmt.Printf("x=%v\\n", x)\n\t\t\tfmt.Println("结束时间：",time.Now().String())\n\t\t\t// break如果不加LOOP，只能跳出select，默认情况下，break只能跳出第一层select、switch、for，要想跳出两层，那么需要设置标签\n\t\t\tbreak LOOP\n\n\t\tdefault:\n\t\t\tfmt.Println("default")\n\t\t}\n\n\t\tfmt.Println("经过了select")\n\t}\n\n\tfmt.Println("worker done!")\n\n}\n\nfunc main() {\n\tfmt.Println("开始时间：",time.Now().String())\n\t// 设置一个50毫秒的超时\n\tt := time.Second * 5\n\t// t是时间间隔\n\tctx, cancel := context.WithTimeout(context.Background(), t)\n\twg.Add(1)\n\tgo worker(ctx)\n\ttime.Sleep(time.Second * 1)\n\tcancel()  // 通知子goroutine结束，可以认为这里是强制通知，ctx.Done()通道可以获取空结构体\n\twg.Wait() // 等待goroutine运行完毕\n\tfmt.Println("over")\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br")])]),s("ul",[s("li",[n._v("分析上面的代码")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("在ctx.Done()通道中有两种情况获取到数据\n\t1：timeout超时 \n\t2：调用cancelFunc\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br")])]),s("h3",{attrs:{id:"四-withvalue"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四-withvalue"}},[n._v("#")]),n._v(" (四)：WithValue")]),n._v(" "),s("ul",[s("li",[n._v("代码如下")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('type TraceCode string\n\nvar wg sync.WaitGroup\n\nfunc worker(ctx context.Context) {\n\t// 获取context中的value值\n\tkey := TraceCode("TRACE_CODE")\n\ttraceCode, ok := ctx.Value(key).(string)\n\tif !ok {\n\t\tfmt.Println("invalid trace code")\n\t}\n\t\nLOOP:\n\tfor {\n\t\tfmt.Printf("worker, trace code:%s\\n", traceCode)\n\t\ttime.Sleep(time.Millisecond * 10) // 假设正常连接数据库耗时10毫秒\n\t\t\n\t\tselect {\n\t\t\n\t\tcase <-ctx.Done(): // 两种情况获取到数据，1：context超时，2：调用了cancelFunc\n\t\t\tbreak LOOP\n\t\t\t\n\t\tdefault:\n\t\t\tfmt.Println("经过了default")\n\t\t}\n\t}\n\t\n\tfmt.Println("worker done!")\n\twg.Done()\n}\n\nfunc main() {\n\t\n\t// 创建一个timeout类型的根context\n\tctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*50)\n\t\n\t// 在系统的入口中设置trace code传递给后续启动的goroutine实现日志数据聚合\n\t// 基于timeout类型的根context，再创建一个value类型的context\n\t// 这里的context链表可以表示为： TimeoutCtx <- ValueCtx， 只要两层\n\tctx = context.WithValue(ctx, TraceCode("TRACE_CODE"), "12512312234")\n\t\n\twg.Add(1)\n\tgo worker(ctx)\n\ttime.Sleep(time.Second * 5)\n\t\n\tcancel() // 通知goroutine结束\n\twg.Wait()\n\tfmt.Println("over")\n\t\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br")])]),s("h3",{attrs:{id:"五-使用context的注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五-使用context的注意事项"}},[n._v("#")]),n._v(" (五)：使用Context的注意事项")]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v("1：推荐以参数的方式显示传递Context\n\n2：以Context作为参数的函数方法，应该把Context作为第一个参数。\n\n3：给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO()\n\n4：Context的Value相关方法应该传递请求域的必要数据，不应该用于传递可选参数\n\n5：Context是线程安全的，可以放心的在多个goroutine中传递\n")])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br")])]),s("h2",{attrs:{id:"三-客户端超时取消请求示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三-客户端超时取消请求示例"}},[n._v("#")]),n._v(" 三：客户端超时取消请求示例")]),n._v(" "),s("h3",{attrs:{id:"一-调用服务端api时如何在客户端实现超时控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-调用服务端api时如何在客户端实现超时控制"}},[n._v("#")]),n._v(" (一)：调用服务端API时如何在客户端实现超时控制？")]),n._v(" "),s("ul",[s("li",[n._v("服务器端代码")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('// context_timeout/server/main.go\npackage main\n\nimport (\n\t"fmt"\n\t"math/rand"\n\t"net/http"\n\n\t"time"\n)\n\n// server端，随机出现慢响应\nfunc indexHandler(w http.ResponseWriter, r *http.Request) {\n\tnumber := rand.Intn(2)\n\tif number == 0 {\n\t\ttime.Sleep(time.Second * 10) // 耗时10秒的慢响应\n\t\tfmt.Fprintf(w, "slow response")\n\t\treturn\n\t}\n\tfmt.Fprint(w, "quick response")\n}\n\nfunc main() {\n\thttp.HandleFunc("/", indexHandler)\n\terr := http.ListenAndServe(":8000", nil)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br")])]),s("ul",[s("li",[n._v("客户端")])]),n._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[n._v('// context_timeout/client/main.go\npackage main\n\nimport (\n\t"context"\n\t"fmt"\n\t"io/ioutil"\n\t"net/http"\n\t"sync"\n\t"time"\n)\n\n// 客户端\n\ntype respData struct {\n\tresp *http.Response\n\terr  error\n}\n\nfunc doCall(ctx context.Context) {\n\ttransport := http.Transport{\n\t   // 请求频繁可定义全局的client对象并启用长链接\n\t   // 请求不频繁使用短链接\n\t   DisableKeepAlives: true, \t}\n\tclient := http.Client{\n\t\tTransport: &transport,\n\t}\n\n\trespChan := make(chan *respData, 1)\n\treq, err := http.NewRequest("GET", "http://127.0.0.1:8000/", nil)\n\tif err != nil {\n\t\tfmt.Printf("new requestg failed, err:%v\\n", err)\n\t\treturn\n\t}\n\treq = req.WithContext(ctx) // 使用带超时的ctx创建一个新的client request\n\tvar wg sync.WaitGroup\n\twg.Add(1)\n\tdefer wg.Wait()\n\tgo func() {\n\t\tresp, err := client.Do(req)\n\t\tfmt.Printf("client.do resp:%v, err:%v\\n", resp, err)\n\t\trd := &respData{\n\t\t\tresp: resp,\n\t\t\terr:  err,\n\t\t}\n\t\trespChan <- rd\n\t\twg.Done()\n\t}()\n\n\tselect {\n\tcase <-ctx.Done():\n\t\t//transport.CancelRequest(req)\n\t\tfmt.Println("call api timeout")\n\tcase result := <-respChan:\n\t\tfmt.Println("call server api success")\n\t\tif result.err != nil {\n\t\t\tfmt.Printf("call server api failed, err:%v\\n", result.err)\n\t\t\treturn\n\t\t}\n\t\tdefer result.resp.Body.Close()\n\t\tdata, _ := ioutil.ReadAll(result.resp.Body)\n\t\tfmt.Printf("resp:%v\\n", string(data))\n\t}\n}\n\nfunc main() {\n\t// 定义一个100毫秒的超时\n\tctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*100)\n\tdefer cancel() // 调用cancel释放子goroutine资源\n\tdoCall(ctx)\n}\n')])]),n._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[n._v("1")]),s("br"),s("span",{staticClass:"line-number"},[n._v("2")]),s("br"),s("span",{staticClass:"line-number"},[n._v("3")]),s("br"),s("span",{staticClass:"line-number"},[n._v("4")]),s("br"),s("span",{staticClass:"line-number"},[n._v("5")]),s("br"),s("span",{staticClass:"line-number"},[n._v("6")]),s("br"),s("span",{staticClass:"line-number"},[n._v("7")]),s("br"),s("span",{staticClass:"line-number"},[n._v("8")]),s("br"),s("span",{staticClass:"line-number"},[n._v("9")]),s("br"),s("span",{staticClass:"line-number"},[n._v("10")]),s("br"),s("span",{staticClass:"line-number"},[n._v("11")]),s("br"),s("span",{staticClass:"line-number"},[n._v("12")]),s("br"),s("span",{staticClass:"line-number"},[n._v("13")]),s("br"),s("span",{staticClass:"line-number"},[n._v("14")]),s("br"),s("span",{staticClass:"line-number"},[n._v("15")]),s("br"),s("span",{staticClass:"line-number"},[n._v("16")]),s("br"),s("span",{staticClass:"line-number"},[n._v("17")]),s("br"),s("span",{staticClass:"line-number"},[n._v("18")]),s("br"),s("span",{staticClass:"line-number"},[n._v("19")]),s("br"),s("span",{staticClass:"line-number"},[n._v("20")]),s("br"),s("span",{staticClass:"line-number"},[n._v("21")]),s("br"),s("span",{staticClass:"line-number"},[n._v("22")]),s("br"),s("span",{staticClass:"line-number"},[n._v("23")]),s("br"),s("span",{staticClass:"line-number"},[n._v("24")]),s("br"),s("span",{staticClass:"line-number"},[n._v("25")]),s("br"),s("span",{staticClass:"line-number"},[n._v("26")]),s("br"),s("span",{staticClass:"line-number"},[n._v("27")]),s("br"),s("span",{staticClass:"line-number"},[n._v("28")]),s("br"),s("span",{staticClass:"line-number"},[n._v("29")]),s("br"),s("span",{staticClass:"line-number"},[n._v("30")]),s("br"),s("span",{staticClass:"line-number"},[n._v("31")]),s("br"),s("span",{staticClass:"line-number"},[n._v("32")]),s("br"),s("span",{staticClass:"line-number"},[n._v("33")]),s("br"),s("span",{staticClass:"line-number"},[n._v("34")]),s("br"),s("span",{staticClass:"line-number"},[n._v("35")]),s("br"),s("span",{staticClass:"line-number"},[n._v("36")]),s("br"),s("span",{staticClass:"line-number"},[n._v("37")]),s("br"),s("span",{staticClass:"line-number"},[n._v("38")]),s("br"),s("span",{staticClass:"line-number"},[n._v("39")]),s("br"),s("span",{staticClass:"line-number"},[n._v("40")]),s("br"),s("span",{staticClass:"line-number"},[n._v("41")]),s("br"),s("span",{staticClass:"line-number"},[n._v("42")]),s("br"),s("span",{staticClass:"line-number"},[n._v("43")]),s("br"),s("span",{staticClass:"line-number"},[n._v("44")]),s("br"),s("span",{staticClass:"line-number"},[n._v("45")]),s("br"),s("span",{staticClass:"line-number"},[n._v("46")]),s("br"),s("span",{staticClass:"line-number"},[n._v("47")]),s("br"),s("span",{staticClass:"line-number"},[n._v("48")]),s("br"),s("span",{staticClass:"line-number"},[n._v("49")]),s("br"),s("span",{staticClass:"line-number"},[n._v("50")]),s("br"),s("span",{staticClass:"line-number"},[n._v("51")]),s("br"),s("span",{staticClass:"line-number"},[n._v("52")]),s("br"),s("span",{staticClass:"line-number"},[n._v("53")]),s("br"),s("span",{staticClass:"line-number"},[n._v("54")]),s("br"),s("span",{staticClass:"line-number"},[n._v("55")]),s("br"),s("span",{staticClass:"line-number"},[n._v("56")]),s("br"),s("span",{staticClass:"line-number"},[n._v("57")]),s("br"),s("span",{staticClass:"line-number"},[n._v("58")]),s("br"),s("span",{staticClass:"line-number"},[n._v("59")]),s("br"),s("span",{staticClass:"line-number"},[n._v("60")]),s("br"),s("span",{staticClass:"line-number"},[n._v("61")]),s("br"),s("span",{staticClass:"line-number"},[n._v("62")]),s("br"),s("span",{staticClass:"line-number"},[n._v("63")]),s("br"),s("span",{staticClass:"line-number"},[n._v("64")]),s("br"),s("span",{staticClass:"line-number"},[n._v("65")]),s("br"),s("span",{staticClass:"line-number"},[n._v("66")]),s("br"),s("span",{staticClass:"line-number"},[n._v("67")]),s("br"),s("span",{staticClass:"line-number"},[n._v("68")]),s("br"),s("span",{staticClass:"line-number"},[n._v("69")]),s("br"),s("span",{staticClass:"line-number"},[n._v("70")]),s("br"),s("span",{staticClass:"line-number"},[n._v("71")]),s("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);