(window.webpackJsonp=window.webpackJsonp||[]).push([[135],{1694:function(s,n,a){s.exports=a.p+"assets/img/2018-09-011.38.30.a9920597.png"},1695:function(s,n,a){s.exports=a.p+"assets/img/2018-09-015.51.33.38c2723e.png"},1696:function(s,n,a){s.exports=a.p+"assets/img/MASTER.b05ad047.png"},1697:function(s,n,a){s.exports=a.p+"assets/img/2.241e0baa.png"},2657:function(s,n,a){"use strict";a.r(n);var e=a(9),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"一-jumpserver服务器资产获取"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-jumpserver服务器资产获取"}},[s._v("#")]),s._v(" （一）jumpserver服务器资产获取")]),s._v(" "),e("ul",[e("li",[s._v("使用API接口获取资产信息")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# 获取token\ncurl -X POST -H \'Content-Type: application/json\' -d \'{"username": "admin", "password": "admin9981"}\' http://47.75.53.221/api/users/v1/token/\n\n# 获取资产\ncurl -H \'Authorization: Bearer 4fa13aaafb8148bd896a2da7c2b69c3e\' -H "Content-Type:application/json" http://47.75.53.221/api/assets/v1/assets/\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"二-项目结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-项目结构"}},[s._v("#")]),s._v(" （二）项目结构")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("admin  \t\t\t\t\t\t\t# 配置setting文件\napps   \t\t\t\t\t\t\t# 前端model设计\nconf   \t\t\t\t\t\t\t# 配置文件主机扫描的配置文件\t\t\t\t\t\t\nextra_apps\t\t\t\t\t\t# 第三方的模块，可以是xadmin\nlogs                            # Django打印的日志\nmain.py                         # 自动化扫描的启动脚本\nmanage.py                       # 启动脚本\nrequirements.txt                # 环境依赖的安装包\nscanhosts                       # 自动化扫描\nscript                          # 获取资产的脚本，以及ansible的inventory脚本\nstatic                          # 静态文件\ntaskdo                          # 自动化ansible任务执行 \ntemplates                       # 前端模板\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"三-使用base64实现对称加密和解密"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-使用base64实现对称加密和解密"}},[s._v("#")]),s._v(" （三）使用BASE64实现对称加密和解密")]),s._v(" "),e("ul",[e("li",[s._v("BASE64的简单使用")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import base64\nencrypt = base64.encodestring('b7d20e79-60fa-4fd8-b20')\nprint(encrypt) # 编码\ndecrypt = base64.decodestring(encrypt)\nprint(decrypt) # 解码\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("在Django中的使用")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import os,django\nimport base64\nos.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", 'Voloroso_Ansibe_Task_Pro.settings')\ndjango.setup()\n\nfrom assets.models import Asset\ne48 = Asset.objects.get(name='BRT-E48-NY-10G')\npassword_en = e48.password\npassword_de = base64.decodestring(password_en)\nprint(password_en)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("从数据库中获取jumpuser的私钥和公钥")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import os,django\nos.environ.setdefault(\"DJANGO_SETTINGS_MODULE\", 'Voloroso_Ansibe_Task_Pro.settings')\ndjango.setup()\n\nfrom assets.models import Encriptor_Decriptor\nhost= Encriptor_Decriptor.objects.get(username='jumpuser')\nprint(host.private_key)\nprint(host.public_key)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"四-自动化任务的逻辑思想"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-自动化任务的逻辑思想"}},[s._v("#")]),s._v(" （四）自动化任务的逻辑思想")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1694),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"五-ansible的核心类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-ansible的核心类"}},[s._v("#")]),s._v(" （五）ansible的核心类")]),s._v(" "),e("ul",[e("li",[e("strong",[e("code",[s._v("DataLoader")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：加载yaml和json文件\n\n所在模块：ansible.parsing.dataloader\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("Play")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：存储hosts的主机角色信息\n\n所在模块：ansible.playbook.play\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("TaskQueueManager")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：ansible底层用到的任务队列\n\n所在模块：ansible.executor.task_queue_manager\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("PlaybookExecutor")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：执行playbook的核心类\n\n所在模块：ansible.executor.playbook_executor\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("CallbackBase")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：状态回调，各种成功失败的状态\n\n所在模块：ansible.plugins.callback\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("InvertoryManager")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：用于加载inventory文件\n\n所在模块：ansible.inventory.manager\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("VariableManager")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：用于存储各类变量信息\n\n所在模块：ansible.vars.manager\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[e("strong",[e("code",[s._v("Host, Group")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("用途：操作单个主机或主机信息\n\n所在模块：ansible.inventory.host\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"六-ansible执行流程图示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六-ansible执行流程图示"}},[s._v("#")]),s._v(" （六）ansible执行流程图示")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1695),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"七-ansible核心类的基本使用示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七-ansible核心类的基本使用示例"}},[s._v("#")]),s._v(" （七）ansible核心类的基本使用示例")]),s._v(" "),e("ul",[e("li",[s._v("解析hosts文件，获取到inventory信息")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Project_Dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n\nConf_dir = os.path.join(Project_Dir, 'conf')\n\n\n# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[os.path.join(Conf_dir, 'hosts.yml')])\npprint(inventory.groups) # 获取主机组\npprint(inventory.get_hosts()) # 获取主机名\npprint(inventory.get_groups_dict())  # 获取组名，和机器名称\ninventory.add_group(group=None)\ninventory.add_host(host='10.102.0.12', group='seal', port=None)\n# 获取主机列表\nprint(inventory.list_hosts())\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("ul",[e("li",[s._v("获取到variable信息")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 获取inventory的变量信息\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\nprint(variable_manager.get_vars(host=host))  # 获取特定主机的变量\nvariable_manager.set_host_variable(host=None, varname='ansible_ssh_pass', value='8374') # 修改主机的变量\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"八-ad-hoc原理解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八-ad-hoc原理解析"}},[s._v("#")]),s._v(" （八）ad-hoc原理解析")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import os\nfrom ansible.parsing.dataloader import DataLoader\nfrom ansible.inventory.manager import InventoryManager\nfrom ansible.vars.manager import VariableManager\nfrom ansible.playbook.play import Play\nfrom ansible.executor.task_queue_manager import TaskQueueManager\nfrom pprint import pprint\nfrom collections import namedtuple\n\nProject_Dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n\nConf_dir = os.path.join(Project_Dir, 'conf')\nHosts_yml = os.path.join(Conf_dir, 'hosts.yml')\nPrivate_key = os.path.join(Conf_dir, 'id_rsa')\n\n\n# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[Hosts_yml])\nhost = inventory.get_host('23.237.49.100')  # 获取单台主机\n\n# 获取inventory的变量信息\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\n\n# \n# 使用命名元组来使用执行选项\nOptions = namedtuple('Options', ['connection','module_path', 'forks', 'timeout',  'remote_user',\n                'ask_pass', 'private_key_file', 'ssh_common_args', 'ssh_extra_args', 'sftp_extra_args',\n                'scp_extra_args', 'become', 'become_method', 'become_user', 'ask_value_pass', 'verbosity',\n                'check', 'listhosts', 'listtasks', 'listtags', 'syntax','diff'])\n\noptions = Options(connection='smart', module_path=None, forks=100, timeout=10,\n                remote_user='root', ask_pass=False, private_key_file=Private_key, ssh_common_args=None, ssh_extra_args=None,\n                sftp_extra_args=None, scp_extra_args=None, become=True, become_method='sudo',\n                become_user='root', ask_value_pass=False, verbosity=None, check=False, listhosts=False,\n                listtasks=False, listtags=False, syntax=False, diff=True)\n\n\n# 定义需要执行的任务， 注意任务主机必须在inventory里面\nplay_source = dict(\n    name = \"ansible test\",\n    hosts = '23.237.49.100',  # 这个IP地址必须在inventory文件中，或者这里改写为域名，但是这个域名一定要在inventory文件，且在主机的/etc/hosts文件中需要有解析\n    gather_facts = 'no', # 是否获取主机的基本信息\n    tasks = [            # 这里是一个任务列表，可以一个任务一个任务的写, 写多个任务\n        dict(action={'module': 'shell', 'args': 'mkdir /root/hello'}),\n    ]\n)\n\n\n# 使用ad-hoc模式执行任务\nplay = Play().load(data=play_source, variable_manager=variable_manager, loader=loader)\n\n\ntask_queue = TaskQueueManager(\n    inventory=inventory,\n    variable_manager=variable_manager,\n    loader=loader,\n    options=options,\n    passwords=None,\n)\n\n# 执行任务，且返回result结果\ntask_queue.run(play)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br")])]),e("h3",{attrs:{id:"九-playbook原理解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#九-playbook原理解析"}},[s._v("#")]),s._v(" （九）playbook原理解析")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import os\nfrom ansible.parsing.dataloader import DataLoader\nfrom ansible.inventory.manager import InventoryManager\nfrom ansible.vars.manager import VariableManager\nfrom ansible.playbook.play import Play\nfrom ansible.executor.task_queue_manager import TaskQueueManager\nfrom ansible.executor.playbook_executor import PlaybookExecutor  # 执行playbook\nfrom pprint import pprint\nfrom collections import namedtuple\n\nProject_Dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n\nConf_dir = os.path.join(Project_Dir, 'conf')\nHosts_yml = os.path.join(Conf_dir, 'hosts.yml')\nplaybook = os.path.join(Conf_dir, 'playbook.yaml')\nPrivate_key = os.path.join(Conf_dir, 'id_rsa')\n\n\n# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[Hosts_yml])\nhost = inventory.get_host('23.237.49.100')  # 获取单台主机\n\n# 获取inventory的变量信息\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\n\n#\n# 使用命名元组来使用执行选项\nOptions = namedtuple('Options', ['connection','module_path', 'forks', 'timeout',  'remote_user',\n                'ask_pass', 'private_key_file', 'ssh_common_args', 'ssh_extra_args', 'sftp_extra_args',\n                'scp_extra_args', 'become', 'become_method', 'become_user', 'ask_value_pass', 'verbosity',\n                'check', 'listhosts', 'listtasks', 'listtags', 'syntax','diff'])\n\noptions = Options(connection='smart', module_path=None, forks=100, timeout=10,\n                remote_user='root', ask_pass=False, private_key_file=Private_key, ssh_common_args=None, ssh_extra_args=None,\n                sftp_extra_args=None, scp_extra_args=None, become=True, become_method='sudo',\n                become_user='root', ask_value_pass=False, verbosity=None, check=False, listhosts=False,\n                listtasks=False, listtags=False, syntax=False, diff=True)\n\n\n\n\n\n# 使用playbook模式执行任务\nplay_book = PlaybookExecutor(playbooks=[playbook], # 同样这里是列表，也可以写多个剧本，那么一个一个剧本执行\n                             inventory=inventory,\n                             variable_manager=variable_manager,\n                             loader=loader,\n                             options=options,\n                             passwords=None,)\n\n# 执行\nplay_book.run()\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br")])]),e("h3",{attrs:{id:"十-ad-hoc-自定义回调类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十-ad-hoc-自定义回调类"}},[s._v("#")]),s._v(" （十）ad-hoc 自定义回调类")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#!/usr/bin/env python  \n#-*- coding:utf-8 _*-  \n\"\"\" \n\"\"\"\nimport os\nfrom ansible.parsing.dataloader import DataLoader\nfrom ansible.inventory.manager import InventoryManager\nfrom ansible.vars.manager import VariableManager\nfrom ansible.playbook.play import Play\nfrom ansible.executor.task_queue_manager import TaskQueueManager\nfrom ansible.plugins.callback import CallbackBase  # 执行回调\nfrom pprint import pprint\nfrom collections import namedtuple\nimport json\n\n# 准备好路径\nProject_Dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nConf_dir = os.path.join(Project_Dir, 'conf')\nHosts_yml = os.path.join(Conf_dir, 'hosts.yml')\nPrivate_key = os.path.join(Conf_dir, 'id_rsa')\n\n\n\n# 创建一个ModelResultCollector回调类，自定义结果返回输出\nclass ModelResultCollector(CallbackBase):\n    def __init__(self, *args, **kwargs):\n        super(ModelResultCollector, self).__init__(*args, **kwargs)\n        self.host_ok = {}\n        self.host_unreachable = {}\n        self.host_failed = {}\n        self.host_skip = {}\n        self.host_status = {}\n        self.task = {}\n\n\n    # 获取当前主机是否不可达\n    def v2_runner_on_unreachable(self, result):\n        # result._host.get_name() 是获取执行任务的主机名\n        # result参数是返回的是：是否主机不可达的结果\n        self.host_unreachable[result._host.get_name()] = result._result\n\n    # 获取执行的的任务名称\n    def v2_runner_on_no_hosts(self, result):\n        self.task[result._host.get_name()] = result._result\n\n    # 获取任务是否OK\n    def v2_runner_on_ok(self, result):\n        self.host_ok[result._host.get_name()] = result._result\n\n    # 获取任务是否Failed\n    def v2_runner_on_failed(self, result, *args, **kwargs):\n        self.host_failed[result._host.get_name()] = result._result\n\n    # 获取任务是否没有改变主机的配置\n    def v2_runner_on_skipped(self, result):\n        self.host_skip[result._host.get_name()] = result._result\n\n\n# 实例化回调类\ncallback = ModelResultCollector()\n\n\n\n# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[Hosts_yml])\nhost = inventory.get_host('23.237.49.100')  # 获取单台主机\n\n# 获取inventory的变量信息\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\n\n#\n# 使用命名元组来使用执行选项\nOptions = namedtuple('Options', ['connection','module_path', 'forks', 'timeout',  'remote_user',\n                'ask_pass', 'private_key_file', 'ssh_common_args', 'ssh_extra_args', 'sftp_extra_args',\n                'scp_extra_args', 'become', 'become_method', 'become_user', 'ask_value_pass', 'verbosity',\n                'check', 'listhosts', 'listtasks', 'listtags', 'syntax','diff'])\n\noptions = Options(connection='smart', module_path=None, forks=100, timeout=10,\n                remote_user='root', ask_pass=False, private_key_file=Private_key, ssh_common_args=None, ssh_extra_args=None,\n                sftp_extra_args=None, scp_extra_args=None, become=True, become_method='sudo',\n                become_user='root', ask_value_pass=False, verbosity=None, check=False, listhosts=False,\n                listtasks=False, listtags=False, syntax=False, diff=True)\n\n\n# 定义需要执行的任务， 注意任务主机必须在inventory里面\nplay_source = dict(\n    name = \"ansible test\",\n    hosts = 'E35_master',  # e35\n    gather_facts = 'no',   # 是否获取主机的基本信息\n    tasks = [              # 这里是一个任务列表，可以一个任务一个任务的写, 写多个任务\n        dict(action={'module': 'shell', 'args': 'mkdir /root/hello'}),\n    ]\n)\n\n\n\nplay = Play().load(data=play_source, variable_manager=variable_manager, loader=loader)\n\n\n\n\ntask_queue = TaskQueueManager(\n    inventory=inventory,\n    variable_manager=variable_manager,\n    loader=loader,\n    options=options,\n    passwords=None,\n    stdout_callback=callback, # 指定自定义的callback实例\n)\n\n# 执行任务，且返回result结果\ntask_queue.run(play)\n\n\n'''\n说明一下这个回调类：\n    0：返回的数据是字典类型，\n    1：如果任务执行OK，那么host_ok会有值\n    2：如果任务执行Failed， 那么host_failed会有值\n    3：如果跳过执行，host_skip有值\n    4：如果主机不可达，host_unreachable会有值\n'''\n\n\n# print('='*100)\n# pprint(json.dumps(callback.host_ok))\n# print('='*100)\n# print(type(callback.host_ok)) # 返回的是一个字典类型\n# print('='*100)\n# print(callback.host_status)\n# print('='*100)\n# print(callback.host_unreachable)\n# print('='*100)\n# print(callback.host_failed)\n# print('='*100)\n# print(callback.host_skip)\n# print('='*100)\n\n\nif callback.host_ok != dict():\n    for hostname, key in callback.host_ok.items():\n        print('{} is {}'.format(hostname, 'successful'))\nelse:\n    for hostname, key in callback.host_failed.items():\n        print('{} is {}'.format(hostname, 'failed'))\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br"),e("span",{staticClass:"line-number"},[s._v("108")]),e("br"),e("span",{staticClass:"line-number"},[s._v("109")]),e("br"),e("span",{staticClass:"line-number"},[s._v("110")]),e("br"),e("span",{staticClass:"line-number"},[s._v("111")]),e("br"),e("span",{staticClass:"line-number"},[s._v("112")]),e("br"),e("span",{staticClass:"line-number"},[s._v("113")]),e("br"),e("span",{staticClass:"line-number"},[s._v("114")]),e("br"),e("span",{staticClass:"line-number"},[s._v("115")]),e("br"),e("span",{staticClass:"line-number"},[s._v("116")]),e("br"),e("span",{staticClass:"line-number"},[s._v("117")]),e("br"),e("span",{staticClass:"line-number"},[s._v("118")]),e("br"),e("span",{staticClass:"line-number"},[s._v("119")]),e("br"),e("span",{staticClass:"line-number"},[s._v("120")]),e("br"),e("span",{staticClass:"line-number"},[s._v("121")]),e("br"),e("span",{staticClass:"line-number"},[s._v("122")]),e("br"),e("span",{staticClass:"line-number"},[s._v("123")]),e("br"),e("span",{staticClass:"line-number"},[s._v("124")]),e("br"),e("span",{staticClass:"line-number"},[s._v("125")]),e("br"),e("span",{staticClass:"line-number"},[s._v("126")]),e("br"),e("span",{staticClass:"line-number"},[s._v("127")]),e("br"),e("span",{staticClass:"line-number"},[s._v("128")]),e("br"),e("span",{staticClass:"line-number"},[s._v("129")]),e("br"),e("span",{staticClass:"line-number"},[s._v("130")]),e("br"),e("span",{staticClass:"line-number"},[s._v("131")]),e("br"),e("span",{staticClass:"line-number"},[s._v("132")]),e("br"),e("span",{staticClass:"line-number"},[s._v("133")]),e("br"),e("span",{staticClass:"line-number"},[s._v("134")]),e("br"),e("span",{staticClass:"line-number"},[s._v("135")]),e("br"),e("span",{staticClass:"line-number"},[s._v("136")]),e("br"),e("span",{staticClass:"line-number"},[s._v("137")]),e("br"),e("span",{staticClass:"line-number"},[s._v("138")]),e("br"),e("span",{staticClass:"line-number"},[s._v("139")]),e("br"),e("span",{staticClass:"line-number"},[s._v("140")]),e("br"),e("span",{staticClass:"line-number"},[s._v("141")]),e("br"),e("span",{staticClass:"line-number"},[s._v("142")]),e("br"),e("span",{staticClass:"line-number"},[s._v("143")]),e("br"),e("span",{staticClass:"line-number"},[s._v("144")]),e("br"),e("span",{staticClass:"line-number"},[s._v("145")]),e("br"),e("span",{staticClass:"line-number"},[s._v("146")]),e("br"),e("span",{staticClass:"line-number"},[s._v("147")]),e("br"),e("span",{staticClass:"line-number"},[s._v("148")]),e("br"),e("span",{staticClass:"line-number"},[s._v("149")]),e("br")])]),e("h3",{attrs:{id:"十二-playbook-自定义回调类"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十二-playbook-自定义回调类"}},[s._v("#")]),s._v(" （十二）playbook 自定义回调类")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import os\nfrom ansible.parsing.dataloader import DataLoader\nfrom ansible.inventory.manager import InventoryManager\nfrom ansible.vars.manager import VariableManager\nfrom ansible.playbook.play import Play\nfrom ansible.executor.task_queue_manager import TaskQueueManager\nfrom ansible.plugins.callback import CallbackBase  # 执行回调\nfrom pprint import pprint\nfrom collections import namedtuple\nimport json\n\n# 准备好路径\nProject_Dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nConf_dir = os.path.join(Project_Dir, 'conf')\nHosts_yml = os.path.join(Conf_dir, 'hosts.yml')\nPrivate_key = os.path.join(Conf_dir, 'id_rsa')\n\n\n\n# 创建一个ModelResultCollector回调类，自定义结果返回输出\nclass ModelResultCollector(CallbackBase):\n    def __init__(self, *args, **kwargs):\n        super(ModelResultCollector, self).__init__(*args, **kwargs)\n        self.host_ok = {}\n        self.host_unreachable = {}\n        self.host_failed = {}\n        self.host_skip = {}\n        self.host_status = {}\n        self.task = {}\n\n\n    # 获取当前主机是否不可达\n    def v2_runner_on_unreachable(self, result):\n        # result._host.get_name() 是获取执行任务的主机名\n        # result参数是返回的是：是否主机不可达的结果\n        self.host_unreachable[result._host.get_name()] = result._result\n\n    # 获取执行的的任务名称\n    def v2_runner_on_no_hosts(self, result):\n        self.task[result._host.get_name()] = result._result\n\n    # 获取任务是否OK\n    def v2_runner_on_ok(self, result):\n        self.host_ok[result._host.get_name()] = result._result\n\n    # 获取任务是否Failed\n    def v2_runner_on_failed(self, result, *args, **kwargs):\n        self.host_failed[result._host.get_name()] = result._result\n\n    # 获取任务是否没有改变主机的配置\n    def v2_runner_on_skipped(self, result):\n        self.host_skip[result._host.get_name()] = result._result\n\n\n\n# 实例化回调类\ncallback = ModelResultCollector()\n\n\n\n# 实例化加载器\nloader = DataLoader()\n# 获取inventory信息，可以获取\ninventory = InventoryManager(loader=loader, sources=[Hosts_yml])\nhost = inventory.get_host('23.237.49.100')  # 获取单台主机\n\n# 获取inventory的变量信息\nvariable_manager =VariableManager(loader=loader, inventory=inventory)\n\n\n#\n# 使用命名元组来使用执行选项\nOptions = namedtuple('Options', ['connection','module_path', 'forks', 'timeout',  'remote_user',\n                'ask_pass', 'private_key_file', 'ssh_common_args', 'ssh_extra_args', 'sftp_extra_args',\n                'scp_extra_args', 'become', 'become_method', 'become_user', 'ask_value_pass', 'verbosity',\n                'check', 'listhosts', 'listtasks', 'listtags', 'syntax','diff'])\n\noptions = Options(connection='smart', module_path=None, forks=100, timeout=10,\n                remote_user='root', ask_pass=False, private_key_file=Private_key, ssh_common_args=None, ssh_extra_args=None,\n                sftp_extra_args=None, scp_extra_args=None, become=True, become_method='sudo',\n                become_user='root', ask_value_pass=False, verbosity=None, check=False, listhosts=False,\n                listtasks=False, listtags=False, syntax=False, diff=True)\n\n\n# 定义需要执行的任务， 注意任务主机必须在inventory里面\nplay_source = dict(\n    name = \"ansible test\",\n    hosts = 'E35_master',  # e35\n    gather_facts = 'no',   # 是否获取主机的基本信息\n    tasks = [              # 这里是一个任务列表，可以一个任务一个任务的写, 写多个任务\n        dict(action={'module': 'shell', 'args': 'mkdir /root/hello'}),\n    ]\n)\n\n\n\nplay = Play().load(data=play_source, variable_manager=variable_manager, loader=loader)\n\n\n\n\ntask_queue = TaskQueueManager(\n    inventory=inventory,\n    variable_manager=variable_manager,\n    loader=loader,\n    options=options,\n    passwords=None,\n    stdout_callback=callback, # 指定自定义的callback实例\n)\n\n# 执行任务，且返回result结果\ntask_queue.run(play)\n\n\n'''\n说明一下这个回调类：\n    0：返回的数据是字典类型，\n    1：如果任务执行OK，那么host_ok会有值\n    2：如果任务执行Failed， 那么host_failed会有值\n    3：如果跳过执行，host_skip有值\n    4：如果主机不可达，host_unreachable会有值\n'''\n\n\n# print('='*100)\n# pprint(json.dumps(callback.host_ok))\n# print('='*100)\n# print(type(callback.host_ok)) # 返回的是一个字典类型\n# print('='*100)\n# print(callback.host_status)\n# print('='*100)\n# print(callback.host_unreachable)\n# print('='*100)\n# print(callback.host_failed)\n# print('='*100)\n# print(callback.host_skip)\n# print('='*100)\n\n\n\nif callback.host_ok != dict():\n    for hostname, key in callback.host_ok.items():\n        print('{} is {}'.format(hostname, 'successful'))\nelse:\n    for hostname, key in callback.host_failed.items():\n        print('{} is {}'.format(hostname, 'failed'))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br"),e("span",{staticClass:"line-number"},[s._v("108")]),e("br"),e("span",{staticClass:"line-number"},[s._v("109")]),e("br"),e("span",{staticClass:"line-number"},[s._v("110")]),e("br"),e("span",{staticClass:"line-number"},[s._v("111")]),e("br"),e("span",{staticClass:"line-number"},[s._v("112")]),e("br"),e("span",{staticClass:"line-number"},[s._v("113")]),e("br"),e("span",{staticClass:"line-number"},[s._v("114")]),e("br"),e("span",{staticClass:"line-number"},[s._v("115")]),e("br"),e("span",{staticClass:"line-number"},[s._v("116")]),e("br"),e("span",{staticClass:"line-number"},[s._v("117")]),e("br"),e("span",{staticClass:"line-number"},[s._v("118")]),e("br"),e("span",{staticClass:"line-number"},[s._v("119")]),e("br"),e("span",{staticClass:"line-number"},[s._v("120")]),e("br"),e("span",{staticClass:"line-number"},[s._v("121")]),e("br"),e("span",{staticClass:"line-number"},[s._v("122")]),e("br"),e("span",{staticClass:"line-number"},[s._v("123")]),e("br"),e("span",{staticClass:"line-number"},[s._v("124")]),e("br"),e("span",{staticClass:"line-number"},[s._v("125")]),e("br"),e("span",{staticClass:"line-number"},[s._v("126")]),e("br"),e("span",{staticClass:"line-number"},[s._v("127")]),e("br"),e("span",{staticClass:"line-number"},[s._v("128")]),e("br"),e("span",{staticClass:"line-number"},[s._v("129")]),e("br"),e("span",{staticClass:"line-number"},[s._v("130")]),e("br"),e("span",{staticClass:"line-number"},[s._v("131")]),e("br"),e("span",{staticClass:"line-number"},[s._v("132")]),e("br"),e("span",{staticClass:"line-number"},[s._v("133")]),e("br"),e("span",{staticClass:"line-number"},[s._v("134")]),e("br"),e("span",{staticClass:"line-number"},[s._v("135")]),e("br"),e("span",{staticClass:"line-number"},[s._v("136")]),e("br"),e("span",{staticClass:"line-number"},[s._v("137")]),e("br"),e("span",{staticClass:"line-number"},[s._v("138")]),e("br"),e("span",{staticClass:"line-number"},[s._v("139")]),e("br"),e("span",{staticClass:"line-number"},[s._v("140")]),e("br"),e("span",{staticClass:"line-number"},[s._v("141")]),e("br"),e("span",{staticClass:"line-number"},[s._v("142")]),e("br"),e("span",{staticClass:"line-number"},[s._v("143")]),e("br"),e("span",{staticClass:"line-number"},[s._v("144")]),e("br"),e("span",{staticClass:"line-number"},[s._v("145")]),e("br"),e("span",{staticClass:"line-number"},[s._v("146")]),e("br")])]),e("h3",{attrs:{id:"十三-自动化接口设计思想"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十三-自动化接口设计思想"}},[s._v("#")]),s._v(" （十三）自动化接口设计思想")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1696),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"十四-ansible接口封装层思想"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十四-ansible接口封装层思想"}},[s._v("#")]),s._v(" （十四）ansible接口封装层思想")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1697),alt:"Alt text"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);