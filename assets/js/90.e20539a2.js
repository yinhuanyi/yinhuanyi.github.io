(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{1727:function(s,n,a){s.exports=a.p+"assets/img/2020-12-196.02.35.d5ba5254.png"},1728:function(s,n,a){s.exports=a.p+"assets/img/2020-12-1910.05.19.3e4a6f4a.png"},1729:function(s,n,a){s.exports=a.p+"assets/img/2020-12-2210.42.10.d0835148.png"},1730:function(s,n,a){s.exports=a.p+"assets/img/2021-01-0512.17.27.c7d8d230.png"},1731:function(s,n,a){s.exports=a.p+"assets/img/2021-01-098.54.21.e300c4a0.png"},1732:function(s,n,a){s.exports=a.p+"assets/img/2021-01-098.56.51.95c04f74.png"},2678:function(s,n,a){"use strict";a.r(n);var e=a(9),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h3",{attrs:{id:"一-nginx对静态资源的访问"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-nginx对静态资源的访问"}},[s._v("#")]),s._v(" 一："),e("code",[s._v("NGINX对静态资源的访问")])]),s._v(" "),e("h3",{attrs:{id:"一-nginx静态资源访问用到的模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-nginx静态资源访问用到的模块"}},[s._v("#")]),s._v(" (一) NGINX静态资源访问用到的模块")]),s._v(" "),e("ul",[e("li",[s._v("1："),e("code",[s._v("sendfile")]),s._v("：让静态资源的请求响应过程，不需要经过用户空间，直接再内核空间完成数据的交互")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以作用在http、server、local、if in location中\nsendfile on | off\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("2："),e("code",[s._v("tcp_nopush")]),s._v("：在sendfile开启情况下，提高网络包的传输效率。意义是 当有多个数据包需要发送出去，那么将会作为一次向发送")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以作用在http、server、local中\ntcp_nopush on | off;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("3："),e("code",[s._v("tcp_nodelay")]),s._v("：在用户要求数据发送实时性比较高的情况下使用，只要有数据包就发送，在keepalive连接情况下，提高网络包传输的实时性")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以作用在http、server、local、if in location中\ntcp_nodelay on | off;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("4："),e("code",[s._v("gzip")]),s._v("：在传输的过程中使用压缩")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以作用在http、server、local、if in location中\ngzip on | off;\ngzip_comp_level level;  # 压缩比率\ngzip_http_version 1.0 | 1.1; # http的版本\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("5：示例：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\t# 创建/app/web/static/目录，在目录下存放静态文件\n    location ~ ^/static {\n        root   /app/web;\n        gzip on;\n        gzip_comp_level 2;\n        gzip_http_version 1.1;\n        gzip_types *;\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"二-nginx跨域模块已经解决-需要后台支持跨域-且nginx支持跨越"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-nginx跨域模块已经解决-需要后台支持跨域-且nginx支持跨越"}},[s._v("#")]),s._v(" "),e("code",[s._v("(二) NGINX跨域模块")]),s._v("已经解决(需要后台支持跨域，且NGINX支持跨越)")]),s._v(" "),e("ul",[e("li",[s._v("如果一个html页面中，有ajax请求发起对另外一个域名的访问，那么这个时候，就会出现跨域的问题，默认的情况下，浏览器是不允许跨域的，例如下面这个admin.html页面，页面请求的百度，因此会有跨域的问题")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<!doctype html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport"\n          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">\n    <meta http-equiv="X-UA-Compatible" content="ie=edge">\n    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"><\/script>\n    <title>admin</title>\n</head>\n<body>\n\n<div>管理页面</div>\n\n<script>\n    $(document).ready(function(){\n      $.ajax({\n          type: "GET",\n          // 这里要保证这个后台服务也允许跨域\n          url: "http://10.102.0.11:9001/",\n          success: function () {\n              alert("跨域成功");\n          },\n          error: function () {\n              alert("跨域失败");\n          }\n      })\n    });\n<\/script>\n\n\n</body>\n</html>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("ul",[e("li",[s._v("跨域的现象如下")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1727),alt:"Alt text"}})]),s._v(" "),e("ul",[e("li",[s._v("此时需要解决的问题是给NGINX加上一个可以跨域访问的头部："),e("code",[s._v("Access-Control-Allow-Origin")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n    listen       80;\n    server_name  _;\n    location / {\n        root   /app/web;\n        index  index.html index.htm;\n        add_header Access-Control-Allow-Origin *;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"三-nginx静态资源防盗链"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-nginx静态资源防盗链"}},[s._v("#")]),s._v(" (三) NGINX静态资源防盗链")]),s._v(" "),e("ul",[e("li",[s._v("举例")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    location / {\n        root   /app/web;\n        index  index.html index.htm;\n        # 设置合法的refer是有bbs.yhyblog.cn域名的\n        valid_referers none blocked bbs.yhyblog.cn;\n        if ($invalid_referer) {\n            return 403;\n        }\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("ul",[e("li",[s._v("测试")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# 如果refer是www.baidu.com，那么403拒绝\n[root@node1 conf.d]# curl  -e "http://www.baidu.com"  -I http://bbs.yhyblog.cn/test.png\nHTTP/1.1 403 Forbidden\nServer: nginx/1.18.0\nDate: Sat, 19 Dec 2020 13:41:15 GMT\nContent-Type: text/html\nContent-Length: 153\nConnection: keep-alive\n\n# 如果refer是bbs.yhyblog.cn，那么请求成功\n[root@node1 conf.d]# curl  -e "http://bbs.yhyblog.cn"  -I http://bbs.yhyblog.cn/test.png\nHTTP/1.1 200 OK\nServer: nginx/1.18.0\nDate: Sat, 19 Dec 2020 13:42:48 GMT\nContent-Type: image/png\nContent-Length: 46423\nLast-Modified: Sat, 19 Dec 2020 10:02:40 GMT\nConnection: keep-alive\nETag: "5fddcfc0-b557"\nAccept-Ranges: bytes\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h3",{attrs:{id:"二-nginx-代理模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-nginx-代理模式"}},[s._v("#")]),s._v(" 二："),e("code",[s._v("NGINX 代理模式")])]),s._v(" "),e("h3",{attrs:{id:"一-nginx作为反向代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-nginx作为反向代理"}},[s._v("#")]),s._v(" (一) NGINX作为反向代理")]),s._v(" "),e("ul",[e("li",[s._v("能够代理的协议有")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1728),alt:"Alt text"}})]),s._v(" "),e("ul",[e("li",[s._v("反向代理模式与NGINX模块")])]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[s._v("反向代理模式")]),s._v(" "),e("th",{staticStyle:{"text-align":"center"}},[s._v("NGINX配置模块")])])]),s._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("http、websocket、https")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("ngx_http_proxy_module")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("fastcgi")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("ngx_http_fastcgi_module")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("uwsgi")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("ngx_http_uwsgi_module")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("grpc")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("ngx_http_v2_module")])])])]),s._v(" "),e("h3",{attrs:{id:"二-nginx作为反向代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-nginx作为反向代理"}},[s._v("#")]),s._v(" (二) NGINX作为反向代理")]),s._v(" "),e("ul",[e("li",[s._v("基于proxy_pass可以将请求转发到其他服务器")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ /index_proxy.html$ {\n\tproxy_pass http://127.0.0.1:8080;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("NGINX作为代理的常用配置")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location / {\n\n\tproxy_pass http://127.0.0.1:8080;\n\t# 使用proxy_redirect进行url重定向设置了\n\tproxy_redirect default;\n\t\n\t# 添加头部信息\n\tproxy_set_header Host $http_host;\n\tproxy_set_header X-Real-IP $remote_addr;\n\n\t# 设置反向代理超时\n\tproxy_connect_timeout 30;\n\tproxy_send_timeout 30;\n\tproxy_read_timeout 30;\n\n\t# 设置代理的缓冲\n\tproxy_buffer_size 32k;\n\tproxy_buffering on;\n\tproxy_buffers 4 128k;\n\tproxy_busy_buffers_size 256k;\n\tproxy_max_temp_file_size 256k;\n\t\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("ul",[e("li",[s._v("一般配置文件中可以将这些代理配置项放在一个文件中")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location / {\n\n\tproxy_pass http://127.0.0.1:8080;\n\tinclude proxy_params;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("/etc/nginx/proxy_params文件的内容为")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 使用proxy_redirect进行url重定向设置了, 没有搞清楚\nproxy_redirect default;\n\n# 添加头部信息\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\n\n# 设置反向代理超时\nproxy_connect_timeout 30;\nproxy_send_timeout 30;\nproxy_read_timeout 30;\n\n# 设置代理的缓冲\nproxy_buffer_size 32k;\nproxy_buffering on;\nproxy_buffers 4 128k;\nproxy_busy_buffers_size 256k;\nproxy_max_temp_file_size 256k;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h3",{attrs:{id:"三-nginx-作为缓存服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-nginx-作为缓存服务器"}},[s._v("#")]),s._v(" 三："),e("code",[s._v("NGINX 作为缓存服务器")])]),s._v(" "),e("h3",{attrs:{id:"一-nginx缓存"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-nginx缓存"}},[s._v("#")]),s._v(" (一) NGINX缓存")]),s._v(" "),e("ul",[e("li",[s._v("配置示例")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# proxy_cache_path表示开启一个缓存空间\n# /opt/cache缓存路径\n# levels是缓存的层级\n# keys_zone是缓存空间的名称，10m是缓存key的内存大小，1m一般可以存放8000个key，10m可以存放80000个key\n# max_size指存储value最大值\n# inactive表示如果10分钟未使用到这个缓存，那么将会被清理\n# use_temp_path表示关闭临时文件存放目录\n\nproxy_cache_path /opt/cache levels=1:2 keys_zone=nginx_cache:10m max_size=10g inactive=10m use_temp_path=off;\n\n# 设置组\nupstream backend {\n\tserver 127.0.0.1:8001;\n\tserver 127.0.0.1:8002;\n\tserver 127.0.0.1:8003;\n}\n\n# 当请求以url3、login、password/reset开头，设置cookie_nocache这个自定义变量为1\nif ($request_uri ~ ^/(url3|login|passwrod\\/reset)){\n\tset $cookie_nocache 1;\n}\n\nlocation / {\n\t# 将请求反向代理到后台组\n\tproxy_pass http://backend;\n\t# 应用缓存\n\tproxy_cache nginx_cache;\n\t# 200和304状态码是1h过期\n\tproxy_cache_valid 200 304 1h;\n\t# 其他状态码过期时间是10分钟\n\tproxy_cache_valid any 10m;\n\t# 设置缓存key的命名规则\n\tproxy_cache_key $host$uri$is_args$args;\n\t# 添加头部信息, 这个头部会出现在response响应头里面，如果Nginx-Cache是HIT，表明命中缓存，如果Nginx-Cache是MISS表明没有命中缓存\n\tadd_header Nginx-Cache "$upstream_cache_status";\n\t\n\t# 当$cookie_nocache为1时，不使用缓存\n\tproxy_no_cache $cookie_nocache;\n\t\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br")])]),e("h3",{attrs:{id:"四-nginx-实现websocket代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-nginx-实现websocket代理"}},[s._v("#")]),s._v(" 四："),e("code",[s._v("NGINX 实现websocket代理")])]),s._v(" "),e("h3",{attrs:{id:"一-websocket"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-websocket"}},[s._v("#")]),s._v(" (一) websocket")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("websocket 实现在HTTP连接的基础上，并且通过HTTP中的Upgrade协议头将连接从HTTP升级到WebSocket，这样就实现了双工通信")])]),s._v(" "),e("li",[e("p",[s._v("安装nodejs环境")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum install -y nodejs npm\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("使用npm安装ws模块")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("npm install -g ws wscat\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("在/app/websocket目录中创建一个server.js文件，作为服务器端")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("console.log(\"Server started\");\nvar Msg = '';\nvar WebSocketServer = require('ws').Server;\nvar wss = new WebSocketServer({port: 8011});\n\nwss.on('connection', function(ws){\n\tws.on('message', function(message){\n\t\tconsole.log('Received from client: %s', message);\n\t\tws.send('Server Received from client: ' + message);\n\t});\n});\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ul",[e("li",[s._v("运行server.js")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("node server.js\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("创建/etc/nginx/conf.d/websocket_proxy.conf")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("map $http_upgrade $connection_upgrade {\n\tdefault upgrade;\n\t'' close;\n}\n\nupstream websocket {\n\tserver 127.0.0.1:8011;\n}\n\nserver {\n\tlisten 8020;\n\taccess_log /var/log/nginx/websocket.access.log main;\n\tlocation / {\n\t\tproxy_pass http://websocket;\n\t\tproxy_http_version 1.1;\n\t\tproxy_set_header Upgrade $http_upgrade;\n\t\tproxy_set_header Connection $connection_upgrade;\n\t}\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("ul",[e("li",[s._v("启动NGINX后，使用wscat连接NGINX")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("wscat -c ws://127.0.0.1:8020\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"五-nginx-实现uwsgi代理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-nginx-实现uwsgi代理"}},[s._v("#")]),s._v(" 五："),e("code",[s._v("NGINX 实现uwsgi代理")])]),s._v(" "),e("h3",{attrs:{id:"一-当uwsgi服务器托起django时的配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-当uwsgi服务器托起django时的配置"}},[s._v("#")]),s._v(" (一) 当UWSGI服务器托起Django时的配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server{\n\tlisten 9990;\n\tserver_name bbs.yhyblog.cn;\n\n\tlocation / {\n\t\t# 引用uwsgi参数文件\n\t\tinclude uwsgi_params;\n\t\t# 请求转发给UWSGI服务器\n\t\tuwsgi_pass 127.0.0.1:9999;\n\t\t# 设置wsgi文件模块\n\t\tuwsgi_param UWSGI_SCRIPT fil_manager.wsgi;\n\t\t# 指定项目目录\n\t\tuwsgi_param UWSGI_CHDRI /app/fil_manager;\n\t\tclient_max_body_size 100m;\n\t\tindex index.html index.htm;\n\t}\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"六-nginx-七层负载均衡"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六-nginx-七层负载均衡"}},[s._v("#")]),s._v(" 六："),e("code",[s._v("NGINX 七层负载均衡")])]),s._v(" "),e("h3",{attrs:{id:"一-upstream配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-upstream配置"}},[s._v("#")]),s._v(" (一) upstream配置")]),s._v(" "),e("ul",[e("li",[s._v("基于weight权重的请求调度")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("upstream backend {\n\tserver server1.com weight=5;\n\t# 权重weight值越大，请求调度的几率越高 \n\tserver server2.com:8000 weight=5 max_fails 3 fail_timeout 10s max_conns 1000;\n\tserver unix:/tmp/socket;\n\t# backup是备用节点，当主节点宕机，备用节点就会启用\n\tserver server3.com:8001 backup;\n\tserver server3.com:8001 down;\n\t\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("基于ip_hash的请求调度")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("upstream backend {\n\tip_hash;\n\tserver server1.com:8001;\n\tserver server2.com:8002;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("基于自定义hash的请求调度(相同的url请求将会调度到同一台服务器上)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("upstream backend {\n\thash $request_uri;\n\tserver server1.com:8001;\n\tserver server2.com:8002;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"七-rewrite规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七-rewrite规则"}},[s._v("#")]),s._v(" 七："),e("code",[s._v("rewrite规则")])]),s._v(" "),e("h3",{attrs:{id:"一-正则表达式测试方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-正则表达式测试方法"}},[s._v("#")]),s._v(" (一) 正则表达式测试方法")]),s._v(" "),e("ul",[e("li",[s._v("正则表达式测试: 可以基于pcretest进行正则表达式测试，编译安装pcretest工具")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("wget https://ftp.pcre.org/pub/pcre/pcre-8.43.tar.gz\ntar xf pcre-8.43.tar.gz\ncd pcre-8.43\n./configure\nmake && make install\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("使用测试")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@node1 ~]# pcretest \nPCRE version 8.43 2019-02-23\n\n  re### /(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)/  # 这里是输入的正则表达式\ndata### 192.168.10.1                  # 这里是需要匹配的字符串\n 0: 192.168.10.1                    # 所有匹配到的字符串\n 1: 192                             # 第1组匹配到的字符串\n 2: 168                             # 第2组匹配到的字符串\n 3: 10                              # 第3组匹配到的字符串\n 4: 1                               # 第4组匹配到的字符串\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"二-rewrite重写规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-rewrite重写规则"}},[s._v("#")]),s._v(" (二) rewrite重写规则")]),s._v(" "),e("ul",[e("li",[s._v("基本语法")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 可以作用在location或server中\nrewrite regex replacement [flag];\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("flag的区别")])]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[s._v("关键字")]),s._v(" "),e("th",{staticStyle:{"text-align":"center"}},[s._v("功能")])])]),s._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("last")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("停止rewrite检测, 重新发起一个请求")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("break")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("停止rewrite检测，不会重新发起一个请求，直接在root指定的目录中寻找")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("redirect")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("返回302临时重定向，地址栏会显示跳转后的地址")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[s._v("permanent")]),s._v(" "),e("td",{staticStyle:{"text-align":"center"}},[s._v("返回301永久重定向，地址栏会显示跳转后的地址")])])])]),s._v(" "),e("h3",{attrs:{id:"三-last与break"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-last与break"}},[s._v("#")]),s._v(" (三) last与break")]),s._v(" "),e("ul",[e("li",[s._v("配置示例")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('server {\n    listen       80;\n    server_name  docs.yhyblog.cn;\n    root /app/web;\n    index index.html;\n    \n    location ~ ^/break {\n        rewrite ^/break /test/ break;\n    }\n\n    location ~ ^/last {\n        rewrite ^/last /test/ last;\n    }\n\n    location /test/ {\n            default_type application/json;\n            return 200 \'{"status": "success"}\';\n    }\n\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("ul",[e("li",[s._v("请求访问"),e("code",[s._v("http://docs.yhyblog.cn/break")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('请求会重写为： http://docs.yhyblog.cn/test/ 但是不会继续匹配下面的location，会直接在/app/web中寻找test目录下面的index.html，如果找不到，直接返回404。如果找到了，重新发起一个请求：http://docs.yhyblog.cn/test/，这样会被第3个location匹配到，返回{"status": "success"}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("请求访问"),e("code",[s._v("http://docs.yhyblog.cn/last")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('请求会重写为：http://docs.yhyblog.cn/test/，会继续向下匹配location，这样会被第3个location匹配到，返回{"status": "success"}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"四-redirect与permanent"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-redirect与permanent"}},[s._v("#")]),s._v(" (四) redirect与permanent")]),s._v(" "),e("ul",[e("li",[s._v("配置示例")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("location ~ ^/test {\n\t# 临时重定向，每次请求都会发起两次请求\n\trewrite ^/test http://www.baidu.com redirect;\n\t# 永久重定向，第一次发起两次请求，第二次只发起一次请求\n\trewrite ^/test http://www.baidu.com permanent;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"五-rewrite规则的应用场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-rewrite规则的应用场景"}},[s._v("#")]),s._v(" (五) rewrite规则的应用场景")]),s._v(" "),e("ul",[e("li",[s._v("提取url的信息，重定向到对应的请求目录, 下面这个规则会访问到 "),e("code",[s._v("/app/web/article/$1/$2/article_$3.html")]),s._v("这个页面")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("root /app/web;\nlocation / {\n\trewrite ^/article-(\\d+)-(\\d+)-(\\d+)\\.html$ /article/$1/$2/article_$3.html break\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"八-nginx-lua灰度发布"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八-nginx-lua灰度发布"}},[s._v("#")]),s._v(" 八："),e("code",[s._v("nginx + lua灰度发布")])]),s._v(" "),e("h3",{attrs:{id:"一-基本思想"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一-基本思想"}},[s._v("#")]),s._v(" (一) 基本思想")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1729),alt:"Alt text"}})]),s._v(" "),e("ul",[e("li",[s._v("基本思想")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("请求调度到NGINX，会进入到Lua脚本中进行判断，在Lua脚本中获取用户的IP地址或Token，然后在Redis/Memcache中查找，如果能够查找到说明是测试用户，将请求调度到新系统。反之将请求调度到老系统\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("基本原理")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    ngx_lua将Lua嵌入Nginx，可以让Nginx执行Lua脚本，并且高并发、非阻塞的处理各种请求。Lua内建协程，这样就可以很好的将异步回 调转换成顺序调用的形式。ngx_lua在Lua中进行的IO操作都会委托给Nginx的事件模型，从而实现非阻塞调用。开发者可以采用串行的方式编写程 序，ngx_lua会自动的在进行阻塞的IO操作时中断，保存上下文；然后将IO操作委托给Nginx事件处理机制，在IO操作完成后，ngx_lua会 恢复上下文，程序继续执行，这些操作都是对用户程序透明的。\n\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"二-lua介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-lua介绍"}},[s._v("#")]),s._v(" (二) lua介绍")]),s._v(" "),e("ul",[e("li",[s._v("基本思想")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1: nginx：高性能web服务器\n2: LuaJIT：即采用C语言写的Lua代码的解释器。\n3: lua-nginx-module (ngx_lua) ：可在 Nginx 中嵌入 Lua 语言。让 Nginx 可以支持 Lua 强大的语法。\n4: NDK（nginx developmentkit）：模块是一个拓展nginx服务器核心功能的模块，第三方模块开发可以基于它来快速实现。NDK提供函数和宏处理一些基本任务，减轻第三方模块开发的代码量\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("先安装lua")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('yum install -y lua\n\n[root@node1 ~]# lua\nLua 5.3.4  Copyright (C) 1994-2017 Lua.org, PUC-Rio\n### print("hello python")\nhello python\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ul",[e("li",[s._v("也可以脚本执行")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('[root@node1 ~]# cat lua_test.lua \n#!/usr/bin/lua\nprint("hello Robby")\n\n[root@node1 ~]# lua lua_test.lua\nhello Robby\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"三-nginx-lua编译-由于在centos上编译失败-这里是使用ubuntu18-04或centos-7-2版本编译"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-nginx-lua编译-由于在centos上编译失败-这里是使用ubuntu18-04或centos-7-2版本编译"}},[s._v("#")]),s._v(" "),e("code",[s._v("(三) NGINX+lua编译")]),s._v("(由于在centos上编译失败，这里是使用Ubuntu18.04或centos 7.2版本编译)")]),s._v(" "),e("ul",[e("li",[s._v("获取Nginx、LuaJIT、lua-nginx-module、ngx_devel_kit源码文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("wget http://nginx.org/download/nginx-1.17.5.tar.gz\nwget http://luajit.org/download/LuaJIT-2.1.0-beta3.tar.gz\nwget https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz\nwget https://github.com/openresty/lua-nginx-module/archive/v0.10.13.tar.gz\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("创建目录")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mkdir /opt/makecode\nmkdir /etc/nginx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("解压源码文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("tar xvf LuaJIT-2.1.0-beta3.tar.gz -C /opt/\ntar xvf nginx-1.17.5.tar.gz -C /opt/\ntar xvf v0.10.13.tar.gz -C /opt/\ntar xvf v0.3.0.tar.gz -C /opt/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("切换目录并对解压目录改名")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cd /opt\nmv nginx-1.17.5/ /opt/nginx \nmv LuaJIT-2.1.0-beta3/ /opt/luaJIT \n# 这里将NGINX两个第三方模块源码拷贝到了/etc/nginx目录下\nmv lua-nginx-module-0.10.13/ /etc/nginx/lua-nginx-module\nmv ngx_devel_kit-0.3.0/ /etc/nginx/ngx_devel_kit\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ul",[e("li",[s._v("编译安装luaJIT")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cd /opt/luaJIT \nmake PREFIX=/opt/luajit\nmake install PREFIX=/opt/luajit\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("定义luaJIT环境变量并刷新环境变量文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("echo -e 'export LUAJIT_LIB=/opt/luajit/lib\\nexport LUAJIT_INC=/opt/luajit/include/luajit-2.1' ### /etc/profile.d/nginx.sh\n. /etc/profile.d/nginx.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("安装nginx编译时需要的依赖(centos 7.2)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum -y install pcre-devel openssl openssl-devel.x86_64\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("安装nginx编译时需要的依赖(ubuntu 18.04)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("apt-get install openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("编译安装nginx")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cd /opt/nginx \n# 编译的时候，指定了lua-nginx-module和ngx_devel_kit两个模块一同编译进NGINX中\n./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-module=/etc/nginx/lua-nginx-module --add-module=/etc/nginx/ngx_devel_kit\nmake -j2\nmake install \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("拷贝luajit文件")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('cp /opt/luajit/lib/libluajit-5.1.so.2 /usr/local/lib/\necho "/usr/local/lib"  >>/etc/ld.so.conf\n/sbin/ldconfig\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("创建两个目录")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mkdir /etc/nginx/logs/\nmkdir /var/cache/nginx/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("创建NGINX用户")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("useradd -s /sbin/nologin -M nginx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"四-nginx调用lua模块的指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-nginx调用lua模块的指令"}},[s._v("#")]),s._v(" (四) NGINX调用lua模块的指令")]),s._v(" "),e("ul",[e("li",[s._v("NGINX的可插拔模块化加载执行，一共有11个处理阶段，这里列举了6中NGINX调用lua的使用方式")])]),s._v(" "),e("p",[s._v("| 指令    |   作用   |\n| :--------: |: --------😐\n| set_by_lua / set_by_lua_file    |   设置NGINX变量，可以实现复杂的赋值逻辑   |\n| access_by_lua / access_by_lua_file    |  请求访问阶段处理，用于访问控制 |\n| content_by_lua / content_by_lua_file    |  内容处理器，接收请求处理并输出响应 |")]),s._v(" "),e("ul",[e("li",[s._v("Lua脚本中，也可以调用NGINX的一些指令，来获取NGINX的信息，下面列举了一些简单的NGINX变量信息")])]),s._v(" "),e("p",[s._v("| 指令    |   作用   |\n| :--------: |: --------😐\n| ngx.var    |   nginx变量   |\n| ngx.req.get_headers   |   获取请求头  |\n| ngx.req.get_uri_args   |   获取url请求参数  |\n| ngx.redirect   |   重定向  |\n| ngx.print   |   输出响应内容体  |\n| ngx.say   |   同ngx.print，但是会最后输出一个换行符  |\n| ngx.header   |  输出响应头   |")]),s._v(" "),e("h3",{attrs:{id:"五-实现灰度发布"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-实现灰度发布"}},[s._v("#")]),s._v(" (五) 实现灰度发布")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1730),alt:"Alt text"}})]),s._v(" "),e("ul",[e("li",[s._v("安装memcached")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum install -y memcached\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("启动memcached")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# -p表示启动的端口，-u表示启动使用的用户，-d表示使用守护进程运行\nmemcached -p11211 -u nobody -d\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("启动NGINX")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("nginx -c /etc/nginx/nginx.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("修改/etc/nginx/conf.d/lua_test.conf")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n    listen       80;\n    server_name  www.yhyblog.cn;\n    # 直接返回字符串\n    location /hello {\n        default_type 'text/plain';\n        content_by_lua 'ngx.say(\"hello Robby\")';\n    }\n\t\n\t# 返回当前用户的IP\n    location /myip {\n        default_type 'text/plain';\n        content_by_lua '\n        clientIP = ngx.req.get_headers()[\"x_forwarded_for\"]\n        if clientIP == nil then\n                clientIP = ngx.req.get_headers()[\"X-Real-IP\"]\n        end\n        if clientIP == nil then\n                clientIP = ngx.var.remote_addr\n        end\n        ngx.say(\"ip:\", clientIP)';\n    }\n\t\n\t# 这里是匹配所有前面没有匹配到的请求\n    location / {\n        default_type 'text/plain';\n        # 加载lua脚本\n        content_by_lua_file /opt/app/lua/test.lua;\n    }\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   html;\n    }\n\t\n\t# 将请求调度到测试服务器\n    location @test_server {\n        proxy_pass http://192.168.100.246:9001;\n    }\n\t\n\t# 将请求调度到生产服务器\n    location @product_server {\n        proxy_pass http://192.168.100.180:9002;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br")])]),e("ul",[e("li",[s._v("安装lua调用memched的驱动包")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 下载\nwget https://codeload.github.com/openresty/lua-resty-memcached/tar.gz/v0.11\n\n# 解压\ntar xf v0.11\n\n# 拷贝到lua的目录中\nmkdir -pv /usr/local/share/lua/5.1/resty/\ncp  lua-resty-memcached-0.11/lib/resty/memcached.lua /usr/local/share/lua/5.1/resty/memcached.lua\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("ul",[e("li",[s._v("/opt/app/lua/test.lua脚本如下")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('-- 获取http协议的头部变量\nclientIP = ngx.req.get_headers()["X-Real-IP"]\n\nif clientIP == nil then\n    clientIP = ngx.req.get_headers()["x_forwarded_for"]\nend\n\nif clientIP == nil then\n    clientIP = ngx.var.remote_addr\nend\n\n-- 获取一个memche类\nlocal memcached = require "resty.memcached"\n-- 创建一个memche连接\nlocal memc, err = memcached:new()\nif not memc then\n    ngx.say("failed to instantiate memc: ", err)\n    return\nend\n-- 连接到本地的memche服务\nlocal ok, err = memc:connect("127.0.0.1", 11211)\nif not ok then\n    ngx.say("failed to connect: ", err)\n    return\nend\n-- 基于memcache api，获取客户端IP对应的value值\nlocal res, flags, err = memc:get(clientIP)\n-- ngx.say("value key: ", res, clientIP)\nif err then\n    ngx.say("failed to get clientIP", err)\n    return\nend\n\n-- 如果value为1\nif res == "1" then\n    -- 将请求调度到@test_server这个location\n    ngx.exec("@test_server")\n    return\nend\n-- 如果value不为1, 直接将请求调度到@product_server这个location\nngx.exec("@product_server")\nreturn\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br")])]),e("ul",[e("li",[s._v("重启NGINX(修改了lua脚本必须重启nginx)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# nginx\nnginx -s reload -c /etc/nginx/nginx.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("请求调度效果演示(当memcached中客户端的IP获取的value为"),e("code",[s._v("0")]),s._v("的时候，调度到生产服务器)")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(1731),alt:"Alt text"}})]),s._v(" "),e("ul",[e("li",[s._v("请求调度效果演示(当memcached中客户端的IP获取的value为"),e("code",[s._v("1")]),s._v("的时候，调度到测试服务器)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("telnet 127.0.0.1 11211\nset 192.168.100.3 0 0 1\n1  # 设置value值为1\nSTORED\n\nget 192.168.100.3\nVALUE 192.168.100.3 0 1\n1  # 设置value值为1\nEND\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[e("img",{attrs:{src:a(1732),alt:"Alt text"}})]),s._v(" "),e("h3",{attrs:{id:"五-nginx调用redis-从redis内获取ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-nginx调用redis-从redis内获取ip"}},[s._v("#")]),s._v(" (五) NGINX调用Redis，从Redis内获取IP")]),s._v(" "),e("ul",[e("li",[s._v("访问OpenResty的官方网站，点击【组件】菜单栏，这里可以下载NGINX的第三方lua模块，这里选择【LuaRestyRedisLibrary】模块，并且从github将项目克隆")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("git clone https://github.com/openresty/lua-resty-redis.git\n\n# 将redis驱动拷贝到lua的共享库中\ncp lua-resty-redis/lib/resty/redis.lua  /usr/local/share/lua/5.1/resty/redis.lua\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("在NGINX的/etc/nginx/conf.d/lua_test.conf配置文件中修改location加载的lua脚本")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    location / {\n        default_type 'text/plain';\n        content_by_lua_file /opt/app/lua/redis.lua;\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("/opt/app/lua/redis.lua内容如下")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('-- 获取http协议的头部变量\nclientIP = ngx.req.get_headers()["X-Real-IP"]\n\nif clientIP == nil then\n        clientIP = ngx.req.get_headers()["x_forwarded_for"]\nend\n\nif clientIP == nil then\n        clientIP = ngx.var.remote_addr\nend\n\n-- 获取一个redis类\nlocal redis = require "resty.redis"\nlocal red = redis:new()\n-- red:set_timeouts(1000, 1000, 1000)\n\n-- 创建一个redis连接\nlocal ok, err = red:connect("127.0.0.1", 6379)\nif not ok then\n    ngx.say("failed to connect: ", err)\n    return\nend\n\n-- 基于redis api，获取客户端IP对应的value值\nlocal res, err = red:get(clientIP)\nif not res then\n    ngx.say("failed to get clientIP: ", err)\n    return\nend\n\n\n-- 如果value为1\nif res == "1" then\n    -- 将请求调度到测试服务器\n    ngx.exec("@test_server")\n    return\nend\n\nngx.exec("@product_server")\nreturn\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br")])]),e("ul",[e("li",[s._v("重启NGINX，发现和memcached一样")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("nginx -s reload -c /etc/nginx/nginx.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);