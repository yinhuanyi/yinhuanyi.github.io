(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{2253:function(n,s,t){"use strict";t.r(s);var a=t(9),e=Object(a.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h2",{attrs:{id:"一-架构分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-架构分析"}},[n._v("#")]),n._v(" 一：架构分析")]),n._v(" "),a("p",[a("img",{attrs:{src:t(778),alt:"Alt text"}})]),n._v(" "),a("h3",{attrs:{id:"一-架构思想"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-架构思想"}},[n._v("#")]),n._v(" (一) 架构思想")]),n._v(" "),a("ul",[a("li",[n._v("1：使用Etcd的watch功能，替代了消息队列发布订阅功能")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t当Etcd中写入一个key的时候，所有的worker都将监控到这个key，并且获取到key的value值，替代了rabbitmq的发布订阅功能\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("2：多个worker存储的任务是一样的，只要有一个worker监控，那么任务就可以执行")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\tworker具备高可用性\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("ul",[a("li",[n._v("3：使用Etcd的txn事务创建一个key的revision，如果创建成功，说明抢到了锁")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t抢到etcd锁通过创建key的revision实现\n\t释放锁通过取消etcd中key的自动续约和删除leaseID实现\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br")])]),a("h2",{attrs:{id:"二-master实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-master实现"}},[n._v("#")]),n._v(" 二：master实现")]),n._v(" "),a("h3",{attrs:{id:"一-技术点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-技术点"}},[n._v("#")]),n._v(" (一) 技术点")]),n._v(" "),a("ul",[a("li",[n._v("1：apiserver基于"),a("code",[n._v("net/http")]),n._v("库实现，使用协程启动HTTP服务")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('func InitApiServer() (err error) {\n\n\t// 初始化路由\n\tmux := http.NewServeMux()\n\n\t// 处理handler\n\tmux.HandleFunc("/job/save", handleJobSave)\n\tmux.HandleFunc("/job/delete", handleJobDelete)\n\tmux.HandleFunc("/job/list", handleJobList)\n\tmux.HandleFunc("/job/kill", handleJobKill)\n\tmux.HandleFunc("/job/log", handleJobLog)\n\tmux.HandleFunc("/worker/list", handleWorkerList)\n\n\t// 指定静态文件目录, 且为静态文件设置路由\n\tstaticDir := http.Dir(G_config.WebRoot)\n\tstaticHandler := http.FileServer(staticDir)\n\tmux.Handle("/", http.StripPrefix("/", staticHandler))\n\n\t// 建立TCP连接\n\tlistener, err := net.Listen("tcp", ":" + strconv.Itoa(G_config.ApiPort))\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\t// 创建一个HTTP服务\n\thttpServer := &http.Server{\n\t\tReadTimeout: time.Duration(G_config.ApiReadTimeout) * time.Millisecond,\n\t\tWriteTimeout: time.Duration(G_config.ApiWriteTimeout) * time.Millisecond,\n\t\tHandler: mux,\n\t}\n\n\t// 赋值单例\n\tG_apiServer = &ApiServer{\n\t\thttpServer: httpServer,\n\t}\n\n\t// 让http协议server到tcp协议上\n\tgo httpServer.Serve(listener)\n\n\treturn\n\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br")])]),a("ul",[a("li",[n._v("2：将下发的定时任务"),a("code",[n._v('{"name": "job1", "command": "echo hello", "cronExpr": "* * * * *"}')]),n._v("，写入到Etcd的"),a("code",[n._v("/cron/jobs/")]),n._v("目录下，例如：key为:"),a("code",[n._v("/cron/jobs/")]),n._v("果是更新，那么会返回之前的定时任务")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("// SaveJob 写入任务到Etcd(创建新任务 或者 修改任务)\nfunc (j *JobMgr) SaveJob (job *common.Job) (oldJob *common.Job, err error) {\n\t// 把任务写入到/cron/jobs/任务名称 -> json\n\n\tjobKey := common.JOB_SAVE_DIR + job.Name\n\tjobValue, err := json.Marshal(job)\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\t// 这里的任务写入不会失效\n\tputResp, err := j.kv.Put(context.Background(), jobKey, string(jobValue), clientv3.WithPrevKV())\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\t// 如果是更新，可以返回覆盖之前的值\n\tif putResp.PrevKv != nil {\n\t\toldJobString := new(common.Job)\n\t\terr = json.Unmarshal(putResp.PrevKv.Value, oldJobString)\n\t\tif err != nil {\n\t\t\tlog.Panicf(err.Error())\n\t\t}\n\t\toldJob = oldJobString\n\t}\n\n\treturn\n\n}\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br")])]),a("ul",[a("li",[n._v("3：删除定时任务是将任务从/cron/jobs/目录下删除掉，删除任务的时候，只需要知道key即可，也就是"),a("code",[n._v("/cron/jobs/job1")]),n._v(", 删除也会返回之前的任务")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("func (j *JobMgr) DeleteJob(name string) (oldJob *common.Job, err error) {\n\n\t// etcd中保存任务的key\n\tjobKey := common.JOB_SAVE_DIR + name\n\n\t// 从etcd中删除它\n\tdelResp, err := j.kv.Delete(context.Background(), jobKey, clientv3.WithPrevKV())\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\t// 如果删除之前有值，返回删除之前的数据\n\tif len(delResp.PrevKvs) != 0 {\n\n\t\toldJobObj := new(common.Job)\n\t\terr = json.Unmarshal(delResp.PrevKvs[0].Value, oldJobObj)\n\t\tif err != nil {\n\t\t\tlog.Panicf(err.Error())\n\t\t}\n\t\toldJob = oldJobObj\n\t}\n\treturn\n}\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br")])]),a("ul",[a("li",[n._v("4：强杀任务需要将任务名称写入到"),a("code",[n._v("/cron/killer/")]),n._v("目录下，例如："),a("code",[n._v("/cron/killer/job1")]),n._v("，写入的时候使用租约，租约有效时间是1秒，1秒后，key自动删除，目的只是通过etcd给worker节点发送任务强杀的指令，不需要存储")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('// KillJob 杀死任务\nfunc (j *JobMgr) KillJob(name string) (err error) {\n\t// 更新一下key=/cron/killer/任务名\n\n\t// 通知worker杀死对应任务\n\tkillerKey := common.JOB_KILLER_DIR + name\n\n\t// 授权一个1秒的租约，租约让key稍后自动过期，如果key写入etcd，被worker监控到，那么杀死对应的任务，且key会1秒后自动过期\n\tleaseGrantResp, err := j.lease.Grant(context.Background(), 1)\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\t// 获取租约ID\n\tleaseId := leaseGrantResp.ID\n\n\n\t// 写入一个带租约的key\n\t_, err = j.kv.Put(context.TODO(), killerKey, "", clientv3.WithLease(leaseId))\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t}\n\n\treturn\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br")])]),a("h2",{attrs:{id:"三-worker-实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-worker-实现"}},[n._v("#")]),n._v(" 三：worker 实现")]),n._v(" "),a("h3",{attrs:{id:"一-业务设计流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-业务设计流程"}},[n._v("#")]),n._v(" (一) 业务设计流程")]),n._v(" "),a("ul",[a("li",[n._v("worker的业务设计流程如下")])]),n._v(" "),a("p",[a("img",{attrs:{src:t(779),alt:"Alt text"}})]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("1：在jobmgr中，监控etcd中/cron/jobs/ 和 /cron/killer/目录的变化, 基于变化的key获取到value，将value转换为事件对象写入到jobEventChan中。【启动协程】监控/cron/jobs/目录的时候，会先将已经存在的任务，推送到jobEventChan中，再监控/cron/jobs/目录，判断事件是PUT 还是DELETE，PUT和DELETE分别构建后，推送到jobEventChan中。启动协程监控/cron/killer/目录的时候，如果判断是PUT事件，构建kill时间对象，推送到jobEventChan中\n\n2：scheduler会在初始化的时候，【启动协程】调用scheduleLoop，在scheduleLoop里面，for select 方式获取jobEventChan、jobResultChan、scheduleTimer.C这三个通道的数据，如果jobEventChan有数据，判断类型后，交由executor去执行，执行的结果写入到jobResultChan中。对于jobEventChan中的事件，如果是save类型就将任务写入到任务表，如果是delete类型就从任务表删除任务，如果是强杀类型就获取执行表任务，调用cancel终止任务执行。对于jobResultChan中的事件，接收从jobResultChan中获取的事件结果，将结果转换为log对象，交由sink模块处理，写入到MongoDB中。如果从scheduleTimer.C获取到数据，那么什么都不做，主要是让for select语句不阻塞，主要for select语句不阻塞，那么就可以遍历jobPlanTable任务表，计算所有任务中，最近一次需要执行的时间点，从而获取下定时器的时间间隔。如果是从jobEventChan、jobResultChan获取到数据，那么遍历列表的时间点(调度的时间点)会提前\n\n3：在executor中比较特别，启动的时候只是初始化一个全局变量，当schedule有job任务需要执行的时候，才会调用执行器的ExecuteJob方法，在方法里面【启动协程】，每个任务都是在协程中执行的，再将任务的结果返回给scheduler的jobResultChan\n\n4：在jobsink中，【启动协程】从logChan队列中获取log结构体对象写入到MongoDB中，这是scheduler将job对象写入到logChan队列中的\n\n5：在joblock中，是解决多个worker工作的情况下，每个worker都有相同的jobPlan，那么当每个worker执行的时候，哪个worker可以抢到etcd中的锁，就哪个执行任务，执行完毕后，在处理结果日志方法中，将jobExecutingTable(任务执行表)中对应的job移除掉。那么下次当任务过期后，所有的worker又再次争抢etcd的锁了。因此jobExecutingTable的意义在于：有些任务需要执行很长时间，可能卡住了，在这个过程中，定时任务到了时间又会触发任务，jobExecutingTable避免前一个任务没有执行完，又执行任务的情况。分布式任务锁的意义在于：所有worker都有完整的jobPlanTable任务表，但是只能一个worker执行任务，也就是谁抢到锁，谁执行任务\n\n6：在register中，主要是将worker的IP都注册到etcd中，让master知道有多少worker可以执行任务\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br")])]),a("h3",{attrs:{id:"二-相关代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-相关代码"}},[n._v("#")]),n._v(" (二) 相关代码")]),n._v(" "),a("ul",[a("li",[n._v("jobmgr.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: jobmgr.go\n * @Create date: 2021-08-17\n * @Function: 监控etcd中，/cron/jobs/ 和 /cron/killer/的变化, 将基于变化的key获取到value，将value转换为事件写入到jobEventChan中\n **/\n\npackage worker\n\nimport (\n\t"context"\n\t"go-task/common"\n\t"go.etcd.io/etcd/api/v3/mvccpb"\n\tclientv3 "go.etcd.io/etcd/client/v3"\n\t"time"\n)\n\nvar G_jobMgr *JobMgr\n\ntype JobMgr struct {\n\tclient *clientv3.Client\n\tkv clientv3.KV\n\tlease clientv3.Lease\n\twatcher clientv3.Watcher\n}\n\n// watchJobs 监听/cron/jobs/目录下key的变化，将变化的job转换为事件写入到jobEventChan\nfunc (j *JobMgr) watchJobs() (err error) {\n\n\tvar jobEvent *common.JobEvent\n\n\t// 获取/cron/jobs/目录下的所有任务，也就是所有的key，并且获知当前集群的revision\n\tgetResp, err := j.kv.Get(context.TODO(), common.JOB_SAVE_DIR, clientv3.WithPrefix())\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 遍历/cron/jobs/目录下所有的key， getResp.Kvs == [{"/cron/jobs/job1": "{"name": "job1", "command": "echo hello", "cronExpr": "* * * * *"}"}]\n\t// 每次程序启动的时候，会先从执行一下所有写入到/cron/jobs/目录下的key\n\tfor _, kvpair := range getResp.Kvs {\n\n\t\t// 反序列化json得到Job\n\t\tjob, err1 := common.UnpackJob(kvpair.Value)\n\t\tif err1 != nil {\n\t\t\treturn\n\t\t}\n\n\t\t// 创建save事件\n\t\tjobEvent = common.BuildJobEvent(common.JOB_EVENT_SAVE, job)\n\n\t\t// 将事件写入到jobEventChan\n\t\tG_scheduler.PushJobEvent(jobEvent)\n\t}\n\n\t// 2, 从该revision向后监听变化事件， 监听协程\n\tgo func() {\n\n\t\t// 从GET时刻的后续版本开始监听变化\n\t\twatchStartRevision := getResp.Header.Revision + 1\n\t\t// 监听/cron/jobs/目录的后续变化\n\t\twatchChan := j.watcher.Watch(context.TODO(), common.JOB_SAVE_DIR, clientv3.WithRev(watchStartRevision), clientv3.WithPrefix())\n\n\t\t// 如果没有key变化，那么这里会阻塞\n\t\tfor watchResp := range watchChan {\n\t\t\tfor _, watchEvent := range watchResp.Events {\n\n\t\t\t\tswitch watchEvent.Type {\n\n\t\t\t\tcase mvccpb.PUT: // 如果是保存事件\n\t\t\t\t\tjob, err := common.UnpackJob(watchEvent.Kv.Value)\n\t\t\t\t\tif err != nil {\n\t\t\t\t\t\tcontinue\n\t\t\t\t\t}\n\t\t\t\t\t// 构建一个更新Event\n\t\t\t\t\tjobEvent = common.BuildJobEvent(common.JOB_EVENT_SAVE, job)\n\n\t\t\t\tcase mvccpb.DELETE: // 如果是删除事件\n\n\t\t\t\t\tjobName := common.ExtractJobName(string(watchEvent.Kv.Key), common.JOB_SAVE_DIR)\n\n\t\t\t\t\tjob := &common.Job{Name: jobName}\n\n\t\t\t\t\t// 构建一个删除Event\n\t\t\t\t\tjobEvent = common.BuildJobEvent(common.JOB_EVENT_DELETE, job)\n\t\t\t\t}\n\n\t\t\t\t// 将事件写入到jobEventChan\n\t\t\t\tG_scheduler.PushJobEvent(jobEvent)\n\t\t\t}\n\t\t}\n\t}()\n\treturn\n}\n\n// watchKiller  监听/cron/killer/目录下key的变化，将变化的job转换为事件写入到jobEventChan\nfunc (j *JobMgr) watchKiller() {\n\n\t// 监听/cron/killer目录\n\tgo func() {\n\n\t\t// 监听/cron/killer/目录下key的变化\n\t\twatchChan := j.watcher.Watch(context.TODO(), common.JOB_KILLER_DIR, clientv3.WithPrefix())\n\n\t\t// 处理监听事件, 如果没有事件，这里会阻塞\n\t\tfor watchResp := range watchChan {\n\t\t\tfor _, watchEvent := range watchResp.Events {\n\t\t\t\tswitch watchEvent.Type {\n\t\t\t\tcase mvccpb.PUT: // 新建kill任务\n\n\t\t\t\t\tjobName := common.ExtractJobName(string(watchEvent.Kv.Key), common.JOB_KILLER_DIR)\n\t\t\t\t\tjob := &common.Job{Name: jobName}\n\t\t\t\t\tjobEvent := common.BuildJobEvent(common.JOB_EVENT_KILL, job)\n\n\t\t\t\t\t// 将事件写入到jobEventChan\n\t\t\t\t\tG_scheduler.PushJobEvent(jobEvent)\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n}\n\n// InitJobMgr 初始化管理器\nfunc InitJobMgr() (err error) {\n\n\t// 初始化配置\n\tconfig := clientv3.Config{\n\t\tEndpoints: G_config.EtcdEndpoints, // 集群地址\n\t\tDialTimeout: time.Duration(G_config.EtcdDialTimeout) * time.Millisecond, // 连接超时\n\t}\n\n\t// 建立连接\n\tclient, err := clientv3.New(config)\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 创建上下文\n\ttimeoutCtx, cancel := context.WithTimeout(context.Background(), 2 * time.Second)\n\tdefer cancel()\n\t_, err = client.Status(timeoutCtx, config.Endpoints[0])\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 得到KV和Lease的API子集\n\tkv := clientv3.NewKV(client)\n\tlease := clientv3.NewLease(client)\n\twatcher := clientv3.NewWatcher(client)\n\n\t// 赋值单例\n\tG_jobMgr = &JobMgr{\n\t\tclient: client,\n\t\tkv: kv,\n\t\tlease: lease,\n\t\twatcher: watcher,\n\t}\n\n\t// 基于协程启动监听/cron/jobs/目录下key的变化\n\terr = G_jobMgr.watchJobs()\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 基于协程启动监听/cron/killer/目录下key的变化\n\tG_jobMgr.watchKiller()\n\n\n\treturn\n\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br"),a("span",{staticClass:"line-number"},[n._v("134")]),a("br"),a("span",{staticClass:"line-number"},[n._v("135")]),a("br"),a("span",{staticClass:"line-number"},[n._v("136")]),a("br"),a("span",{staticClass:"line-number"},[n._v("137")]),a("br"),a("span",{staticClass:"line-number"},[n._v("138")]),a("br"),a("span",{staticClass:"line-number"},[n._v("139")]),a("br"),a("span",{staticClass:"line-number"},[n._v("140")]),a("br"),a("span",{staticClass:"line-number"},[n._v("141")]),a("br"),a("span",{staticClass:"line-number"},[n._v("142")]),a("br"),a("span",{staticClass:"line-number"},[n._v("143")]),a("br"),a("span",{staticClass:"line-number"},[n._v("144")]),a("br"),a("span",{staticClass:"line-number"},[n._v("145")]),a("br"),a("span",{staticClass:"line-number"},[n._v("146")]),a("br"),a("span",{staticClass:"line-number"},[n._v("147")]),a("br"),a("span",{staticClass:"line-number"},[n._v("148")]),a("br"),a("span",{staticClass:"line-number"},[n._v("149")]),a("br"),a("span",{staticClass:"line-number"},[n._v("150")]),a("br"),a("span",{staticClass:"line-number"},[n._v("151")]),a("br"),a("span",{staticClass:"line-number"},[n._v("152")]),a("br"),a("span",{staticClass:"line-number"},[n._v("153")]),a("br"),a("span",{staticClass:"line-number"},[n._v("154")]),a("br"),a("span",{staticClass:"line-number"},[n._v("155")]),a("br"),a("span",{staticClass:"line-number"},[n._v("156")]),a("br"),a("span",{staticClass:"line-number"},[n._v("157")]),a("br"),a("span",{staticClass:"line-number"},[n._v("158")]),a("br"),a("span",{staticClass:"line-number"},[n._v("159")]),a("br"),a("span",{staticClass:"line-number"},[n._v("160")]),a("br"),a("span",{staticClass:"line-number"},[n._v("161")]),a("br"),a("span",{staticClass:"line-number"},[n._v("162")]),a("br"),a("span",{staticClass:"line-number"},[n._v("163")]),a("br"),a("span",{staticClass:"line-number"},[n._v("164")]),a("br"),a("span",{staticClass:"line-number"},[n._v("165")]),a("br"),a("span",{staticClass:"line-number"},[n._v("166")]),a("br"),a("span",{staticClass:"line-number"},[n._v("167")]),a("br"),a("span",{staticClass:"line-number"},[n._v("168")]),a("br"),a("span",{staticClass:"line-number"},[n._v("169")]),a("br"),a("span",{staticClass:"line-number"},[n._v("170")]),a("br"),a("span",{staticClass:"line-number"},[n._v("171")]),a("br")])]),a("ul",[a("li",[n._v("scheduler.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: scheduler.go\n * @Create date: 2021-08-17\n * @Function: jobmgr模块将etcd事件写入到jobEventChan中，scheduler获取事件，判断类型后，交由executor去执行，执行的结果写入到jobResultChan中  【完毕】\n **/\n\npackage worker\n\nimport (\n\t"errors"\n\t"fmt"\n\t"go-task/common"\n\t"time"\n)\n\nvar G_scheduler *Scheduler\n\n// Scheduler 任务调度\ntype Scheduler struct {\n\n\t/*\n\t\tetcd的事件\n\t\tjobEventChan = {\n\t\t    "EventType":"1",  表示put操作\n\t\t    "Job":{\n\t\t        "name":"job1",\n\t\t        "command":"ls -l",\n\t\t        "conExpr":"* * * * *"\n\t\t    }\n\t\t}\n\t*/\n\tjobEventChan chan *common.JobEvent //  etcd任务事件队列\n\n\t/*\n\t\t任务计划表结构\n\t\tjobPlanTable = {\n\t\t    "job1":{\n\t\t        "Job":{\n\t\t            "name":"job1",\n\t\t            "command":"ls -l",\n\t\t            "conExpr":"* * * * *"\n\t\t        },\n\t\t        "expr":"* * * * * *",\n\t\t        "nextTime":"1秒"\n\t\t    }\n\t\t}\n\t*/\n\tjobPlanTable map[string]*common.JobSchedulePlan // 任务调度计划表\n\n\t/*\n\t\t\t任务执行表结构\n\t\tjobExecutingTable = {\n\t\t    "job1":{\n\t\t        "job":{\n\t\t            "name":"job1",\n\t\t            "command":"ls -l",\n\t\t            "conExpr":"* * * * *"\n\t\t        },\n\t\t        "PlanTime":"理论调度时间点",\n\t\t        "RealTime":"时间调度时间点",\n\t\t        "CancelCtx":"ctx上下文",\n\t\t        "CancelFunc":"ctx cancel函数"\n\t\t    }\n\t\t}\n\t*/\n\tjobExecutingTable map[string]*common.JobExecuteInfo // 任务执行表\n\n\t/*\n\t\tjobResultChan == {\n\t\t    "output":"脚本执行结果",\n\t\t    "err":"错误原因",\n\t\t    "StartTime":"任务启动时间点",\n\t\t    "EndTime":"任务结束时间点",\n\t\t    "ExecuteInfo":{\n\t\t        "job":{\n\t\t            "name":"job1",\n\t\t            "command":"ls -l",\n\t\t            "conExpr":"* * * * *"\n\t\t        },\n\t\t        "PlanTime":"理论调度时间点",\n\t\t        "RealTime":"时间调度时间点",\n\t\t        "CancelCtx":"ctx上下文",\n\t\t        "CancelFunc":"ctx cancel函数"\n\t\t    }\n\t\t}\n\t*/\n\tjobResultChan chan *common.JobExecuteResult // 任务结果队列\n}\n\n// InitScheduler 初始化调度器, 也就是初始化任务执行\nfunc InitScheduler() (err error) {\n\tG_scheduler = &Scheduler{\n\t\tjobEventChan:      make(chan *common.JobEvent, 1000),\n\t\tjobPlanTable:      make(map[string]*common.JobSchedulePlan),\n\t\tjobExecutingTable: make(map[string]*common.JobExecuteInfo),\n\t\tjobResultChan:     make(chan *common.JobExecuteResult, 1000),\n\t}\n\t// 启动调度协程\n\tgo G_scheduler.scheduleLoop()\n\treturn\n}\n\n// TryStartJob 为TrySchedule服务，这里是真正的执行任务，将jobPlan转换为jobExecuteInfo，调用 executor.go的接口执行任务  【看懂了】\n// jobplay == {"expr": "* * * * * *", "nextTime": 1秒, "Job":{ "name":"job1", "command":"ls -l", "conExpr":"* * * * *" }}\nfunc (s *Scheduler) TryStartJob(jobPlan *common.JobSchedulePlan) {\n\t// todo: 这里有个避免任务重复执行的核心思想\n\t// 在执行任务之前，先判断一下，任务是否在执行，如果任务执行表中有任务，那么说明已经有任务在执行了，就直接返回，避免在执行的过程中再来发现取不到etcd的锁，而放弃执行\n\t// 执行任务表解决的问题是：单个进程中，任务不会重复执行\n\t// etcd分布式任务所解决的问题是：多个进程中，任务不会重复执行\n\tjobExecuteInfo, jobExecuting := s.jobExecutingTable[jobPlan.Job.Name]\n\tif jobExecuting { // 如果可以取到值，说明任务正在执行\n\t\tfmt.Println("尚未退出,跳过执行:", jobPlan.Job.Name)\n\t\treturn\n\t}\n\n\t// 创建执行信息\n\tjobExecuteInfo = common.BuildJobExecuteInfo(jobPlan)\n\n\t// 保存执行状态\n\ts.jobExecutingTable[jobPlan.Job.Name] = jobExecuteInfo\n\n\t// 执行任务\n\tfmt.Println("执行任务:", jobExecuteInfo.Job.Name, jobExecuteInfo.PlanTime, jobExecuteInfo.RealTime)\n\n\t// 基于执行信息执行任务 jobExecuteInfo == {"job":{"name":"job1","command":"ls -l","conExpr":"* * * * *"},"PlanTime":"理论调度时间点","RealTime":"时间调度时间点","CancelCtx":"ctx上下文","CancelFunc":"ctx cancel函数"}}\n\tG_executor.ExecuteJob(jobExecuteInfo)\n}\n\n// TrySchedule 为scheduleLoop服务，计算下次需要调度的时间间隔，同时这个方法里面也遍历了任务表执行调度任务  【看懂了】\nfunc (s *Scheduler) TrySchedule() (scheduleAfter time.Duration) {\n\n\t// nearTime的意义在于计算出jobPlan中，最小需要执行任务的时间点\n\tvar nearTime *time.Time\n\n\t// 当前时间\n\tnow := time.Now()\n\n\t// 如果任务表不为空，遍历所有任务 jobPlanTable == {"job1": {"expr": "* * * * * *", "nextTime": 2021-08-08 13:13:13, "Job":{ "name":"job1", "command":"ls -l", "conExpr":"* * * * *" }}}\n\tfor _, jobPlan := range s.jobPlanTable {\n\t\tif jobPlan.NextTime.Before(now) || jobPlan.NextTime.Equal(now) { // 满足定时表达式任务执行时间，执行任务\n\t\t\ts.TryStartJob(jobPlan)                    // 这是执行真正的业务。 jobplay == {"expr": "* * * * * *", "nextTime": 2021-08-08 13:13:13, "Job":{ "name":"job1", "command":"ls -l", "conExpr":"* * * * *" }}\n\t\t\tjobPlan.NextTime = jobPlan.Expr.Next(now) // 更新下次执行时间\n\t\t}\n\n\t\t// 找到所有任务中，下次需要执行时间点最近的那个时间点\n\t\tif nearTime == nil || jobPlan.NextTime.Before(*nearTime) {\n\t\t\tnearTime = &jobPlan.NextTime\n\t\t}\n\t}\n\n\t// 动态计算最近时间点到现在的时间间隔，如果没有任何任务，neartime可能是nil，那么直接设置下次调度时间为1秒即可\n\tif nearTime != nil {\n\t\tscheduleAfter = (*nearTime).Sub(now)\n\t}else {\n\t\tscheduleAfter = 1 * time.Second\n\t}\n\n\n\treturn\n}\n\n// handleJobEvent ：判断事件类型，如果是save类型就将任务写入到任务表，如果是delete类型就从任务表删除任务，如果是强杀类型就获取执行表任务，调用cancel终止任务执行 【看懂了】\n// jobEvent == ("EventType":"1", "Job":{"name":"job1", "command":"ls -l", "conExpr":"* * * * *"})\nfunc (s *Scheduler) handleJobEvent(jobEvent *common.JobEvent) {\n\n\t// 判断事件类型\n\tswitch jobEvent.EventType {\n\n\tcase common.JOB_EVENT_SAVE:\t// 保存任务事件, 也即是etcd中put了新的job任务\n\t\tjobPlan, err := common.BuildJobSchedulePlan(jobEvent.Job)\n\t\tif err != nil {\n\t\t\treturn\n\t\t}\n\t\t// 将jobPlan添加到jobPlanTable中\n\t\ts.jobPlanTable[jobEvent.Job.Name] = jobPlan\n\n\tcase common.JOB_EVENT_DELETE: // 删除任务事件\n\t\t_, jobExisted := s.jobPlanTable[jobEvent.Job.Name]\n\t\tif jobExisted {\n\t\t\tdelete(s.jobPlanTable, jobEvent.Job.Name)\n\t\t}\n\n\tcase common.JOB_EVENT_KILL: // 强杀任务事件\n\t\t// 先从执行表中获取任务，如果能够获取到，说明任务正在执行\n\t\tjobExecuteInfo, jobExecuting := s.jobExecutingTable[jobEvent.Job.Name]\n\t\tif jobExecuting {\n\t\t\t// 如果任务正在执行，调用context的cancel函数，中断任务执行\n\t\t\tjobExecuteInfo.CancelFunc()\n\t\t}\n\t}\n}\n\n// handleJobResult 接收从jobResultChan中获取的事件结果，将结果转换为log对象，交由sink模块处理，写入到MongoDB中【看懂了】\nfunc (s *Scheduler) handleJobResult(result *common.JobExecuteResult) {\n\n\t// 只要获取到了任务的执行结果，说明任务执行完毕了，那么必须从任务执行表中删除掉\n\tdelete(s.jobExecutingTable, result.ExecuteInfo.Job.Name)\n\n\t// 生成执行日志\n\tif result.Err != errors.New("锁已被占用") { // 这里只记录锁没有被占用的日志\n\n\t\t// 创建MongoDB存储的日志对象\n\t\tjobLog := &common.JobLog{\n\t\t\tJobName: result.ExecuteInfo.Job.Name,\n\t\t\tCommand: result.ExecuteInfo.Job.Command,\n\t\t\tOutput: string(result.Output),\n\t\t\tPlanTime: result.ExecuteInfo.PlanTime.UnixNano() / 1000 / 1000,  // 精确到毫秒\n\t\t\tScheduleTime: result.ExecuteInfo.RealTime.UnixNano() / 1000 / 1000,\n\t\t\tStartTime: result.StartTime.UnixNano() / 1000 / 1000,\n\t\t\tEndTime: result.EndTime.UnixNano() / 1000 / 1000,\n\t\t}\n\n\t\t// 如果有错误日志，那么存储，如果没有就是空\n\t\tif result.Err != nil {\n\t\t\tjobLog.Err = result.Err.Error()\n\n\t\t} else {\n\t\t\tjobLog.Err = ""\n\t\t}\n\n\t\t// 将log日志对象交给sink模块处理\n\t\tG_logSink.Append(jobLog)\n\t}\n\n}\n\n// scheduleLoop 调度协程，死循环不断获取jobEventChan中的etcd事件，和jobResultChan执行结果对象\nfunc (s *Scheduler) scheduleLoop() {\n\n\t// 初始化一次(1秒)\n\tscheduleAfter := 1 * time.Second\n\n\n\t// 基于设置的过期时间，创建timer定时器\n\tscheduleTimer := time.NewTimer(scheduleAfter)\n\n\t// 死循环不断获取jobEventChan中的etcd事件，和jobResultChan执行结果对象\n\tfor {\n\t\tselect {\n\t\t// \tjobEvent = ("EventType":"1", "Job":{"name":"job1", "command":"ls -l", "conExpr":"* * * * *"})\n\t\tcase jobEvent := <- s.jobEventChan: // 监听channel中etcd事件\n\t\t\ts.handleJobEvent(jobEvent) // 处理etcd事件\n\n\t\tcase jobResult := <- s.jobResultChan: // 监听channel中的执行结果\n\t\t\ts.handleJobResult(jobResult)\n\n\t\t\t// todo：这个是干啥的 ?\n\t\t\t// 这个是当jobEventChan和jobResultChan没有数据的时候，为了让select不阻塞，那么当定时器过期，就会获取到scheduleTimer.C时间点，让for循环可以向下走，不断执行s.TrySchedule()，遍历jobPlanTable中的任务，执行过期任务\n\t\tcase <-scheduleTimer.C: // 最近的任务到期了, scheduleTimer.C 返回当前的时间对象\n\t\t}\n\n\t\t// 由于scheduler.C定时器通道的存在，如果即使获取不到事件channel和结果channel的数据，也会在1秒后，执行调度任务\n\t\tscheduleAfter = s.TrySchedule()\n\n\t\t// 重置timer，并且每次调度的时间是通过\n\t\tscheduleTimer.Reset(scheduleAfter)\n\t}\n\n}\n\n// PushJobResult 将executor任务的执行结果写入到channel中\nfunc (s *Scheduler) PushJobResult(jobResult *common.JobExecuteResult) {\n\ts.jobResultChan <- jobResult\n}\n\n// PushJobEvent 为jobmgr服务，接收job事件，写入到jobEventChan中\nfunc (s *Scheduler) PushJobEvent(jobEvent *common.JobEvent) {\n\ts.jobEventChan <- jobEvent\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br"),a("span",{staticClass:"line-number"},[n._v("134")]),a("br"),a("span",{staticClass:"line-number"},[n._v("135")]),a("br"),a("span",{staticClass:"line-number"},[n._v("136")]),a("br"),a("span",{staticClass:"line-number"},[n._v("137")]),a("br"),a("span",{staticClass:"line-number"},[n._v("138")]),a("br"),a("span",{staticClass:"line-number"},[n._v("139")]),a("br"),a("span",{staticClass:"line-number"},[n._v("140")]),a("br"),a("span",{staticClass:"line-number"},[n._v("141")]),a("br"),a("span",{staticClass:"line-number"},[n._v("142")]),a("br"),a("span",{staticClass:"line-number"},[n._v("143")]),a("br"),a("span",{staticClass:"line-number"},[n._v("144")]),a("br"),a("span",{staticClass:"line-number"},[n._v("145")]),a("br"),a("span",{staticClass:"line-number"},[n._v("146")]),a("br"),a("span",{staticClass:"line-number"},[n._v("147")]),a("br"),a("span",{staticClass:"line-number"},[n._v("148")]),a("br"),a("span",{staticClass:"line-number"},[n._v("149")]),a("br"),a("span",{staticClass:"line-number"},[n._v("150")]),a("br"),a("span",{staticClass:"line-number"},[n._v("151")]),a("br"),a("span",{staticClass:"line-number"},[n._v("152")]),a("br"),a("span",{staticClass:"line-number"},[n._v("153")]),a("br"),a("span",{staticClass:"line-number"},[n._v("154")]),a("br"),a("span",{staticClass:"line-number"},[n._v("155")]),a("br"),a("span",{staticClass:"line-number"},[n._v("156")]),a("br"),a("span",{staticClass:"line-number"},[n._v("157")]),a("br"),a("span",{staticClass:"line-number"},[n._v("158")]),a("br"),a("span",{staticClass:"line-number"},[n._v("159")]),a("br"),a("span",{staticClass:"line-number"},[n._v("160")]),a("br"),a("span",{staticClass:"line-number"},[n._v("161")]),a("br"),a("span",{staticClass:"line-number"},[n._v("162")]),a("br"),a("span",{staticClass:"line-number"},[n._v("163")]),a("br"),a("span",{staticClass:"line-number"},[n._v("164")]),a("br"),a("span",{staticClass:"line-number"},[n._v("165")]),a("br"),a("span",{staticClass:"line-number"},[n._v("166")]),a("br"),a("span",{staticClass:"line-number"},[n._v("167")]),a("br"),a("span",{staticClass:"line-number"},[n._v("168")]),a("br"),a("span",{staticClass:"line-number"},[n._v("169")]),a("br"),a("span",{staticClass:"line-number"},[n._v("170")]),a("br"),a("span",{staticClass:"line-number"},[n._v("171")]),a("br"),a("span",{staticClass:"line-number"},[n._v("172")]),a("br"),a("span",{staticClass:"line-number"},[n._v("173")]),a("br"),a("span",{staticClass:"line-number"},[n._v("174")]),a("br"),a("span",{staticClass:"line-number"},[n._v("175")]),a("br"),a("span",{staticClass:"line-number"},[n._v("176")]),a("br"),a("span",{staticClass:"line-number"},[n._v("177")]),a("br"),a("span",{staticClass:"line-number"},[n._v("178")]),a("br"),a("span",{staticClass:"line-number"},[n._v("179")]),a("br"),a("span",{staticClass:"line-number"},[n._v("180")]),a("br"),a("span",{staticClass:"line-number"},[n._v("181")]),a("br"),a("span",{staticClass:"line-number"},[n._v("182")]),a("br"),a("span",{staticClass:"line-number"},[n._v("183")]),a("br"),a("span",{staticClass:"line-number"},[n._v("184")]),a("br"),a("span",{staticClass:"line-number"},[n._v("185")]),a("br"),a("span",{staticClass:"line-number"},[n._v("186")]),a("br"),a("span",{staticClass:"line-number"},[n._v("187")]),a("br"),a("span",{staticClass:"line-number"},[n._v("188")]),a("br"),a("span",{staticClass:"line-number"},[n._v("189")]),a("br"),a("span",{staticClass:"line-number"},[n._v("190")]),a("br"),a("span",{staticClass:"line-number"},[n._v("191")]),a("br"),a("span",{staticClass:"line-number"},[n._v("192")]),a("br"),a("span",{staticClass:"line-number"},[n._v("193")]),a("br"),a("span",{staticClass:"line-number"},[n._v("194")]),a("br"),a("span",{staticClass:"line-number"},[n._v("195")]),a("br"),a("span",{staticClass:"line-number"},[n._v("196")]),a("br"),a("span",{staticClass:"line-number"},[n._v("197")]),a("br"),a("span",{staticClass:"line-number"},[n._v("198")]),a("br"),a("span",{staticClass:"line-number"},[n._v("199")]),a("br"),a("span",{staticClass:"line-number"},[n._v("200")]),a("br"),a("span",{staticClass:"line-number"},[n._v("201")]),a("br"),a("span",{staticClass:"line-number"},[n._v("202")]),a("br"),a("span",{staticClass:"line-number"},[n._v("203")]),a("br"),a("span",{staticClass:"line-number"},[n._v("204")]),a("br"),a("span",{staticClass:"line-number"},[n._v("205")]),a("br"),a("span",{staticClass:"line-number"},[n._v("206")]),a("br"),a("span",{staticClass:"line-number"},[n._v("207")]),a("br"),a("span",{staticClass:"line-number"},[n._v("208")]),a("br"),a("span",{staticClass:"line-number"},[n._v("209")]),a("br"),a("span",{staticClass:"line-number"},[n._v("210")]),a("br"),a("span",{staticClass:"line-number"},[n._v("211")]),a("br"),a("span",{staticClass:"line-number"},[n._v("212")]),a("br"),a("span",{staticClass:"line-number"},[n._v("213")]),a("br"),a("span",{staticClass:"line-number"},[n._v("214")]),a("br"),a("span",{staticClass:"line-number"},[n._v("215")]),a("br"),a("span",{staticClass:"line-number"},[n._v("216")]),a("br"),a("span",{staticClass:"line-number"},[n._v("217")]),a("br"),a("span",{staticClass:"line-number"},[n._v("218")]),a("br"),a("span",{staticClass:"line-number"},[n._v("219")]),a("br"),a("span",{staticClass:"line-number"},[n._v("220")]),a("br"),a("span",{staticClass:"line-number"},[n._v("221")]),a("br"),a("span",{staticClass:"line-number"},[n._v("222")]),a("br"),a("span",{staticClass:"line-number"},[n._v("223")]),a("br"),a("span",{staticClass:"line-number"},[n._v("224")]),a("br"),a("span",{staticClass:"line-number"},[n._v("225")]),a("br"),a("span",{staticClass:"line-number"},[n._v("226")]),a("br"),a("span",{staticClass:"line-number"},[n._v("227")]),a("br"),a("span",{staticClass:"line-number"},[n._v("228")]),a("br"),a("span",{staticClass:"line-number"},[n._v("229")]),a("br"),a("span",{staticClass:"line-number"},[n._v("230")]),a("br"),a("span",{staticClass:"line-number"},[n._v("231")]),a("br"),a("span",{staticClass:"line-number"},[n._v("232")]),a("br"),a("span",{staticClass:"line-number"},[n._v("233")]),a("br"),a("span",{staticClass:"line-number"},[n._v("234")]),a("br"),a("span",{staticClass:"line-number"},[n._v("235")]),a("br"),a("span",{staticClass:"line-number"},[n._v("236")]),a("br"),a("span",{staticClass:"line-number"},[n._v("237")]),a("br"),a("span",{staticClass:"line-number"},[n._v("238")]),a("br"),a("span",{staticClass:"line-number"},[n._v("239")]),a("br"),a("span",{staticClass:"line-number"},[n._v("240")]),a("br"),a("span",{staticClass:"line-number"},[n._v("241")]),a("br"),a("span",{staticClass:"line-number"},[n._v("242")]),a("br"),a("span",{staticClass:"line-number"},[n._v("243")]),a("br"),a("span",{staticClass:"line-number"},[n._v("244")]),a("br"),a("span",{staticClass:"line-number"},[n._v("245")]),a("br"),a("span",{staticClass:"line-number"},[n._v("246")]),a("br"),a("span",{staticClass:"line-number"},[n._v("247")]),a("br"),a("span",{staticClass:"line-number"},[n._v("248")]),a("br"),a("span",{staticClass:"line-number"},[n._v("249")]),a("br"),a("span",{staticClass:"line-number"},[n._v("250")]),a("br"),a("span",{staticClass:"line-number"},[n._v("251")]),a("br"),a("span",{staticClass:"line-number"},[n._v("252")]),a("br"),a("span",{staticClass:"line-number"},[n._v("253")]),a("br"),a("span",{staticClass:"line-number"},[n._v("254")]),a("br"),a("span",{staticClass:"line-number"},[n._v("255")]),a("br"),a("span",{staticClass:"line-number"},[n._v("256")]),a("br"),a("span",{staticClass:"line-number"},[n._v("257")]),a("br"),a("span",{staticClass:"line-number"},[n._v("258")]),a("br"),a("span",{staticClass:"line-number"},[n._v("259")]),a("br"),a("span",{staticClass:"line-number"},[n._v("260")]),a("br"),a("span",{staticClass:"line-number"},[n._v("261")]),a("br"),a("span",{staticClass:"line-number"},[n._v("262")]),a("br"),a("span",{staticClass:"line-number"},[n._v("263")]),a("br"),a("span",{staticClass:"line-number"},[n._v("264")]),a("br"),a("span",{staticClass:"line-number"},[n._v("265")]),a("br"),a("span",{staticClass:"line-number"},[n._v("266")]),a("br"),a("span",{staticClass:"line-number"},[n._v("267")]),a("br"),a("span",{staticClass:"line-number"},[n._v("268")]),a("br"),a("span",{staticClass:"line-number"},[n._v("269")]),a("br"),a("span",{staticClass:"line-number"},[n._v("270")]),a("br")])]),a("ul",[a("li",[n._v("executor.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: executor.go\n * @Create date: 2021-08-17\n * @Function: 执行scheduler中传递的job任务，将任务的执行结果返回给scheduler 【完毕】\n **/\n\npackage worker\n\nimport (\n\t"go-task/common"\n\t"math/rand"\n\t"os/exec"\n\t"time"\n)\n\nvar G_executor *Executor\n\n// Executor 任务执行器\ntype Executor struct {}\n\n// InitExecutor 初始化执行器\nfunc InitExecutor() (err error) {\n\tG_executor = &Executor{}\n\treturn\n}\n\n// ExecuteJob 执行一个任务   info=={"job":{"name":"job1","command":"ls -l","conExpr":"* * * * *"},"PlanTime":"理论调度时间点","RealTime":"时间调度时间点","CancelCtx":"ctx上下文","CancelFunc":"ctx cancel函数"}}\nfunc (executor *Executor) ExecuteJob(info *common.JobExecuteInfo) {\n\tgo func() {\n\n\t\t// 初始化执行结果\n\t\tresult := &common.JobExecuteResult{\n\t\t\tExecuteInfo: info,\n\t\t\tOutput: make([]byte, 0),\n\t\t}\n\n\t\t// 基于job名称，初始化锁\n\t\tjobLock := G_jobLock.CreateJobLock(info.Job.Name)\n\n\t\t// 记录任务开始时间\n\t\tresult.StartTime = time.Now()\n\n\t\t// 上锁\n\t\t// 随机睡眠(0~1s)\n\t\ttime.Sleep(time.Duration(rand.Intn(1000)) * time.Millisecond)\n\n\t\t// 给jobLock上锁\n\t\terr := jobLock.TryLock()\n\n\t\t// 任务执行完毕后，释放锁\n\t\tdefer jobLock.Unlock()\n\n\t\tif err != nil { // 上锁失败\n\t\t\tresult.Err = err\n\t\t\tresult.EndTime = time.Now()\n\n\t\t} else {\n\n\t\t\t// 上锁成功后，重置任务启动时间\n\t\t\tresult.StartTime = time.Now()\n\n\t\t\t// 执行shell命令\n\t\t\tcmd := exec.CommandContext(info.CancelCtx, "/bin/bash", "-c", info.Job.Command)\n\n\t\t\t// 执行并捕获输出\n\t\t\toutput, err := cmd.CombinedOutput()\n\n\t\t\t// 记录任务结束时间\n\t\t\tresult.EndTime = time.Now()\n\t\t\tresult.Output = output\n\t\t\tresult.Err = err\n\n\t\t}\n\n\t\t// 任务执行完成后，把执行的结果返回给Scheduler，Scheduler会从executingTable中删除掉执行记录，并且如果是没有成功获取到所的结果，在scheduler里面会过滤掉，只会写入获取到锁的执行结果\n\t\tG_scheduler.PushJobResult(result)\n\n\t}()\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br")])]),a("ul",[a("li",[n._v("joblock.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: joblock.go\n * @Create date: 2021-08-17\n * @Function: 主要是基于etcd的key过期机制，给JobLock创建锁，解锁的过程  [完毕]\n **/\n\npackage worker\n\nimport (\n\t"context"\n\t"errors"\n\t"go-task/common"\n\tclientv3 "go.etcd.io/etcd/client/v3"\n\t"log"\n)\n\n\nvar G_jobLock *JobLock\n\n// JobLock 定义锁的结构\ntype JobLock struct {\n\t// etcd客户端\n\tkv      clientv3.KV // kv对象\n\tlease   clientv3.Lease // 租约对象\n\tjobName string // 任务名\n\n\tcancelFunc context.CancelFunc // 用于终止自动续租\n\tleaseId    clientv3.LeaseID   // 租约ID\n\tisLocked   bool               // 是否上锁成功\n}\n\n// InitJobLock 初始化一把锁\nfunc InitJobLock(jobName string, kv clientv3.KV, lease clientv3.Lease) (jobLock *JobLock) {\n\tjobLock = &JobLock{\n\t\tkv:      kv,\n\t\tlease:   lease,\n\t\tjobName: jobName,\n\t}\n\tG_jobLock = jobLock\n\treturn\n}\n\n// CreateJobLock 在executor中被调用，初始化一把锁\nfunc (j *JobLock) CreateJobLock(jobName string) (jobLock *JobLock) {\n\tjobLock = InitJobLock(jobName, j.kv, j.lease)\n\treturn\n}\n\n// RemoveLease 取消租约，让/cron/lock/目录下的key失效(相当于删除吧), 此函数为TryLock服务\nfunc RemoveLease(cancelFunc context.CancelFunc, jobLock *JobLock, leaseId clientv3.LeaseID) error {\n\tcancelFunc()                                  // 取消自动续租\n\t_, err := jobLock.lease.Revoke(context.TODO(), leaseId) //  释放租约\n\treturn err\n}\n\n// TryLock 尝试给任务上锁，上锁的标准是可以在/cron/lock/目录下创建key\nfunc (j *JobLock) TryLock() (err error) {\n\n\t// 创建租约(5秒)\n\tleaseGrantResp, err := j.lease.Grant(context.TODO(), 5)\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 创建上下文\n\tcancelCtx, cancelFunc := context.WithCancel(context.TODO())\n\n\t// 租约ID\n\tleaseId := leaseGrantResp.ID\n\n\t// 自动续租\n\tkeepRespChan, err := j.lease.KeepAlive(cancelCtx, leaseId)\n\tif err != nil {\n\t\t// 释放租约\n\t\terrLease := RemoveLease(cancelFunc, j, leaseId)\n\t\tif errLease != nil {\n\t\t\tlog.Printf(err.Error())\n\t\t}\n\t}\n\n\t// 处理续租应答的协程, 没有什么用，主要是起到一个提醒作用\n\tgo func() {\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase keepResp := <-keepRespChan: // 自动续租的应答\n\t\t\t\tif keepResp == nil {\n\t\t\t\t\tlog.Printf("租约被取消")\n\t\t\t\t\tgoto END\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\tEND:\n\t}()\n\n\t// 创建事务txn\n\ttxn := j.kv.Txn(context.TODO())\n\n\t// 锁路径\n\tlockKey := common.JOB_LOCK_DIR + j.jobName\n\n\t// 5, 事务抢锁\n\ttxn.If(clientv3.Compare(clientv3.CreateRevision(lockKey), "=", 0)).\n\t\tThen(clientv3.OpPut(lockKey, "", clientv3.WithLease(leaseId))).\n\t\tElse(clientv3.OpGet(lockKey))\n\n\t// 提交事务\n\ttxnResp, err := txn.Commit()\n\tif err != nil {\n\t\terrLease := RemoveLease(cancelFunc, j, leaseId)\n\t\tif errLease != nil {\n\t\t\tlog.Printf(errLease.Error())\n\t\t}\n\t}\n\n\t// 成功返回, 失败释放租约\n\tif !txnResp.Succeeded { // 锁被占用\n\t\terr = errors.New("锁已被占用")\n\t\terrLease := RemoveLease(cancelFunc, j, leaseId) // 取消租约\n\t\tif errLease != nil {\n\t\t\tlog.Printf(errLease.Error())\n\t\t}\n\t}\n\n\t// 抢锁成功，说明可以写入key\n\tj.leaseId = leaseId\n\tj.cancelFunc = cancelFunc\n\tj.isLocked = true\n\treturn\n\n}\n\n// Unlock 释放锁\nfunc (j *JobLock) Unlock() {\n\tif j.isLocked {\n\t\terrLease := RemoveLease(j.cancelFunc, j, j.leaseId)\n\t\tif errLease != nil {\n\t\t\tlog.Printf(errLease.Error())\n\t\t}\n\t}\n}\n\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br"),a("span",{staticClass:"line-number"},[n._v("134")]),a("br"),a("span",{staticClass:"line-number"},[n._v("135")]),a("br"),a("span",{staticClass:"line-number"},[n._v("136")]),a("br"),a("span",{staticClass:"line-number"},[n._v("137")]),a("br"),a("span",{staticClass:"line-number"},[n._v("138")]),a("br"),a("span",{staticClass:"line-number"},[n._v("139")]),a("br"),a("span",{staticClass:"line-number"},[n._v("140")]),a("br"),a("span",{staticClass:"line-number"},[n._v("141")]),a("br"),a("span",{staticClass:"line-number"},[n._v("142")]),a("br")])]),a("ul",[a("li",[n._v("jobsink.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: jobsink.go\n * @Create date: 2021-08-17\n * @Function: 程序启动的时候，会自动从logChan队列中获取log结构体对象，写入到MongoDB中， scheduler会调用Append方法，将log(结构体对象)写入到logChan队列中， autoCommitChan作用没有搞清楚？\n **/\n\npackage worker\n\nimport (\n\t"context"\n\t"go-task/common"\n\t"go.mongodb.org/mongo-driver/mongo"\n\t"go.mongodb.org/mongo-driver/mongo/options"\n\t"time"\n)\n\nvar G_logSink *LogSink\n\n// LogBatch\ntype LogBatch struct {\n\tLogs []interface{}\n}\n\n// LogSink 将任务执行日志写入到MongoDB\ntype LogSink struct {\n\tclient         *mongo.Client\n\tlogCollection  *mongo.Collection\n\tlogChan        chan *common.JobLog\n\tautoCommitChan chan *LogBatch // 日志批量自动提交\n}\n\n// saveLogs 批量写入log日志到MongoDB中，此方法为writeLoop服务\nfunc (l *LogSink) saveLogs(batch *LogBatch) {\n\tl.logCollection.InsertMany(context.TODO(), batch.Logs)\n}\n\n// writeLoop 将日志写入到MongoDB协程\nfunc (l *LogSink) writeLoop() {\n\n\tvar (\n\t\tlogBatch    *LogBatch\n\t\tcommitTimer *time.Timer\n\t)\n\n\t// 不断的从logchan队列里面获取日志\n\tfor {\n\t\tselect {\n\n\t\tcase log := <- l.logChan:\n\n\t\t\t// 过期的匹日志，写入到MongoDB后，会设置logBatch为nil\n\t\t\tif logBatch == nil {\n\n\t\t\t\tlogBatch = &LogBatch{}\n\n\t\t\t\t// 让这个批次超时自动提交(给1秒的时间）\n\t\t\t\t// 这是一个闭包，内部函数innerFunc获取外部函数timeoutFunc的自由变量batch, 这个timeoutFunc就是innerFunc\n\t\t\t\ttimeoutFunc := func(logBatch *LogBatch) func() {\n\n\t\t\t\t\tinnerFunc := func() {\n\t\t\t\t\t\t// 将匹日志添加到匹日志的channel\n\t\t\t\t\t\tl.autoCommitChan <- logBatch\n\t\t\t\t\t}\n\t\t\t\t\treturn innerFunc\n\n\t\t\t\t}(logBatch)\n\n\t\t\t\t// 创建定时器的目的是，避免在日志少的时候，日志数量很长时间才会达到100条，使得用户虽然发送了命令，但是无法获取到执行结果，因此创建一个定时器\n\t\t\t\t// 创建一个1秒执行一次的定时器, AfterFunc接收一个函数对象\n\t\t\t\tcommitTimer = time.AfterFunc(time.Duration(G_config.JobLogCommitTimeout)*time.Millisecond, timeoutFunc)\n\t\t\t}\n\n\t\t\t// 将新的日志加入到批处理日志中，\n\t\t\tlogBatch.Logs = append(logBatch.Logs, log)\n\n\t\t\t// 如果批日志满了, 就立即写入到MongoDB中，配置文件中定义100条就满了\n\t\t\tif len(logBatch.Logs) >= G_config.JobLogBatchSize {\n\t\t\t\t// 写入MongoDB\n\t\t\t\tl.saveLogs(logBatch)\n\t\t\t\t// 清空logBatch\n\t\t\t\tlogBatch = nil\n\t\t\t\t// 取消定时器\n\t\t\t\tcommitTimer.Stop()\n\t\t\t}\n\n\t\t// 这里是获取过期的批量日志\n\t\tcase timeoutBatch := <- l.autoCommitChan:\n\t\t\t// 这个有一个关键的时间点，就是当logBatch的日志条数为100条的时候，那么写入MongoDB，但是此时再停止定时器，可能已经来不及了，可能这个批次已经提交到了autoCommitChan，如果这个匹日志正好是满足100条写入的匹日志，那么直接continue\n\t\t\tif timeoutBatch != logBatch {\n\t\t\t\tcontinue // 跳过已经写入到MongoDB的日志\n\t\t\t}\n\t\t\t// 如果是过期的，不管是不是满了，都写入到MongoDB\n\t\t\tl.saveLogs(timeoutBatch)\n\t\t\t// 清空logBatch\n\t\t\tlogBatch = nil\n\t\t}\n\t}\n}\n\n// InitLogSink 初始化日志写入MongoDB\nfunc InitLogSink() (err error) {\n\n\t// 建立mongodb连接\n\tclientOptions := options.Client().ApplyURI(G_config.MongodbUri).SetConnectTimeout(time.Duration(G_config.MongodbConnectTimeout) * time.Millisecond)\n\tclient, err := mongo.Connect(context.TODO(), clientOptions)\n\tif err != nil {\n\t\treturn\n\t}\n\n\t// 选择db和collection\n\tG_logSink = &LogSink{\n\t\tclient:        client,\n\t\tlogCollection: client.Database("cron").Collection("log"),\n\t\t// logChan: 日志通道，\n\t\tlogChan: make(chan *common.JobLog, 1000),\n\t\t// autoCommitChan 自动提交的通道，这是干嘛的\n\t\tautoCommitChan: make(chan *LogBatch, 1000),\n\t}\n\n\t// 启动一个mongodb处理协程\n\tgo G_logSink.writeLoop()\n\n\treturn\n\n}\n\n// Append 在scheduler中被调用，将执行日志写入到channel中\nfunc (l *LogSink) Append(jobLog *common.JobLog) {\n\tselect {\n\t// 如果队列满了，没关系因为都是在协程中\n\tcase l.logChan <- jobLog:\n\t//default:\n\t//\t// 如果执行结果数据量特别大，也无所谓，\n\t//\tfmt.Println("队列满了就丢弃")\n\t}\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br"),a("span",{staticClass:"line-number"},[n._v("134")]),a("br"),a("span",{staticClass:"line-number"},[n._v("135")]),a("br"),a("span",{staticClass:"line-number"},[n._v("136")]),a("br"),a("span",{staticClass:"line-number"},[n._v("137")]),a("br")])]),a("ul",[a("li",[n._v("register.go")])]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('/**\n * @Author: Robby\n * @File name: register.go\n * @Create date: 2021-08-17\n * @Function: 当有worker启动的时候，先将自己的IP写到etcd的/cron/workers/目录下，例如 /cron/workers/192.168.100.111，并且这个key是自动续租的 【完毕】\n **/\n\npackage worker\n\nimport (\n\t"context"\n\t"go-task/common"\n\tclientv3 "go.etcd.io/etcd/client/v3"\n\t"log"\n\t"net"\n\t"time"\n)\n\nvar G_register *Register\n\n// Register 注册节点到etcd： /cron/workers/IP地址\ntype Register struct {\n\tclient *clientv3.Client\n\tkv clientv3.KV\n\tlease clientv3.Lease\n\tlocalIP string // 本机IP\n}\n\n// 获取本机网卡IP\nfunc getLocalIP() (ipv4 string, err error) {\n\n\t// 获取所有网卡\n\taddrs, err := net.InterfaceAddrs()\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t\treturn\n\t}\n\n\t// 取第一个非lo的网卡IP\n\tfor _, addr := range addrs {\n\t\t// 这个网络地址是IP地址: ipv4, ipv6\n\t\tipNet, isIpNet := addr.(*net.IPNet)\n\n\t\tif isIpNet && !ipNet.IP.IsLoopback() {\n\t\t\t// 跳过IPV6\n\t\t\tif ipNet.IP.To4() != nil {\n\t\t\t\tipv4 = ipNet.IP.String()\t// 192.168.1.1\n\t\t\t\treturn\n\t\t\t}\n\t\t}\n\t}\n\n\terr = common.ERR_NO_LOCAL_IP_FOUND\n\treturn\n}\n\n// InitRegister 初始化worker注册\nfunc InitRegister() (err error) {\n\n\n\t// 初始化配置\n\tconfig := clientv3.Config{\n\t\tEndpoints: G_config.EtcdEndpoints, // 集群地址\n\t\tDialTimeout: time.Duration(G_config.EtcdDialTimeout) * time.Millisecond, // 连接超时\n\t}\n\n\t// 建立连接\n\tclient, err := clientv3.New(config)\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t\treturn\n\t}\n\n\t// 本机IP\n\tlocalIp, err := getLocalIP()\n\tif err != nil {\n\t\tlog.Panicf(err.Error())\n\t\treturn\n\t}\n\n\t// 得到KV和Lease的API子集\n\tkv := clientv3.NewKV(client)\n\tlease := clientv3.NewLease(client)\n\n\tG_register = &Register{\n\t\tclient: client,\n\t\tkv: kv,\n\t\tlease: lease,\n\t\tlocalIP: localIp,\n\t}\n\n\t// 服务注册\n\tgo G_register.keepOnline()\n\n\treturn\n}\n\n// CancelContext 调用context的cancel函数\nfunc CancelContext(cancelFunc context.CancelFunc)  {\n\ttime.Sleep(1 * time.Second)\n\tif cancelFunc != nil {\n\t\tcancelFunc()\n\t}\n}\n\n// 注册到/cron/workers/IP, 并自动续租\nfunc (r *Register) keepOnline() {\n\n\tvar cancelFunc context.CancelFunc\n\n\tfor {\n\n\t\t// 获取etcd的注册路径\n\t\tregKey := common.JOB_WORKER_DIR + r.localIP\n\n\t\t// 创建租约\n\t\tleaseGrantResp, err := r.lease.Grant(context.TODO(), 10)\n\t\tif err != nil {\n\t\t\tCancelContext(cancelFunc) // 取消自动续租\n\t\t}\n\n\t\t// 自动续租\n\t\tkeepAliveChan, err := r.lease.KeepAlive(context.TODO(), leaseGrantResp.ID)\n\t\tif err != nil {\n\t\t\tCancelContext(cancelFunc) // 取消自动续租\n\t\t}\n\n\t\tcancelCtx, cancelFunc := context.WithCancel(context.TODO())\n\n\t\t// 注册到etcd\n\t\t_, err = r.kv.Put(cancelCtx, regKey, "", clientv3.WithLease(leaseGrantResp.ID))\n\t\tif err != nil {\n\t\t\tCancelContext(cancelFunc)\n\t\t}\n\n\t\t// 处理续租应答, 如果续租应答为nil，那么同样取消自动续租\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase keepAliveResp := <- keepAliveChan:\n\t\t\t\tif keepAliveResp == nil {\t// 续租失败\n\t\t\t\t\tCancelContext(cancelFunc)  // 取消自动续租\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t}\n\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br"),a("span",{staticClass:"line-number"},[n._v("86")]),a("br"),a("span",{staticClass:"line-number"},[n._v("87")]),a("br"),a("span",{staticClass:"line-number"},[n._v("88")]),a("br"),a("span",{staticClass:"line-number"},[n._v("89")]),a("br"),a("span",{staticClass:"line-number"},[n._v("90")]),a("br"),a("span",{staticClass:"line-number"},[n._v("91")]),a("br"),a("span",{staticClass:"line-number"},[n._v("92")]),a("br"),a("span",{staticClass:"line-number"},[n._v("93")]),a("br"),a("span",{staticClass:"line-number"},[n._v("94")]),a("br"),a("span",{staticClass:"line-number"},[n._v("95")]),a("br"),a("span",{staticClass:"line-number"},[n._v("96")]),a("br"),a("span",{staticClass:"line-number"},[n._v("97")]),a("br"),a("span",{staticClass:"line-number"},[n._v("98")]),a("br"),a("span",{staticClass:"line-number"},[n._v("99")]),a("br"),a("span",{staticClass:"line-number"},[n._v("100")]),a("br"),a("span",{staticClass:"line-number"},[n._v("101")]),a("br"),a("span",{staticClass:"line-number"},[n._v("102")]),a("br"),a("span",{staticClass:"line-number"},[n._v("103")]),a("br"),a("span",{staticClass:"line-number"},[n._v("104")]),a("br"),a("span",{staticClass:"line-number"},[n._v("105")]),a("br"),a("span",{staticClass:"line-number"},[n._v("106")]),a("br"),a("span",{staticClass:"line-number"},[n._v("107")]),a("br"),a("span",{staticClass:"line-number"},[n._v("108")]),a("br"),a("span",{staticClass:"line-number"},[n._v("109")]),a("br"),a("span",{staticClass:"line-number"},[n._v("110")]),a("br"),a("span",{staticClass:"line-number"},[n._v("111")]),a("br"),a("span",{staticClass:"line-number"},[n._v("112")]),a("br"),a("span",{staticClass:"line-number"},[n._v("113")]),a("br"),a("span",{staticClass:"line-number"},[n._v("114")]),a("br"),a("span",{staticClass:"line-number"},[n._v("115")]),a("br"),a("span",{staticClass:"line-number"},[n._v("116")]),a("br"),a("span",{staticClass:"line-number"},[n._v("117")]),a("br"),a("span",{staticClass:"line-number"},[n._v("118")]),a("br"),a("span",{staticClass:"line-number"},[n._v("119")]),a("br"),a("span",{staticClass:"line-number"},[n._v("120")]),a("br"),a("span",{staticClass:"line-number"},[n._v("121")]),a("br"),a("span",{staticClass:"line-number"},[n._v("122")]),a("br"),a("span",{staticClass:"line-number"},[n._v("123")]),a("br"),a("span",{staticClass:"line-number"},[n._v("124")]),a("br"),a("span",{staticClass:"line-number"},[n._v("125")]),a("br"),a("span",{staticClass:"line-number"},[n._v("126")]),a("br"),a("span",{staticClass:"line-number"},[n._v("127")]),a("br"),a("span",{staticClass:"line-number"},[n._v("128")]),a("br"),a("span",{staticClass:"line-number"},[n._v("129")]),a("br"),a("span",{staticClass:"line-number"},[n._v("130")]),a("br"),a("span",{staticClass:"line-number"},[n._v("131")]),a("br"),a("span",{staticClass:"line-number"},[n._v("132")]),a("br"),a("span",{staticClass:"line-number"},[n._v("133")]),a("br"),a("span",{staticClass:"line-number"},[n._v("134")]),a("br"),a("span",{staticClass:"line-number"},[n._v("135")]),a("br"),a("span",{staticClass:"line-number"},[n._v("136")]),a("br"),a("span",{staticClass:"line-number"},[n._v("137")]),a("br"),a("span",{staticClass:"line-number"},[n._v("138")]),a("br"),a("span",{staticClass:"line-number"},[n._v("139")]),a("br"),a("span",{staticClass:"line-number"},[n._v("140")]),a("br"),a("span",{staticClass:"line-number"},[n._v("141")]),a("br"),a("span",{staticClass:"line-number"},[n._v("142")]),a("br"),a("span",{staticClass:"line-number"},[n._v("143")]),a("br"),a("span",{staticClass:"line-number"},[n._v("144")]),a("br"),a("span",{staticClass:"line-number"},[n._v("145")]),a("br"),a("span",{staticClass:"line-number"},[n._v("146")]),a("br"),a("span",{staticClass:"line-number"},[n._v("147")]),a("br"),a("span",{staticClass:"line-number"},[n._v("148")]),a("br")])])])}),[],!1,null,null,null);s.default=e.exports},778:function(n,s,t){n.exports=t.p+"assets/img/2021-23-23sdfasfd.e86226c3.jpg"},779:function(n,s,t){n.exports=t.p+"assets/img/worker.306b6fa6.jpg"}}]);