(window.webpackJsonp=window.webpackJsonp||[]).push([[273],{2394:function(s,n,a){"use strict";a.r(n);var t=a(9),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/72887901",target:"_blank",rel:"noopener noreferrer"}},[s._v("AsyncIO源码分析"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"一-asyncio基础"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-asyncio基础"}},[s._v("#")]),s._v(" 一：asyncio基础")]),s._v(" "),t("h3",{attrs:{id:"一-基本概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-基本概念"}},[s._v("#")]),s._v(" (一)：基本概念")]),s._v(" "),t("ul",[t("li",[s._v("asyncio是异步I/O编程的一套解决方案，具备的功能如下")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：包含各种特定系统实现的模块化事件循环\n\n2：传输和协议抽象\n\n3：对TPC/UDP/SSL/子进程/延时调用的支持\n\n4：模仿futures模块，使用事件循环机制处理Future类\n\n5：基于yield from的协议和任务，可以让用户顺序式编写异步并发代码\n\n6：当线程中产生阻塞IO调用时，可以将这个事件转移到线程池中\n\n7：模仿threading模块中的同步原语，可以用在单线程的协程之间\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("ul",[t("li",[s._v("asyncio编程基本模型："),t("code",[s._v("get_html()函数")]),s._v("是一个I/O阻塞操作，内部通过await关键字修饰阻塞调用，并且它是一个单一协程，直接可以注册到loop中，"),t("code",[s._v("loop.run_until_complete()函数")]),s._v("完成协注册。"),t("code",[s._v("asyncio.get_event_loop()")]),s._v("获取了一个事件循环，底层启动无限循环从select中获取I/O事件，当有事件触发时，调用回调函数，让协程工作起来。"),t("code",[s._v("注意：这里的await asyncio.sleep(2)不能改为await request.get(url)，因为requests库是同步请求")]),s._v("。"),t("a",{attrs:{href:"https://www.520pf.cn/article/180.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考代码"),t("OutboundLink")],1)])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\n\nasync def get_html(url):\n    print("start get url")\n    # 这个IO阻塞处，必须await，不能使用time.sleep(2)\n    await asyncio.sleep(2)\n    print("end get url")\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # 注册协程到loop中\n    loop.run_until_complete(get_html("https://www.yhyblog.cn"))\n    print(time.time()-start_time)\n\n// 输出结果\nstart get url\nend get url\n2.0035550594329834\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("ul",[t("li",[s._v("如果有多个I/O请求的操作，可以将多个阻塞I/O的协程对象，放在asyncio.wait()中迭代协程对象，通过loop.run_until_complete()将协程对象注册到loop对象中来")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\n\n\nasync def get_html(url):\n    print("start get url")\n    # 这个IO阻塞处，必须await，不能使用time.sleep(2)\n    await asyncio.sleep(2)\n    print("end get url")\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # 创建协程对象列表\n    tasks = [get_html("https://www.yhyblog.cn") for i in range(10)]\n    # 启动协程池，迭代协程对象，依次执行\n    loop.run_until_complete(asyncio.wait(tasks))\n    print(time.time() - start_time)\n\n// 输出结果\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nstart get url\nend get url\nend get url\nend get url\nend get url\nend get url\nend get url\nend get url\nend get url\nend get url\nend get url\n2.003995895385742\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br")])]),t("ul",[t("li",[s._v("如果将异步等待"),t("code",[s._v("await asyncio.sleep(2)")]),s._v("改为了"),t("code",[s._v("time.sleep(2)")]),s._v("，那么整个代码将会顺序执行。"),t("code",[s._v("await asyncio.sleep(2)会返回一个实现了__await__方法的future对象")]),s._v("，此时future对象会立即返回")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("async def get_html(url):\n    // ...\n    # 这个IO阻塞处，必须await，不能使用time.sleep(2)\n    # await asyncio.sleep(2)\n    time.sleep(2)\n    // ...\n\n\n// 输出结果：\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\nstart get url\nend get url\n20.036029815673828\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h3",{attrs:{id:"二-获取协程对象的返回值"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-获取协程对象的返回值"}},[s._v("#")]),s._v(" (二)：获取协程对象的返回值")]),s._v(" "),t("ul",[t("li",[s._v("获取协程对象的返回结果与多线程获取返回结果api类似，代码如下："),t("code",[s._v("可以通过asyncio.ensure_future()方法，先获取协程返回的future对象，然后从future对象中获取到返回值")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\n\n\nasync def get_html(url):\n    print("start get url")\n    await asyncio.sleep(2)\n    return "200"\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # ensure_future方法可以获取协程对象的返回值，其实是一个future对象\n    future = asyncio.ensure_future(get_html("https://www.yhyblog.cn"))\n    loop.run_until_complete(future)\n    print(time.time() - start_time)\n    print(future.result())\n\n// 输出结果\nstart get url\n2.0019078254699707\n200\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("ul",[t("li",[s._v("也可以通过loop.create_task创建一个task类型对象，将协程放在loop中，从task对象中回去协程的返回值")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\n\n\nasync def get_html(url):\n    print("start get url")\n    await asyncio.sleep(2)\n    return "200"\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # ensure_future方法可以获取协程对象的返回值\n    task = loop.create_task(get_html("https://www.yhyblog.cn"))\n    loop.run_until_complete(task)\n    print(time.time() - start_time)\n    print(task.result())\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("ul",[t("li",[s._v("如果callback还是需要接收一个参数，那么可以使用partial偏函数，将callback函数装饰一下，"),t("code",[s._v("注意：callback函数最后一个参数才是task对象")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\nfrom functools import partial\n\nasync def get_html(url):\n    print("start get url")\n    await asyncio.sleep(2)\n    return "200"\n\ndef callback(arg, task):\n    print("task={}".format(task))\n    print("arg={}".format(arg))\n    print("执行了callback函数")\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # ensure_future方法可以获取协程对象的返回值\n    task = loop.create_task(get_html("https://www.yhyblog.cn"))\n    # 添加一个callback回调函数\n    task.add_done_callback(partial(callback, \'id=1\'))\n    loop.run_until_complete(task)\n    print(time.time() - start_time)\n    print(task.result())\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("h3",{attrs:{id:"三-asyncio-wait和asyncio-gather使用区别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-asyncio-wait和asyncio-gather使用区别"}},[s._v("#")]),s._v(" (三)：asyncio.wait和asyncio.gather使用区别")]),s._v(" "),t("ul",[t("li",[t("p",[t("strong",[s._v("asyncio.wait是一个协程函数")]),s._v("，"),t("code",[s._v("等待所有协程执行完毕")]),s._v("。"),t("strong",[s._v("多线程的wait函数是一个生成器")]),s._v("，"),t("code",[s._v("等待所有的线程执行完毕")])])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("asyncio.gather用法")])])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n    # 创建协程对象列表\n    tasks = [get_html("https://www.yhyblog.cn") for i in range(10)]\n    # asyncio.gather接收一个指针\n    loop.run_until_complete(asyncio.gather(*tasks))\n    print(time.time() - start_time)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("asyncio.gather()是asyncio.wait()的进一步封装")]),s._v("，"),t("code",[s._v("asyncio.gather()可以对协程列表进行分组")]),s._v("。"),t("strong",[s._v("因此在开发过程中可以优先使用asyncio.gather()等待协程列表的执行")]),s._v("，相关代码如下：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport time\n\n\nasync def get_html(url):\n    print("start get url")\n    await asyncio.sleep(2)\n    print("end get url")\n\n\nif __name__ == \'__main__\':\n    start_time = time.time()\n    # 启动事件循环\n    loop = asyncio.get_event_loop()\n\n    # 协程对象列表进行分组\n    tasks1 = [get_html("https://www.yhyblog.cn") for i in range(10)]\n    tasks2 = [get_html("https://www.baidu.com") for i in range(10)]\n    group1 = asyncio.gather(*tasks1)\n    group2 = asyncio.gather(*tasks2)\n\n    # 启动协程池，迭代协程对象，依次执行\n    loop.run_until_complete(asyncio.gather(group1, group2))\n\n    print(time.time() - start_time)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("h2",{attrs:{id:"二-asyncio的task取消和子协程调用原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-asyncio的task取消和子协程调用原理"}},[s._v("#")]),s._v(" 二：asyncio的task取消和子协程调用原理")]),s._v(" "),t("h3",{attrs:{id:"一-asyncio中task的取消原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-asyncio中task的取消原理"}},[s._v("#")]),s._v(" (一)：asyncio中task的取消原理")]),s._v(" "),t("ul",[t("li",[s._v("loop实例启动事件循环会调用两个函数，"),t("code",[s._v("run_forever()")]),s._v("或者"),t("code",[s._v("run_util_complete()")]),s._v("，它们的区别如下")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1：run_util_complete()事件循环会停止，当所有的协程都执行完毕了，事件循环停止运行。因为其内部当future执行完毕，会调用一个_run_until_complete_cb方法，在这个回调方法里面，会执行loop.stop()，停止事件循环\n\n2：run_forever()事件循环不会停止，即使所有的协程都执行完毕了，asyncio的事件循环依然会继续运行\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[s._v("由于loop可以从future对象或者task对象中获取，当future执行完毕后，就可以获取loop实例，停止事件循环。"),t("code",[s._v("或者当某个future执行失败的时候，可以调用loop.stop()停止其他协程继续工作")]),s._v("。下面代码中：演示了当执行代码时候，ctr+c，捕获到KeyboardInterrupt异常，然后基于"),t("code",[s._v("asyncio.Task.all_tasks()")]),s._v("获取到所有的task，调用"),t("code",[s._v("task.cancel()")]),s._v("终止所有的task，再重启loop（"),t("code",[s._v("注意")]),s._v("："),t("strong",[s._v("下面代码只能在Python3.6版本执行，如果是python3.7+版本，会抛出异常，因为asyncio.Task.all_tasks()被弃用了，无法获取到task")]),s._v("）")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\n\nasync def get_html(sleep_time):\n    print("waiting")\n    await asyncio.sleep(sleep_time)\n    print("done after {}s".format(sleep_time))\n\n\nif __name__ == \'__main__\':\n    task1 = get_html(3)\n    task2 = get_html(2)\n    task3 = get_html(1)\n\n    tasks = [task1, task2, task3]\n\n    # 创建task组，这里必须传递指针\n    task_group = asyncio.gather(*tasks)\n\n    # 获取事件循环实例\n    loop = asyncio.get_event_loop()\n\n    # 运行事件循环，模拟一种异常机制，捕获到异常后，获取所有task取消\n    try:\n        loop.run_until_complete(asyncio.gather(task_group))\n\n    except KeyboardInterrupt as e:\n        # 获取所有的tasks任务。内部通过events.get_event_loop()获取loop对象，然后基于loop对象获取到所有的tasks\n        all_tasks = asyncio.Task.all_tasks()\n        # all_tasks = asyncio.all_tasks()\n        for task in all_tasks:\n            is_ok = task.cancel()\n            if is_ok:\n                print("task取消成功")\n        loop.stop() # 停止loop\n        loop.run_forever() # 再次重新启动\n    finally:\n        loop.close() # 关闭事件循环\n\n// 输出结果\nwaiting\nwaiting\nwaiting\n^C\ntask取消成功\ntask取消成功\ntask取消成功\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br")])]),t("h3",{attrs:{id:"二-asyncio中子协程调用原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-asyncio中子协程调用原理"}},[s._v("#")]),s._v(" (二)：asyncio中子协程调用原理")]),s._v(" "),t("p",[t("img",{attrs:{src:a(969),alt:"Alt text"}})]),s._v(" "),t("ul",[t("li",[s._v("上图是下面代码的运行过程：loop.run_until_complete()函数将print_sum(1, 2)协程注册到loop中后，会执行print_sum()协程，执行到"),t("code",[s._v("await compute(x, y)")]),s._v("时，print_sum()会pending，执行子协程compute(x,y)，执行到"),t("code",[s._v("await asyncio.sleep(1.0)")]),s._v("时，compute(x,y)pending，"),t("strong",[s._v("此时程序返回到Task调用方")]),s._v("，"),t("code",[s._v("如果此时调用方还有协程需要执行，那么就会继续执行，程序不会等待")]),s._v("。compute(x, y)协程等待1秒后，调用方直接驱动"),t("code",[s._v("return x + y")]),s._v("，此时compute(x,y)协程执行完毕，并且抛出StopIteration异常。异常会被await compute(x, y)捕获到，并且获取返回值，赋值给result，再打印"),t("code",[s._v('print("%s + %s = %s" % (x, y, result))')]),s._v("，此时print_sum(x, y)协程执行完毕，"),t("strong",[s._v("程序继续会到调用方Task")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\n\nasync def compute(x, y):\n    print("Compute %s + %s ..." % (x, y))\n    await asyncio.sleep(1.0)\n    return x + y\n\nasync def print_sum(x, y):\n    result = await compute(x, y)\n    print("%s + %s = %s" % (x, y, result))\n\nloop = asyncio.get_event_loop()\nloop.run_until_complete(print_sum(1, 2))\nloop.close()\n\n// 输出结果：\nCompute 1 + 2 ...\n1 + 2 = 3\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("ul",[t("li",[t("strong",[s._v("以上代码和协程通信图解释了协程之间协作式调用的工作原理")]),s._v("，"),t("code",[s._v("图中的Task可以认为是协程的调用方，在代码中无法体现出来的")])])]),s._v(" "),t("h2",{attrs:{id:"三-asyncio的常用方法和类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-asyncio的常用方法和类"}},[s._v("#")]),s._v(" 三：asyncio的常用方法和类")]),s._v(" "),t("h3",{attrs:{id:"一-call-soon、call-at、call-later方法使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-call-soon、call-at、call-later方法使用"}},[s._v("#")]),s._v(" (一)：call_soon、call_at、call_later方法使用")]),s._v(" "),t("ul",[t("li",[s._v("loop.call_soon()方法，可以将一个函数立即放在loop中执行")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import asyncio\n\ndef callback(sleep_time):\n    print(\"sleep {} success\".format(sleep_time))\n\ndef stoploop(loop):\n    loop.stop()\n\nif __name__ == '__main__':\n    loop = asyncio.get_event_loop()\n    \n    // 下面两个\n    loop.call_soon(callback, 3)\n    loop.call_soon(stoploop, loop)\n    \n\t// 事件循环的启动不能少，否则无法执行函数\n    loop.run_forever()\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("ul",[t("li",[s._v("loop.call_later()方法，可以让一个函数延时调用")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import asyncio\n\ndef callback(sleep_time):\n    print(\"sleep {} success\".format(sleep_time))\n\ndef stoploop(loop):\n    loop.stop()\n\nif __name__ == '__main__':\n    loop = asyncio.get_event_loop()\n    loop.call_later(2, callback, 2) // 延时2秒调用\n    loop.call_later(5, callback, 5)\n    loop.call_later(3, callback, 3)\n\n    # loop.call_soon(stoploop, loop)\n    loop.run_forever()\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("ul",[t("li",[s._v("loop.call_at()方法，可以让一个函数在某个时刻调用")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import asyncio\n\ndef callback(sleep_time):\n    print(\"sleep {} success\".format(sleep_time))\n\nif __name__ == '__main__':\n    loop = asyncio.get_event_loop()\n    now = loop.time()\n    \n    loop.call_later(now + 2, callback, 2)\n    loop.call_later(now + 5, callback, 5)\n    loop.call_later(now + 3, callback, 3)\n\n    loop.run_forever()\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h3",{attrs:{id:"二-asyncio在线程池中的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-asyncio在线程池中的使用"}},[s._v("#")]),s._v(" (二)： asyncio在线程池中的使用")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("一般阻塞代码不要写在协程代码中，但是如果有一些任务是I/O阻塞的，就可以放在线程池中执行")])]),s._v(" "),t("li",[t("p",[s._v("下面代码中：将get_url()这个阻塞I/O函数，放在线程中执行，每个线程封装为asyncio的Task任务，然后将任务注册到loop事件循环中")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nfrom concurrent.futures import ThreadPoolExecutor\nimport socket\nfrom urllib.parse import urlparse\n\ndef get_url(url):\n    #通过socket请求html\n    url = urlparse(url)\n    host = url.netloc\n    path = url.path\n    if path == "":\n        path = "/"\n\n    #建立socket连接\n    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n    # client.setblocking(False)\n    client.connect((host, 80)) #阻塞不会消耗cpu\n\n    client.send("GET {} HTTP/1.1\\r\\nHost:{}\\r\\nConnection:close\\r\\n\\r\\n".format(path, host).encode("utf8"))\n\n    data = b""\n    while True:\n        d = client.recv(1024)\n        if d:\n            data += d\n        else:\n            break\n\n    data = data.decode("utf8")\n    html_data = data.split("\\r\\n\\r\\n")[1]\n    print(html_data)\n    client.close()\n\n\nif __name__ == "__main__":\n    import time\n    start_time = time.time()\n    loop = asyncio.get_event_loop()\n\n    # 创建线程池\n    executor = ThreadPoolExecutor(3)\n\n    # 创建多线程任务列表\n    tasks = []\n    for url in range(20):\n        url = "https://www.yhyblog.cn"\n        # 让任务在线程中执行，get_url是一个阻塞函数\n        task = loop.run_in_executor(executor, get_url, url)\n        # 将线程任务添加到任务列表\n        tasks.append(task)\n\n    # 迭代组成协程任务\n    loop.run_until_complete(asyncio.wait(tasks))\n    print("last time:{}".format(time.time()-start_time))\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br")])]),t("h3",{attrs:{id:"三-asyncio模拟http请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三-asyncio模拟http请求"}},[s._v("#")]),s._v(" (三)： asyncio模拟HTTP请求")]),s._v(" "),t("ul",[t("li",[s._v("由于asyncio中没有提供HTTP请求的方法，也不能在函数中封装requests同步请求库，那么只能TCP模拟HTTP请求。下面代码中："),t("strong",[s._v("通过封装协程的HTTP请求为一个future对象，再添加到tasks列表中，遍历tasks列表，获取已经执行完毕的协程，通过await关键字获取协程的返回结果，最后打印出来")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import asyncio\nimport socket\nfrom urllib.parse import urlparse\n\n# 这里类似于一个协程的requests请求\nasync def get_url(url):\n    #通过socket请求html\n    url = urlparse(url)\n    host = url.netloc\n    path = url.path\n    if path == "":\n        path = "/"\n\n    #建立socket连接，异步操作\n    reader, writer = await asyncio.open_connection(host,80)\n    writer.write("GET {} HTTP/1.1\\r\\nHost:{}\\r\\nConnection:close\\r\\n\\r\\n".format(path, host).encode("utf8"))\n    all_lines = []\n    async for raw_line in reader:\n        data = raw_line.decode("utf8")\n        all_lines.append(data)\n    html = "\\n".join(all_lines)\n    return html\n\nasync def main():\n    # 创建future列表，目的是获取协程的返回值，如果没有返回值，创建协程列表就好了\n    tasks = []\n    for url in range(20):\n        url = "https://www.yhyblog.cn"\n        # tasks元素是future对象\n        tasks.append(asyncio.ensure_future(get_url(url)))\n\n    # asyncio.as_completed方法，类似于多线程的completed方法，可以获取到当前已经执行完毕的future对象的结果\n    for task in asyncio.as_completed(tasks):\n        # 这里的task是一个协程，不是future对象了，通过await获取协程的返回值\n        result = await task\n        print(result)\n\nif __name__ == "__main__":\n    import time\n    start_time = time.time()\n    loop = asyncio.get_event_loop()\n\n    # 这里直接注册了一个函数，这是一个协程函数，所以可以直接组成到loop中\n    loop.run_until_complete(main())\n    print(\'last time:{}\'.format(time.time()-start_time))\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br")])]),t("h3",{attrs:{id:"四-asyncio中future和task对象的区别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四-asyncio中future和task对象的区别"}},[s._v("#")]),s._v(" (四)：asyncio中Future和Task对象的区别")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Future是"),t("code",[s._v("协程的结果容器，可以从Future中获取到协程的返回值")])])]),s._v(" "),t("li",[t("p",[s._v("Task是Future的子类，Task是协程和Future通信的桥梁，"),t("code",[s._v("在Task对象中需要激活协程，如果协程执行完毕，会捕获到协程的StopIteration异常，将结果存储在Future中。那么基于Task就完成了协程与Future的通信")])])])]),s._v(" "),t("h3",{attrs:{id:"五-asyncio中使用lock互斥锁和queue的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五-asyncio中使用lock互斥锁和queue的使用"}},[s._v("#")]),s._v(" (五)：asyncio中使用lock互斥锁和queue的使用")]),s._v(" "),t("ul",[t("li",[s._v("asyncio.Lock是协程锁，因此在加锁的时候，需要使用"),t("code",[s._v("async with语法")]),s._v("，或者"),t("code",[s._v("使用with await语法")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("import asyncio\nimport aiohttp\nfrom asyncio import Lock, Queue\n\nlock = Lock()\n\ncache = {}\n\nasync def get_stuff(url):\n    async with lock: # 这里加一把锁，避免发送两次请求\n        if url in cache:\n            return cache[url]\n        stuff = await aiohttp.request('GET', url)\n        cache[url] = stuff\n        return stuff\n\nasync def parse_stuff():\n    stuff = await get_stuff(\"https://www.yhyblog.cn\")\n\nasync def use_stuff():\n    stuff = await get_stuff(\"https://www.yhyblog.cn\")\n\nif __name__ == '__main__':\n    tasks = [parse_stuff(), use_stuff()]\n\n    loop = asyncio.get_event_loop()\n    loop.run_until_complete(asyncio.wait(tasks))\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("ul",[t("li",[s._v("asyncio的queue的使用也类似，也需要await")])])])}),[],!1,null,null,null);n.default=e.exports},969:function(s,n,a){s.exports=a.p+"assets/img/2022-01-12.30.11.e32691c9.png"}}]);